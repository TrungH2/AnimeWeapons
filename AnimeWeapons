local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local HttpService = game:GetService("HttpService")
local LocalPlayer = Players.LocalPlayer

-- Ki·ªÉm tra xem c√≥ trong game kh√¥ng
if not LocalPlayer then
    warn("‚ùå Kh√¥ng t√¨m th·∫•y LocalPlayer!")
    return
end

-- ===================================================================
-- I. CONFIGURATION
-- ===================================================================

local Config = {
    StealthMode = true,
    AttackRange = 50,
    CollectRange = 20,
    FarmInterval = 0.1,
    TeleportCooldown = 2,
    Zones = {
        ["Shinobi Village"] = "Naruto",
        ["Namek Planet"] = "DragonBall", 
        ["Desert Land"] = "OnePiece",
        ["Demon Land"] = "DemonSlayer",
        ["Dungeon Easy"] = "Dungeon:1",
        ["Zone 1"] = "Zone 1",
        ["Zone 2"] = "Zone 2",
        ["Zone 3"] = "Zone 3",
        ["Zone 4"] = "Zone 4",
    },
    StatTypes = {"Damage", "Mastery", "Luck", "Yen"},
    GachaTypes = {"Biju", "Race", "Sayajin", "Haki", "Fruits"},
}

-- ===================================================================
-- II. STATE VARIABLES
-- ===================================================================

local stealthMode = Config.StealthMode
local safeConnections = {}
local activeLoops = {}
local selectedEnemyNames = {}
local selectedGachaType = Config.GachaTypes[1]
local selectedStat = Config.StatTypes[1]
local selectedZone = "Zone 1"
local lastTeleportTime = 0
local antiAFKConnection = nil

-- Bi·∫øn tr·∫°ng th√°i
local selectedFarmEnabled = false
local autoAttackEnabled = false
local farmRandomEnabled = false
local autoCollectEnabled = false
local stealthModeEnabled = Config.StealthMode
local antiAFKEnabled = true
local autoOpenEggEnabled = false

-- Bi·∫øn Dungeon
local isDungeonActive = false
local lastZone = selectedZone

-- ===================================================================
-- III. CORE UTILITIES
-- ===================================================================

local function GetReplyRemote()
    for _, name in pairs({"Reply", "ReplicatedStorage", "MainRemote"}) do
        local remote = ReplicatedStorage:FindFirstChild(name)
        if remote then
            local reliable = remote:FindFirstChild("Reliable")
            if reliable then return reliable end
            return remote
        end
    end
    return nil
end

local function GetAttackRemote()
    for _, name in pairs({"RemoteEvent", "AttackRemote", "CombatRemote", "Remote"}) do
        local remote = ReplicatedStorage:FindFirstChild(name)
        if remote and (remote:IsA("RemoteEvent") or remote:IsA("RemoteFunction")) then
            return remote
        end
    end
    return nil
end

local function SafeFire(remote, ...)
    if remote and (remote:IsA("RemoteEvent") or remote:IsA("RemoteFunction")) then
        if stealthMode then wait(0.1) end
        pcall(function()
            remote:FireServer(...)
        end)
    end
end

local function SafeWait()
    if not stealthMode then wait() return end
    wait(math.random(20, 50) / 100)
end

local function SafeCall(func, ...)
    local success, result = pcall(func, ...)
    if not success then 
        warn("SafeCall Error:", result)
        return nil
    end
    return result
end

local function SafeConnect(signal, callback)
    local conn = signal:Connect(function(...)
        SafeCall(callback, ...)
    end)
    table.insert(safeConnections, conn)
    return conn
end

local function StartLoop(name, func, interval)
    if activeLoops[name] then 
        activeLoops[name] = false 
        wait(0.1) 
    end
    activeLoops[name] = true
    coroutine.wrap(function()
        while activeLoops[name] do
            local success = SafeCall(func)
            if not success then
                warn("Loop "..name.." encountered an error")
            end
            if interval then 
                wait(interval) 
            else 
                RunService.Heartbeat:Wait() 
            end
        end
    end)()
end

local function StopLoop(name)
    if activeLoops[name] then 
        activeLoops[name] = false 
    end
end

-- ===================================================================
-- IV. GAME LOGIC
-- ===================================================================

local function ValidatePlayerState()
    local character = LocalPlayer.Character
    if not character then return false end
    local humanoid = character:FindFirstChild("Humanoid")
    return humanoid and humanoid.Health > 0
end

local function EnableAntiAFK()
    local VirtualUser = game:GetService("VirtualUser")
    if not VirtualUser then return end
    
    if antiAFKConnection then 
        antiAFKConnection:Disconnect() 
    end

    antiAFKConnection = LocalPlayer.Idled:Connect(function()
        SafeCall(function()
            VirtualUser:CaptureController()
            VirtualUser:ClickButton2(Vector2.new())
        end)
    end)
end

local function DisableAntiAFK()
    if antiAFKConnection then
        antiAFKConnection:Disconnect()
        antiAFKConnection = nil
    end
end

local function FindEnemiesInRange(range)
    local enemies = {}
    local character = LocalPlayer.Character
    if not character then return enemies end

    local root = character:FindFirstChild("HumanoidRootPart")
    if not root then return enemies end

    local playerPos = root.Position

    for _, obj in pairs(workspace:GetDescendants()) do
        if obj:IsA("Model") and obj:FindFirstChild("Humanoid") and obj:FindFirstChild("Head") then
            local isPlayer = false
            for _, player in pairs(Players:GetPlayers()) do
                if player.Character == obj then 
                    isPlayer = true 
                    break 
                end
            end
            if not isPlayer and obj.Humanoid.Health > 0 then
                local head = obj.Head
                local distance = (playerPos - head.Position).Magnitude
                if distance <= (range or Config.AttackRange) then
                    table.insert(enemies, {
                        Model = obj,
                        Name = obj.Name,
                        Position = head.Position,
                        Distance = distance
                    })
                end
            end
        end
    end

    table.sort(enemies, function(a, b) return a.Distance < b.Distance end)
    return enemies
end

local function GetEnemyGroups()
    local enemies = FindEnemiesInRange(200)
    local groups = {}

    for _, enemy in ipairs(enemies) do
        if not groups[enemy.Name] then
            groups[enemy.Name] = {
                name = enemy.Name,
                count = 0
            }
        end
        groups[enemy.Name].count = groups[enemy.Name].count + 1
    end

    return groups
end

local function FarmSelectedLogic()
    if not ValidatePlayerState() or #selectedEnemyNames == 0 then return end
    if isDungeonActive then return end

    local character = LocalPlayer.Character
    local root = character and character:FindFirstChild("HumanoidRootPart")
    if not root then return end

    local enemies = FindEnemiesInRange(200)
    local targets = {}
    local remote = GetAttackRemote()
    if not remote then return end

    -- T√¨m t·∫•t c·∫£ enemy tr√πng v·ªõi t√™n ƒë√£ ch·ªçn
    for _, enemy in ipairs(enemies) do
        for _, selectedName in ipairs(selectedEnemyNames) do
            if enemy.Name == selectedName then
                table.insert(targets, enemy)
                break
            end
        end
    end

    -- S·∫Øp x·∫øp theo kho·∫£ng c√°ch
    table.sort(targets, function(a, b) return a.Distance < b.Distance end)

    -- Teleport v√† t·∫•n c√¥ng t·ª´ng con
    for _, target in ipairs(targets) do
        if not activeLoops["FarmSelected"] then break end

        if target.Model and target.Model.Parent and target.Model:FindFirstChild("Humanoid") and target.Model.Humanoid.Health > 0 then
            -- Teleport ƒë·∫øn enemy
            local offset = Vector3.new(math.random(-5, 5), 3, math.random(-5, 5))
            root.CFrame = CFrame.new(target.Position + offset)

            -- T·∫•n c√¥ng
            SafeFire(remote, "Attack", target.Model)
            wait(0.1)
        end
    end
end

local function AutoAttackLogic()
    if not ValidatePlayerState() then return end
    if isDungeonActive then return end
    
    local enemies = FindEnemiesInRange(Config.AttackRange)
    if #enemies > 0 then
        local nearestEnemy = enemies[1]
        local character = LocalPlayer.Character
        if character and character:FindFirstChild("HumanoidRootPart") then
            character.HumanoidRootPart.CFrame = CFrame.new(nearestEnemy.Position + Vector3.new(0, 3, 0))
            local remote = GetAttackRemote()
            if remote then 
                SafeFire(remote, "Attack", nearestEnemy.Model) 
            end
        end
    end
end

local function FarmRandomLogic()
    if not ValidatePlayerState() then return end
    if isDungeonActive then return end
    
    local enemies = FindEnemiesInRange(Config.AttackRange)
    if #enemies > 0 then
        local randomEnemy = enemies[math.random(1, #enemies)]
        local character = LocalPlayer.Character
        if character and character:FindFirstChild("HumanoidRootPart") then
            character.HumanoidRootPart.CFrame = CFrame.new(randomEnemy.Position + Vector3.new(0, 3, 0))
            local remote = GetAttackRemote()
            if remote then 
                SafeFire(remote, "Attack", randomEnemy.Model) 
            end
        end
    end
end

local function AutoCollectLogic()
    if not ValidatePlayerState() then return end
    if isDungeonActive then return end
    
    local character = LocalPlayer.Character
    local root = character and character:FindFirstChild("HumanoidRootPart")
    local remote = GetAttackRemote()
    if not root or not remote then return end

    for _, obj in pairs(workspace:GetDescendants()) do
        if obj:IsA("Part") and (obj.Name:lower():find("drop") or obj.Name:lower():find("coin") or obj.Name:lower():find("reward")) then
            local distance = (root.Position - obj.Position).Magnitude
            if distance < Config.CollectRange then
                SafeFire(remote, "Collect", obj)
            end
        end
    end
end

local function AutoRebirthLogic()
    if not ValidatePlayerState() then return end
    local remote = GetReplyRemote()
    if remote then 
        SafeFire(remote, "RankUp") 
    end
end

local function AutoOpenEggLogic()
    if not ValidatePlayerState() then return end
    local remote = GetReplyRemote()
    if remote then 
        SafeFire(remote, "Open Star", {[1] = "Egg"}) 
    end
end

local function StartGacha(gachaType)
    local remote = GetReplyRemote()
    if remote then
        SafeFire(remote, "Crate Roll Start", {[1] = gachaType, [2] = true})
        wait(1)
        SafeFire(remote, "Crate Roll Stop")
    end
end

local function DistributeStat(statName)
    local remote = GetReplyRemote()
    if remote then 
        SafeFire(remote, "Distribute Stat Point", {[1] = statName}) 
    end
end

local function TeleportToZone(zoneKey)
    local zoneName = Config.Zones[zoneKey]
    if not zoneName then return end
    local remote = GetReplyRemote()
    if remote then 
        SafeFire(remote, "Zone Teleport", {[1] = zoneName}) 
    end
end

local function SafeTeleportToZone(zoneKey)
    if tick() - lastTeleportTime < Config.TeleportCooldown then return end
    TeleportToZone(zoneKey)
    lastTeleportTime = tick()
end

-- ===================================================================
-- V. DUNGEON FUNCTIONS
-- ===================================================================

local function AutoJoinDungeonEasyLogic()
    lastZone = selectedZone 
    local remote = GetReplyRemote()
    if remote then
        SafeFire(remote, "Join Gamemode", {[1] = "Dungeon:1"})
        print("üó∫Ô∏è ƒê√£ g·ª≠i y√™u c·∫ßu tham gia Dungeon Easy!")
    end
end

local function AutoFarmDungeonLogic()
    local character = LocalPlayer.Character
    if not character or not character:FindFirstChild("HumanoidRootPart") then 
        return 
    end

    local enemies = FindEnemiesInRange(200)
    if #enemies > 0 then
        local nearestEnemy = enemies[1]
        character.HumanoidRootPart.CFrame = CFrame.new(nearestEnemy.Position + Vector3.new(0, 5, 0))
        
        local remote = GetAttackRemote()
        if remote then 
            SafeFire(remote, "Attack", nearestEnemy.Model) 
        end
    end
end

-- ===================================================================
-- VI. SIMPLE UI
-- ===================================================================

-- T·∫°o GUI ƒë∆°n gi·∫£n ƒë·ªÉ test
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "HimonoHubSimple"
ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
ScreenGui.Parent = game.CoreGui

local MainFrame = Instance.new("Frame")
MainFrame.Size = UDim2.new(0, 400, 0, 500)
MainFrame.Position = UDim2.new(0.5, -200, 0.5, -250)
MainFrame.BackgroundColor3 = Color3.fromRGB(40, 40, 50)
MainFrame.Parent = ScreenGui

local UICorner = Instance.new("UICorner")
UICorner.CornerRadius = UDim.new(0, 8)
UICorner.Parent = MainFrame

local Title = Instance.new("TextLabel")
Title.Size = UDim2.new(1, 0, 0, 40)
Title.BackgroundColor3 = Color3.fromRGB(30, 30, 40)
Title.Text = "üî∑ HIMONO HUB - SIMPLE TEST"
Title.TextColor3 = Color3.fromRGB(255, 255, 255)
Title.Font = Enum.Font.GothamBold
Title.TextSize = 18
Title.Parent = MainFrame

local ScrollFrame = Instance.new("ScrollingFrame")
ScrollFrame.Size = UDim2.new(1, -20, 1, -60)
ScrollFrame.Position = UDim2.new(0, 10, 0, 50)
ScrollFrame.BackgroundTransparency = 1
ScrollFrame.ScrollBarThickness = 5
ScrollFrame.Parent = MainFrame

local UIListLayout = Instance.new("UIListLayout")
UIListLayout.Padding = UDim.new(0, 10)
UIListLayout.Parent = ScrollFrame

-- T·∫°o c√°c n√∫t ch·ª©c nƒÉng c∆° b·∫£n
local function CreateSimpleButton(text, callback)
    local button = Instance.new("TextButton")
    button.Size = UDim2.new(1, 0, 0, 40)
    button.BackgroundColor3 = Color3.fromRGB(0, 100, 200)
    button.Text = text
    button.TextColor3 = Color3.fromRGB(255, 255, 255)
    button.Font = Enum.Font.GothamBold
    button.TextSize = 14
    button.Parent = ScrollFrame
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 6)
    corner.Parent = button
    
    button.MouseButton1Click:Connect(function()
        SafeCall(callback)
    end)
    
    return button
end

local function CreateSimpleToggle(text, default, callback)
    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(1, 0, 0, 40)
    frame.BackgroundTransparency = 1
    frame.Parent = ScrollFrame
    
    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(0.7, 0, 1, 0)
    label.BackgroundTransparency = 1
    label.Text = text
    label.TextColor3 = Color3.fromRGB(255, 255, 255)
    label.Font = Enum.Font.Gotham
    label.TextSize = 14
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.Parent = frame
    
    local button = Instance.new("TextButton")
    button.Size = UDim2.new(0, 60, 0, 30)
    button.Position = UDim2.new(0.7, 10, 0.5, -15)
    button.BackgroundColor3 = default and Color3.fromRGB(0, 200, 0) or Color3.fromRGB(200, 0, 0)
    button.Text = default and "ON" or "OFF"
    button.TextColor3 = Color3.fromRGB(255, 255, 255)
    button.Font = Enum.Font.GothamBold
    button.TextSize = 12
    button.Parent = frame
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 6)
    corner.Parent = button
    
    local isOn = default
    
    button.MouseButton1Click:Connect(function()
        isOn = not isOn
        button.Text = isOn and "ON" or "OFF"
        button.BackgroundColor3 = isOn and Color3.fromRGB(0, 200, 0) or Color3.fromRGB(200, 0, 0)
        SafeCall(callback, isOn)
    end)
    
    return frame
end

-- T·∫°o c√°c n√∫t ƒëi·ªÅu khi·ªÉn
CreateSimpleToggle("Auto Attack", false, function(enabled)
    autoAttackEnabled = enabled
    if enabled then 
        StartLoop("AutoAttack", AutoAttackLogic, 0.3) 
        print("‚úÖ B·∫≠t Auto Attack")
    else 
        StopLoop("AutoAttack")
        print("‚ùå T·∫Øt Auto Attack")
    end
end)

CreateSimpleToggle("Farm Selected", false, function(enabled)
    selectedFarmEnabled = enabled
    if enabled then 
        StartLoop("FarmSelected", FarmSelectedLogic, 0.5) 
        print("‚úÖ B·∫≠t Farm Selected")
    else 
        StopLoop("FarmSelected")
        print("‚ùå T·∫Øt Farm Selected")
    end
end)

CreateSimpleToggle("Farm Random", false, function(enabled)
    farmRandomEnabled = enabled
    if enabled then 
        StartLoop("FarmRandom", FarmRandomLogic, 0.5) 
        print("‚úÖ B·∫≠t Farm Random")
    else 
        StopLoop("FarmRandom")
        print("‚ùå T·∫Øt Farm Random")
    end
end)

CreateSimpleToggle("Auto Collect", false, function(enabled)
    autoCollectEnabled = enabled
    if enabled then 
        StartLoop("AutoCollect", AutoCollectLogic, 1.0) 
        print("‚úÖ B·∫≠t Auto Collect")
    else 
        StopLoop("AutoCollect")
        print("‚ùå T·∫Øt Auto Collect")
    end
end)

-- N√∫t ch·ªçn enemy
CreateSimpleButton("Select Enemy: Kisame", function()
    if not table.find(selectedEnemyNames, "Kisame") then
        table.insert(selectedEnemyNames, "Kisame")
        print("‚úÖ ƒê√£ ch·ªçn enemy: Kisame")
    end
end)

CreateSimpleButton("Select Enemy: Tanroleta6", function()
    if not table.find(selectedEnemyNames, "Tanroleta6") then
        table.insert(selectedEnemyNames, "Tanroleta6")
        print("‚úÖ ƒê√£ ch·ªçn enemy: Tanroleta6")
    end
end)

CreateSimpleButton("Clear Selected Enemies", function()
    selectedEnemyNames = {}
    print("üóëÔ∏è ƒê√£ x√≥a t·∫•t c·∫£ enemy ƒë√£ ch·ªçn")
end)

-- N√∫t Dungeon
CreateSimpleToggle("Auto Join Dungeon", false, function(enabled)
    if enabled then 
        isDungeonActive = true
        StartLoop("AutoJoinDungeon", AutoJoinDungeonEasyLogic, 15) 
        print("‚úÖ B·∫≠t Auto Join Dungeon")
    else 
        StopLoop("AutoJoinDungeon")
        isDungeonActive = false
        print("‚ùå T·∫Øt Auto Join Dungeon")
    end
end)

CreateSimpleToggle("Auto Farm Dungeon", false, function(enabled)
    if enabled then 
        isDungeonActive = true
        StartLoop("AutoFarmDungeon", AutoFarmDungeonLogic, 0.4) 
        print("‚úÖ B·∫≠t Auto Farm Dungeon")
    else 
        StopLoop("AutoFarmDungeon")
        isDungeonActive = false
        print("‚ùå T·∫Øt Auto Farm Dungeon")
    end
end)

-- N√∫t Teleport
CreateSimpleButton("Teleport to Zone 1", function()
    SafeTeleportToZone("Zone 1")
    print("üöÄ Teleport to Zone 1")
end)

CreateSimpleButton("Teleport to Zone 2", function()
    SafeTeleportToZone("Zone 2")
    print("üöÄ Teleport to Zone 2")
end)

-- N√∫t kh√°c
CreateSimpleButton("Auto Rebirth", function()
    AutoRebirthLogic()
    print("‚ö° Auto Rebirth")
end)

CreateSimpleButton("Open Egg", function()
    AutoOpenEggLogic()
    print("ü•ö Open Egg")
end)

-- C·∫≠p nh·∫≠t k√≠ch th∆∞·ªõc scroll
coroutine.wrap(function()
    while true do
        wait(1)
        ScrollFrame.CanvasSize = UDim2.new(0, 0, 0, UIListLayout.AbsoluteContentSize.Y + 20)
    end
end)()

-- B·∫≠t Anti-AFK
EnableAntiAFK()

print("üî∑ HIMONO HUB - SIMPLE VERSION LOADED!")
print("üìù H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng:")
print("1. Ch·ªçn enemy b·∫±ng n√∫t 'Select Enemy'")
print("2. B·∫≠t 'Farm Selected' ƒë·ªÉ farm enemy ƒë√£ ch·ªçn")
print("3. B·∫≠t 'Auto Attack' ƒë·ªÉ farm enemy g·∫ßn nh·∫•t")
print("4. B·∫≠t 'Farm Random' ƒë·ªÉ farm ng·∫´u nhi√™n")
print("5. S·ª≠ d·ª•ng n√∫t Teleport ƒë·ªÉ di chuy·ªÉn")
