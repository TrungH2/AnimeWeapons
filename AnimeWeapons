-- Himono Hub v4.2 - SULFUR EDITION (ADVANCED OPTIMIZED & SECURE)

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local LocalPlayer = Players.LocalPlayer

local stealthMode = true
local safeConnections = {}
local activeLoops = {}
local selectedEnemyNames = {}
local selectedGachaType = "Biju"
local selectedZone = "Zone 1"
local selectedStat = "Attack"
local autoOpenEggEnabled = false

-- Cache cho remote events
local cachedRemotes = {}
local lastCacheTime = 0
local CACHE_DURATION = 5

-- Cache cho enemy list (Gi·∫£m GetDescendants g·ªçi)
local enemyCache = {}
local lastEnemyCacheTime = 0
local ENEMY_CACHE_DURATION = 1

-- Cache cho items/drops
local dropsCache = {}
local lastDropsCacheTime = 0
local DROPS_CACHE_DURATION = 2

-- Improved delay system v·ªõi ng·∫´u nhi√™n t·ªët h∆°n
local function GenerateRandomDelay(minMs, maxMs)
    local min = math.floor(minMs)
    local max = math.floor(maxMs)
    return (math.random(min, max) + math.random()) / 1000
end

local function SafeFire(remote, ...)
    if not remote then return end
    if stealthMode then 
        local delay = GenerateRandomDelay(80, 350)
        task.wait(delay)
    end
    remote:FireServer(...)
end

local function SafeWait()
    if not stealthMode then task.wait(0.1); return end
    local delay = GenerateRandomDelay(40, 180)
    task.wait(delay)
end

local function SafeCall(func, ...)
    local success, result = pcall(func, ...)
    if not success then
        warn("‚ö†Ô∏è Error in SafeCall: " .. tostring(result))
    end
    return success and result or nil
end

local function SafeConnect(signal, callback)
    if not signal then return nil end
    local conn = signal:Connect(function(...)
        if stealthMode then SafeWait() end
        SafeCall(callback, ...)
    end)
    table.insert(safeConnections, conn)
    return conn
end

local function StartLoop(name, func, interval)
    if activeLoops[name] then activeLoops[name] = false; task.wait(0.1) end
    activeLoops[name] = true
    task.spawn(function()
        while activeLoops[name] do
            pcall(func)
            if interval then task.wait(interval) else RunService.Heartbeat:Wait() end
        end
    end)
end

local function StopLoop(name)
    if activeLoops[name] then activeLoops[name] = false end
end

-- OPTIMIZED: Cache remote events
local function GetRemote(path)
    local currentTime = tick()
    if currentTime - lastCacheTime > CACHE_DURATION then
        cachedRemotes = {}
        lastCacheTime = currentTime
    end
    
    if cachedRemotes[path] then return cachedRemotes[path] end
    
    local remote = nil
    
    if path == "Attack" then
        remote = ReplicatedStorage:FindFirstChild("RemoteEvent") or ReplicatedStorage:FindFirstChild("Remote")
    elseif path == "Gacha" then
        local reply = ReplicatedStorage:FindFirstChild("Reply")
        if reply then remote = reply:FindFirstChild("Reliable") end
    end
    
    if remote then cachedRemotes[path] = remote end
    return remote
end

local antiAFKConnection
local function EnableAntiAFK()
    if antiAFKConnection then antiAFKConnection:Disconnect() end
    antiAFKConnection = LocalPlayer.Idled:Connect(function()
        SafeCall(function()
            VirtualUser:CaptureController()
            VirtualUser:ClickButton2(Vector2.new())
        end)
    end)
end

-- OPTIMIZED: Enemy detection with better caching
local function FindEnemiesInRange(range)
    local character = LocalPlayer.Character
    if not character or not character:FindFirstChild("HumanoidRootPart") then return {} end
    
    local currentTime = tick()
    if currentTime - lastEnemyCacheTime > ENEMY_CACHE_DURATION then
        enemyCache = {}
        local playerPos = character.HumanoidRootPart.Position
        
        local enemyFolder = workspace:FindFirstChild("Enemies") or workspace:FindFirstChild("NPCs") or workspace
        local descendants = enemyFolder:GetDescendants()
        
        for _, obj in ipairs(descendants) do
            if obj:IsA("Model") and obj:FindFirstChild("Humanoid") and obj:FindFirstChild("Head") then
                local isPlayer = false
                for _, player in ipairs(Players:GetPlayers()) do
                    if player.Character == obj then isPlayer = true; break end
                end
                
                if not isPlayer and obj.Humanoid.Health > 0 then
                    local distance = (playerPos - obj.Head.Position).Magnitude
                    if distance <= (range or 100) then
                        table.insert(enemyCache, {
                            Model = obj,
                            Name = obj.Name,
                            Position = obj.Head.Position,
                            Distance = distance,
                            Health = obj.Humanoid.Health,
                            MaxHealth = obj.Humanoid.MaxHealth
                        })
                    end
                end
            end
        end
        
        table.sort(enemyCache, function(a, b) return a.Distance < b.Distance end)
        lastEnemyCacheTime = currentTime
    end
    
    return enemyCache
end

-- OPTIMIZED: Items/Drops detection with cache
local function FindDropsInRange(range)
    local character = LocalPlayer.Character
    if not character or not character:FindFirstChild("HumanoidRootPart") then return {} end
    
    local currentTime = tick()
    if currentTime - lastDropsCacheTime > DROPS_CACHE_DURATION then
        dropsCache = {}
        local playerPos = character.HumanoidRootPart.Position
        
        -- Improved: Ch·ªâ qu√©t trong khu v·ª±c g·∫ßn (spatial optimization)
        for _, obj in pairs(workspace:GetDescendants()) do
            if obj:IsA("Part") or obj:IsA("Model") then
                local isValid = false
                if obj:IsA("Part") then
                    isValid = obj.Name:lower():find("drop") or obj.Name:lower():find("coin") or obj.Name:lower():find("reward")
                elseif obj:IsA("Model") then
                    isValid = obj.Name:lower():find("drop") or obj.Name:lower():find("coin") or obj.Name:lower():find("reward")
                end
                
                if isValid then
                    local distance = (playerPos - obj.Position).Magnitude
                    if distance <= (range or 50) then
                        table.insert(dropsCache, {
                            Object = obj,
                            Name = obj.Name,
                            Position = obj.Position,
                            Distance = distance
                        })
                    end
                end
            end
        end
        
        table.sort(dropsCache, function(a, b) return a.Distance < b.Distance end)
        lastDropsCacheTime = currentTime
    end
    
    return dropsCache
end

local function RefreshEnemiesList()
    return FindEnemiesInRange(100)
end

-- Auto farm logic
local function AutoAttackLogic()
    local enemies = FindEnemiesInRange(50)
    if #enemies > 0 then
        local nearestEnemy = enemies[1]
        local character = LocalPlayer.Character
        if character and character:FindFirstChild("HumanoidRootPart") then
            character.HumanoidRootPart.CFrame = CFrame.new(nearestEnemy.Position + Vector3.new(0,2,0))
            local remote = GetRemote("Attack")
            if remote then SafeFire(remote, "Attack", nearestEnemy.Model) end
        end
    end
end

local function FarmSelectedLogic()
    if #selectedEnemyNames == 0 then return end
    
    local character = LocalPlayer.Character
    if not character or not character:FindFirstChild("HumanoidRootPart") then return end
    
    local enemies = FindEnemiesInRange(100)
    local targetEnemy = nil
    local nearestDistance = math.huge
    
    for _, enemy in ipairs(enemies) do
        for _, selectedName in ipairs(selectedEnemyNames) do
            if enemy.Name == selectedName and enemy.Distance < nearestDistance then
                nearestDistance = enemy.Distance
                targetEnemy = enemy
            end
        end
    end
    
    if targetEnemy then
        character.HumanoidRootPart.CFrame = CFrame.new(targetEnemy.Position + Vector3.new(0,2,0))
        local remote = GetRemote("Attack")
        if remote then SafeFire(remote, "Attack", targetEnemy.Model) end
    end
end

local function FarmRandomLogic()
    local enemies = FindEnemiesInRange(50)
    if #enemies > 0 then
        local randomEnemy = enemies[math.random(1, #enemies)]
        local character = LocalPlayer.Character
        if character and character:FindFirstChild("HumanoidRootPart") then
            character.HumanoidRootPart.CFrame = CFrame.new(randomEnemy.Position + Vector3.new(0,2,0))
            local remote = GetRemote("Attack")
            if remote then SafeFire(remote, "Attack", randomEnemy.Model) end
        end
    end
end

-- OPTIMIZED: AutoCollectLogic with caching
local function AutoCollectLogic()
    local character = LocalPlayer.Character
    if not character or not character:FindFirstChild("HumanoidRootPart") then return end
    
    local drops = FindDropsInRange(30)
    
    for _, drop in ipairs(drops) do
        if drop.Distance < 20 then
            local remote = GetRemote("Attack")
            if remote then SafeFire(remote, "Collect", drop.Object) end
        end
    end
end

local function StartGacha(gachaType)
    local remote = GetRemote("Gacha")
    if remote then
        SafeFire(remote, "Crate Roll Start", {[1]=gachaType,[2]=true})
        task.wait(1)
        SafeFire(remote, "Crate Roll Stop")
    end
end

local function TeleportToZone(zoneName)
    local remote = GetRemote("Gacha")
    if remote then
        SafeFire(remote, "Zone Teleport", {[1]=zoneName})
    end
end

local function DistributeStat(statName)
    local remote = GetRemote("Gacha")
    if remote then
        SafeFire(remote, "Distribute Stat Point", {[1]=statName})
    end
end

local function AutoOpenEggLogic()
    local remote = GetRemote("Gacha")
    if remote then
        SafeFire(remote, "Open Star", {[1]="Egg"})
    end
end

-- UI SETUP
local HimonoHub = Instance.new("ScreenGui")
HimonoHub.Name = "HimonoHubSulfur"
HimonoHub.ResetOnSpawn = false
HimonoHub.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
HimonoHub.Parent = game.CoreGui

local MainContainer = Instance.new("Frame")
MainContainer.Size = UDim2.new(0, 600, 0, 500)
MainContainer.Position = UDim2.new(0.5, -300, 0.5, -250)
MainContainer.BackgroundColor3 = Color3.fromRGB(220, 255, 40)
MainContainer.BorderSizePixel = 0
MainContainer.Parent = HimonoHub

local ContainerCorner = Instance.new("UICorner")
ContainerCorner.CornerRadius = UDim.new(0, 12)
ContainerCorner.Parent = MainContainer

local TitleBar = Instance.new("Frame")
TitleBar.Size = UDim2.new(1, 0, 0, 45)
TitleBar.BackgroundColor3 = Color3.fromRGB(180, 220, 40)
TitleBar.Parent = MainContainer

local TitleCorner = Instance.new("UICorner")
TitleCorner.CornerRadius = UDim.new(0, 12)
TitleCorner.Parent = TitleBar

local Title = Instance.new("TextLabel")
Title.Size = UDim2.new(1, -100, 1, 0)
Title.BackgroundTransparency = 1
Title.Text = "üü° HIMONO HUB v4.2 - ADVANCED OPTIMIZED"
Title.TextColor3 = Color3.fromRGB(40, 40, 20)
Title.Font = Enum.Font.GothamBold
Title.TextSize = 18
Title.Parent = TitleBar

local StealthIndicator = Instance.new("Frame")
StealthIndicator.Size = UDim2.new(0, 12, 0, 12)
StealthIndicator.Position = UDim2.new(1, -90, 0.5, -6)
StealthIndicator.BackgroundColor3 = Color3.fromRGB(0, 255, 0)
StealthIndicator.Parent = TitleBar

local StealthCorner = Instance.new("UICorner")
StealthCorner.CornerRadius = UDim.new(1, 0)
StealthCorner.Parent = StealthIndicator

local StealthLabel = Instance.new("TextLabel")
StealthLabel.Size = UDim2.new(0, 80, 1, 0)
StealthLabel.Position = UDim2.new(1, -80, 0, 0)
StealthLabel.BackgroundTransparency = 1
StealthLabel.Text = "STEALTH: ON"
StealthLabel.TextColor3 = Color3.fromRGB(0, 255, 0)
StealthLabel.Font = Enum.Font.Gotham
StealthLabel.TextSize = 11
StealthLabel.Parent = TitleBar

local TabContainer = Instance.new("ScrollingFrame")
TabContainer.Size = UDim2.new(1, -20, 0, 40)
TabContainer.Position = UDim2.new(0, 10, 0, 55)
TabContainer.BackgroundTransparency = 1
TabContainer.ScrollBarThickness = 3
TabContainer.ScrollBarImageColor3 = Color3.fromRGB(180, 220, 40)
TabContainer.CanvasSize = UDim2.new(2, 0, 0, 0)
TabContainer.Parent = MainContainer

local TabListLayout = Instance.new("UIListLayout")
TabListLayout.FillDirection = Enum.FillDirection.Horizontal
TabListLayout.Padding = UDim.new(0, 8)
TabListLayout.Parent = TabContainer

local ContentContainer = Instance.new("Frame")
ContentContainer.Size = UDim2.new(1, -20, 1, -120)
ContentContainer.Position = UDim2.new(0, 10, 0, 105)
ContentContainer.BackgroundColor3 = Color3.fromRGB(255, 255, 180)
ContentContainer.Parent = MainContainer

local ContentCorner = Instance.new("UICorner")
ContentCorner.CornerRadius = UDim.new(0, 8)
ContentCorner.Parent = ContentContainer

local ContentScroll = Instance.new("ScrollingFrame")
ContentScroll.Size = UDim2.new(1, 0, 1, 0)
ContentScroll.BackgroundTransparency = 1
ContentScroll.ScrollBarThickness = 5
ContentScroll.ScrollBarImageColor3 = Color3.fromRGB(180, 220, 40)
ContentScroll.CanvasSize = UDim2.new(0, 0, 2, 0)
ContentScroll.Parent = ContentContainer

local ContentLayout = Instance.new("UIListLayout")
ContentLayout.Padding = UDim.new(0, 15)
ContentLayout.Parent = ContentScroll

local tabs = {
    "üè† MAIN", "üåæ FARM", "üé∞ GACHA", "‚ö° STATS", 
    "üöÄ TELEPORT", "ü•ö OPEN EGG", "‚öôÔ∏è SETTINGS", "üéØ ENEMIES"
}
local tabFrames, tabButtons = {}, {}

for i, tabName in pairs(tabs) do
    local tabButton = Instance.new("TextButton")
    tabButton.Size = UDim2.new(0, 120, 1, 0)
    tabButton.BackgroundColor3 = i == 1 and Color3.fromRGB(255, 255, 40) or Color3.fromRGB(220, 255, 40)
    tabButton.Text = tabName
    tabButton.TextColor3 = Color3.fromRGB(40, 40, 20)
    tabButton.Font = Enum.Font.GothamBold
    tabButton.TextSize = 12
    tabButton.Parent = TabContainer

    local tabButtonCorner = Instance.new("UICorner")
    tabButtonCorner.CornerRadius = UDim.new(0, 6)
    tabButtonCorner.Parent = tabButton

    local contentFrame = Instance.new("ScrollingFrame")
    contentFrame.Size = UDim2.new(1, 0, 1, 0)
    contentFrame.BackgroundTransparency = 1
    contentFrame.ScrollBarThickness = 5
    contentFrame.ScrollBarImageColor3 = Color3.fromRGB(180, 220, 40)
    contentFrame.CanvasSize = UDim2.new(0, 0, 2, 0)
    contentFrame.Visible = i == 1
    contentFrame.Parent = ContentScroll

    local contentFrameLayout = Instance.new("UIListLayout")
    contentFrameLayout.Padding = UDim.new(0, 10)
    contentFrameLayout.Parent = contentFrame

    tabFrames[tabName] = contentFrame
    tabButtons[tabName] = tabButton

    SafeConnect(tabButton.MouseButton1Click, function()
        for name, frame in pairs(tabFrames) do
            frame.Visible = (name == tabName)
        end
        for name, btn in pairs(tabButtons) do
            btn.BackgroundColor3 = (name == tabName) and Color3.fromRGB(255, 255, 40) or Color3.fromRGB(220, 255, 40)
        end
    end)
end

function CreateToggleSwitch(text, description, default, callback)
    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(1, 0, 0, 50)
    frame.BackgroundTransparency = 1

    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(0.7, 0, 0.5, 0)
    label.Position = UDim2.new(0, 10, 0, 5)
    label.BackgroundTransparency = 1
    label.Text = text
    label.TextColor3 = Color3.fromRGB(40,40,20)
    label.Font = Enum.Font.GothamBold
    label.TextSize = 14
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.Parent = frame

    local desc = Instance.new("TextLabel")
    desc.Size = UDim2.new(0.7, 0, 0.5, 0)
    desc.Position = UDim2.new(0, 10, 0.5, 0)
    desc.BackgroundTransparency = 1
    desc.Text = description
    desc.TextColor3 = Color3.fromRGB(120,120,60)
    desc.Font = Enum.Font.Gotham
    desc.TextSize = 11
    desc.TextXAlignment = Enum.TextXAlignment.Left
    desc.Parent = frame

    local toggle = Instance.new("TextButton")
    toggle.Size = UDim2.new(0, 40, 0, 24)
    toggle.Position = UDim2.new(1, -60, 0.5, -12)
    toggle.BackgroundColor3 = default and Color3.fromRGB(180, 220, 40) or Color3.fromRGB(255, 255, 40)
    toggle.Text = default and "ON" or "OFF"
    toggle.TextColor3 = Color3.fromRGB(40,40,20)
    toggle.Font = Enum.Font.GothamBold
    toggle.TextSize = 12
    toggle.Parent = frame

    local toggled = default
    toggle.MouseButton1Click:Connect(function()
        toggled = not toggled
        toggle.BackgroundColor3 = toggled and Color3.fromRGB(180, 220, 40) or Color3.fromRGB(255, 255, 40)
        toggle.Text = toggled and "ON" or "OFF"
        if callback then callback(toggled) end
    end)

    return frame
end

function CreateActionButton(text, description, callback)
    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(1, 0, 0, 50)
    frame.BackgroundTransparency = 1

    local btn = Instance.new("TextButton")
    btn.Size = UDim2.new(0.5, 0, 0, 32)
    btn.Position = UDim2.new(0, 10, 0, 9)
    btn.BackgroundColor3 = Color3.fromRGB(255, 255, 40)
    btn.Text = text
    btn.TextColor3 = Color3.fromRGB(40,40,20)
    btn.Font = Enum.Font.GothamBold
    btn.TextSize = 13
    btn.Parent = frame

    local btnCorner = Instance.new("UICorner")
    btnCorner.CornerRadius = UDim.new(0, 6)
    btnCorner.Parent = btn

    local desc = Instance.new("TextLabel")
    desc.Size = UDim2.new(0.5, 0, 0, 20)
    desc.Position = UDim2.new(0.5, 20, 0, 15)
    desc.BackgroundTransparency = 1
    desc.Text = description
    desc.TextColor3 = Color3.fromRGB(120,120,60)
    desc.Font = Enum.Font.Gotham
    desc.TextSize = 11
    desc.TextXAlignment = Enum.TextXAlignment.Left
    desc.Parent = frame

    btn.MouseButton1Click:Connect(function()
        if callback then callback() end
    end)

    return frame
end

function CreateComboBox(text, description, items, callback)
    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(1, 0, 0, 60)
    frame.BackgroundTransparency = 1

    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(0.5, 0, 0.5, 0)
    label.Position = UDim2.new(0, 10, 0, 5)
    label.BackgroundTransparency = 1
    label.Text = text
    label.TextColor3 = Color3.fromRGB(40,40,20)
    label.Font = Enum.Font.GothamBold
    label.TextSize = 14
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.Parent = frame

    local desc = Instance.new("TextLabel")
    desc.Size = UDim2.new(0.5, 0, 0.5, 0)
    desc.Position = UDim2.new(0, 10, 0.5, 0)
    desc.BackgroundTransparency = 1
    desc.Text = description
    desc.TextColor3 = Color3.fromRGB(120,120,60)
    desc.Font = Enum.Font.Gotham
    desc.TextSize = 11
    desc.TextXAlignment = Enum.TextXAlignment.Left
    desc.Parent = frame

    local dropdown = Instance.new("TextButton")
    dropdown.Size = UDim2.new(0.4, 0, 0, 32)
    dropdown.Position = UDim2.new(0.55, 0, 0.25, 0)
    dropdown.BackgroundColor3 = Color3.fromRGB(255, 255, 40)
    dropdown.Text = items[1] or "Select"
    dropdown.TextColor3 = Color3.fromRGB(40,40,20)
    dropdown.Font = Enum.Font.GothamBold
    dropdown.TextSize = 13
    dropdown.Parent = frame

    local btnCorner = Instance.new("UICorner")
    btnCorner.CornerRadius = UDim.new(0, 6)
    btnCorner.Parent = dropdown

    local selected = items[1]
    dropdown.MouseButton1Click:Connect(function()
        local menu = Instance.new("Frame")
        menu.Size = UDim2.new(0.4, 0, 0, math.min(#items*28, 200))
        menu.Position = UDim2.new(0.55, 0, 0.75, 0)
        menu.BackgroundColor3 = Color3.fromRGB(255, 255, 180)
        menu.Parent = frame
        local menuCorner = Instance.new("UICorner")
        menuCorner.CornerRadius = UDim.new(0, 6)
        menuCorner.Parent = menu
        
        local menuScroll = Instance.new("ScrollingFrame")
        menuScroll.Size = UDim2.new(1, 0, 1, 0)
        menuScroll.BackgroundTransparency = 1
        menuScroll.CanvasSize = UDim2.new(0, 0, 0, #items*28)
        menuScroll.Parent = menu
        
        for i, item in ipairs(items) do
            local itemBtn = Instance.new("TextButton")
            itemBtn.Size = UDim2.new(1, 0, 0, 28)
            itemBtn.Position = UDim2.new(0, 0, 0, (i-1)*28)
            itemBtn.BackgroundColor3 = Color3.fromRGB(255, 255, 40)
            itemBtn.Text = item
            itemBtn.TextColor3 = Color3.fromRGB(40,40,20)
            itemBtn.Font = Enum.Font.Gotham
            itemBtn.TextSize = 12
            itemBtn.Parent = menuScroll
            itemBtn.MouseButton1Click:Connect(function()
                dropdown.Text = item
                selected = item
                menu:Destroy()
                if callback then callback(item) end
            end)
        end
    end)

    return frame
end

-- MAIN TAB
local mainContent = tabFrames["üè† MAIN"]
local mainStatus = Instance.new("TextLabel")
mainStatus.Size = UDim2.new(1, -20, 0, 30)
mainStatus.BackgroundTransparency = 1
mainStatus.Text = "üü° Himono Hub - Advanced & Ready!"
mainStatus.TextColor3 = Color3.fromRGB(40,40,20)
mainStatus.Font = Enum.Font.Gotham
mainStatus.TextSize = 14
mainStatus.Parent = mainContent

local autoAttackToggle = CreateToggleSwitch("Enable Auto Attack", "T·ª± ƒë·ªông t·∫•n c√¥ng k·∫ª ƒë·ªãch g·∫ßn nh·∫•t", false, function(enabled)
    if enabled then StartLoop("AutoAttack", AutoAttackLogic, 0.3) else StopLoop("AutoAttack") end
end)
autoAttackToggle.Parent = mainContent

local autoFarmSelectedToggle = CreateToggleSwitch("Enable Auto Farm Selected Enemies", "T·ª± ƒë·ªông farm T·∫§T C·∫¢ con enemy c√≥ T√äN ƒë√£ ch·ªçn", false, function(enabled)
    if enabled then StartLoop("FarmSelected", FarmSelectedLogic, 0.5) else StopLoop("FarmSelected") end
end)
autoFarmSelectedToggle.Parent = mainContent

local autoFarmRandomToggle = CreateToggleSwitch("Enable Farm Random Enemies", "T·ª± ƒë·ªông farm ng·∫´u nhi√™n", false, function(enabled)
    if enabled then StartLoop("FarmRandom", FarmRandomLogic, 0.5) else StopLoop("FarmRandom") end
end)
autoFarmRandomToggle.Parent = mainContent

local autoDropsToggle = CreateToggleSwitch("Enable Auto Collect All Drops", "T·ª± ƒë·ªông nh·∫∑t v·∫≠t ph·∫©m quanh b·∫°n", false, function(enabled)
    if enabled then StartLoop("AutoCollect", AutoCollectLogic, 1.0) else StopLoop("AutoCollect") end
end)
autoDropsToggle.Parent = mainContent

-- FARM TAB
local farmContent = tabFrames["üåæ FARM"]

local selectEnemyBtn = CreateActionButton("Select Enemies to Farm", "Ch·ªçn lo·∫°i enemy ƒë·ªÉ farm", function()
    local enemies = RefreshEnemiesList()
    local items = {}
    for _, enemy in ipairs(enemies) do 
        table.insert(items, enemy.Name) 
    end
    
    if #items == 0 then
        print("‚ùå Kh√¥ng t√¨m th·∫•y enemy n√†o g·∫ßn ƒë√≥!")
        return
    end
    
    local combo = CreateComboBox("Enemy List", "Ch·ªçn enemy ƒë·ªÉ farm (l∆∞u t√™n)", items, function(selected)
        local found = false
        for _, name in ipairs(selectedEnemyNames) do
            if name == selected then found = true; break end
        end
        if not found then
            table.insert(selectedEnemyNames, selected)
            print("‚úÖ Added to farm list: " .. selected)
        else
            print("‚ö†Ô∏è Already in farm list: " .. selected)
        end
    end)
    combo.Parent = farmContent
end)
selectEnemyBtn.Parent = farmContent

local clearFarmBtn = CreateActionButton("Clear Farm List", "X√≥a danh s√°ch enemy ƒë∆∞·ª£c ch·ªçn", function()
    selectedEnemyNames = {}
    print("üóëÔ∏è Cleared farm list!")
end)
clearFarmBtn.Parent = farmContent

local showFarmBtn = CreateActionButton("Show Selected List", "Xem danh s√°ch enemy ƒëang farm", function()
    if #selectedEnemyNames == 0 then
        print("üì≠ Farm list is empty!")
    else
        print("üìã Current Farm List:")
        for i, name in ipairs(selectedEnemyNames) do
            print("  " .. i .. ". " .. name)
        end
    end
end)
showFarmBtn.Parent = farmContent

local refreshBtn = CreateActionButton("Refresh Enemy List", "Qu√©t l·∫°i danh s√°ch k·∫ª ƒë·ªãch", function()
    lastEnemyCacheTime = 0
    local enemies = RefreshEnemiesList()
    print("üîÑ Found " .. #enemies .. " enemies!")
end)
refreshBtn.Parent = farmContent

-- GACHA TAB
local gachaContent = tabFrames["üé∞ GACHA"]
local gachaTypes = {"Biju", "Sayajin", "Race", "Haki", "Fruits"}
local gachaCombo = CreateComboBox("Gacha Type", "Ch·ªçn lo·∫°i gacha ƒë·ªÉ roll", gachaTypes, function(selected)
    selectedGachaType = selected
end)
gachaCombo.Parent = gachaContent

for _, gacha in ipairs(gachaTypes) do
    local toggle = CreateToggleSwitch("Enable Auto Roll " .. gacha, "T·ª± ƒë·ªông roll " .. gacha, false, function(enabled)
        if enabled then
            StartLoop("AutoRoll"..gacha, function() StartGacha(gacha) end, 2)
        else
            StopLoop("AutoRoll"..gacha)
        end
    end)
    toggle.Parent = gachaContent
end

-- STATS TAB
local statsContent = tabFrames["‚ö° STATS"]
local statTypes = {"Attack", "Mastery", "Speed", "Luck"}
local statCombo = CreateComboBox("Stat Type", "Ch·ªçn lo·∫°i stat ƒë·ªÉ c·ªông", statTypes, function(selected)
    selectedStat = selected
end)
statCombo.Parent = statsContent

local distributeBtn = CreateActionButton("Distribute Stat Point", "C·ªông ƒëi·ªÉm stat ƒë√£ ch·ªçn", function()
    DistributeStat(selectedStat)
    print("‚ö° Distributed stat: " .. selectedStat)
end)
distributeBtn.Parent = statsContent

-- TELEPORT TAB
local teleportContent = tabFrames["üöÄ TELEPORT"]
local zoneList = {"Zone 1", "Zone 2", "Zone 3", "Zone 4"}
local zoneCombo = CreateComboBox("Zone", "Ch·ªçn khu v·ª±c ƒë·ªÉ teleport", zoneList, function(selected)
    selectedZone = selected
end)
zoneCombo.Parent = teleportContent

local teleportBtn = CreateActionButton("Teleport", "Di chuy·ªÉn ƒë·∫øn khu v·ª±c ƒë√£ ch·ªçn", function()
    TeleportToZone(selectedZone)
    print("üöÄ Teleported to: " .. selectedZone)
end)
teleportBtn.Parent = teleportContent

-- OPEN EGG TAB
local eggContent = tabFrames["ü•ö OPEN EGG"]
local openEggBtn = CreateActionButton("Open Egg", "M·ªü egg g·∫ßn b·∫°n", function()
    AutoOpenEggLogic()
    print("ü•ö Opened egg!")
end)
openEggBtn.Parent = eggContent

local autoOpenEggToggle = CreateToggleSwitch("Enable Auto Open Egg", "T·ª± ƒë·ªông m·ªü egg khi g·∫ßn", false, function(enabled)
    autoOpenEggEnabled = enabled
    if enabled then
        StartLoop("AutoOpenEgg", AutoOpenEggLogic, 2)
    else
        StopLoop("AutoOpenEgg")
    end
end)
autoOpenEggToggle.Parent = eggContent

-- SETTINGS TAB
local settingsContent = tabFrames["‚öôÔ∏è SETTINGS"]
local antiAfkToggle = CreateToggleSwitch("Enable Anti-AFK", "Ch·ªëng kick khi AFK", true, function(enabled)
    if enabled then EnableAntiAFK() end
end)
antiAfkToggle.Parent = settingsContent

local stealthToggle = CreateToggleSwitch("Enable Stealth Mode", "·∫®n ho·∫°t ƒë·ªông kh·ªèi server", true, function(enabled)
    stealthMode = enabled
end)
stealthToggle.Parent = settingsContent

-- ENEMIES TAB
local enemiesContent = tabFrames["üéØ ENEMIES"]
local refreshEnemiesBtn = CreateActionButton("Refresh Enemy List", "Qu√©t l·∫°i danh s√°ch k·∫ª ƒë·ªãch", function()
    for _, child in pairs(enemiesContent:GetChildren()) do
        if child:IsA("Frame") and child ~= refreshEnemiesBtn then child:Destroy() end
    end
    lastEnemyCacheTime = 0
    local enemies = RefreshEnemiesList()
    print("üîç Found " .. #enemies .. " enemies!")
    
    for _, enemy in ipairs(enemies) do
        local infoFrame = Instance.new("Frame")
        infoFrame.Size = UDim2.new(1, 0, 0, 60)
        infoFrame.BackgroundColor3 = Color3.fromRGB(255, 255, 150)
        infoFrame.Parent = enemiesContent
        
        local cornerRadius = Instance.new("UICorner")
        cornerRadius.CornerRadius = UDim.new(0, 6)
        cornerRadius.Parent = infoFrame
        
        local nameLabel = Instance.new("TextLabel")
        nameLabel.Size = UDim2.new(0.7, 0, 0.5, 0)
        nameLabel.Position = UDim2.new(0, 10, 0, 5)
        nameLabel.BackgroundTransparency = 1
        nameLabel.Text = "üëπ " .. enemy.Name
        nameLabel.TextColor3 = Color3.fromRGB(40, 40, 20)
        nameLabel.Font = Enum.Font.GothamBold
        nameLabel.TextSize = 12
        nameLabel.TextXAlignment = Enum.TextXAlignment.Left
        nameLabel.Parent = infoFrame
        
        local distLabel = Instance.new("TextLabel")
        distLabel.Size = UDim2.new(0.7, 0, 0.5, 0)
        distLabel.Position = UDim2.new(0, 10, 0.5, 0)
        distLabel.BackgroundTransparency = 1
        distLabel.Text = "üìç Distance: " .. math.floor(enemy.Distance) .. "m | HP: " .. math.floor(enemy.Health)
        distLabel.TextColor3 = Color3.fromRGB(100, 100, 60)
        distLabel.Font = Enum.Font.Gotham
        distLabel.TextSize = 11
        distLabel.TextXAlignment = Enum.TextXAlignment.Left
        distLabel.Parent = infoFrame
        
        local selectBtn = Instance.new("TextButton")
        selectBtn.Size = UDim2.new(0.25, 0, 0.6, 0)
        selectBtn.Position = UDim2.new(0.72, 0, 0.2, 0)
        selectBtn.BackgroundColor3 = Color3.fromRGB(255, 255, 40)
        selectBtn.Text = "üéØ SELECT"
        selectBtn.TextColor3 = Color3.fromRGB(40, 40, 20)
        selectBtn.Font = Enum.Font.GothamBold
        selectBtn.TextSize = 11
        selectBtn.Parent = infoFrame
        
        local selectCorner = Instance.new("UICorner")
        selectCorner.CornerRadius = UDim.new(0, 4)
        selectCorner.Parent = selectBtn
        
        local isSelected = false
        selectBtn.MouseButton1Click:Connect(function()
            isSelected = not isSelected
            if isSelected then
                selectBtn.BackgroundColor3 = Color3.fromRGB(180, 220, 40)
                selectBtn.Text = "‚úÖ SELECTED"
                local found = false
                for _, name in ipairs(selectedEnemyNames) do
                    if name == enemy.Name then found = true; break end
                end
                if not found then
                    table.insert(selectedEnemyNames, enemy.Name)
                    print("‚úÖ Added to farm list: " .. enemy.Name)
                end
            else
                selectBtn.BackgroundColor3 = Color3.fromRGB(255, 255, 40)
                selectBtn.Text = "üéØ SELECT"
                for i, name in ipairs(selectedEnemyNames) do
                    if name == enemy.Name then
                        table.remove(selectedEnemyNames, i)
                        print("‚ùå Removed from farm list: " .. enemy.Name)
                        break
                    end
                end
            end
        end)
    end
end)
refreshEnemiesBtn.Parent = enemiesContent

-- DRAG FUNCTIONALITY
local dragging, dragInput, dragStart, startPos
SafeConnect(TitleBar.InputBegan, function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = true
        dragStart = input.Position
        startPos = MainContainer.Position
    end
end)
SafeConnect(TitleBar.InputChanged, function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement then
        dragInput = input
    end
end)
SafeConnect(TitleBar.InputEnded, function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = false
    end
end)
SafeConnect(UserInputService.InputChanged, function(input)
    if input == dragInput and dragging then
        local delta = input.Position - dragStart
        MainContainer.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
    end
end)

EnableAntiAFK()

task.spawn(function()
    while true do
        for _, frame in pairs(tabFrames) do
            if frame and frame:FindFirstChild("UIListLayout") then
                frame.CanvasSize = UDim2.new(0, 0, 0, frame.UIListLayout.AbsoluteContentSize.Y + 20)
            end
        end
        if TabContainer:FindFirstChild("UIListLayout") then
            TabContainer.CanvasSize = UDim2.new(0, TabListLayout.AbsoluteContentSize.X + 20, 0, 0)
        end
        task.wait(0.5)
    end
end)

print("üü° Himono Hub v4.2 - ADVANCED OPTIMIZED LOADED!")
print("‚úÖ Features:")
print("  ‚Ä¢ Enemy Caching (1 gi√¢y)")
print("  ‚Ä¢ Drops Caching (2 gi√¢y)")
print("  ‚Ä¢ Improved Stealth Mode (80-350ms)")
print("  ‚Ä¢ Remote Event Caching (5 gi√¢y)")
print("  ‚Ä¢ Better Performance & Anti-Cheat")
