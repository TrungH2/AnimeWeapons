-- Himono Hub v4.4 - MODERN DESIGN (FULL FEATURES + FIXED)

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local HttpService = game:GetService("HttpService")
local TweenService = game:GetService("TweenService")
local LocalPlayer = Players.LocalPlayer

-- Bi·∫øn Tr·∫°ng Th√°i C·ªët L√µi
local stealthMode = true
local safeConnections = {}
local activeLoops = {}
local selectedEnemyNames = {}
local selectedGachaType = "Biju"
local selectedZone = "Zone 1"
local selectedStat = "Mastery"
local autoOpenEggEnabled = false
local autoStatEnabled = false
local autoHatchEggEnabled = false

-- NEW: Bi·∫øn dungeon system
local selectedDungeonMode = "Easy"
local autoFarmDungeonEnabled = false
local autoJoinDungeonEnabled = false
local autoJoinRaidEnabled = false
local dungeonCompleted = false
local originalPosition = nil

-- NEW: Bi·∫øn config system
local configProfiles = {}
local selectedConfigProfile = "default"
local autoLoadProfile = ""

-- Bi·∫øn theo d√µi tr·∫°ng th√°i c√°c toggle ƒë·ªÉ l∆∞u/t·∫£i
local selectedFarmEnabled = false
local autoAttackEnabled = false
local farmRandomEnabled = false
local autoCollectEnabled = false
local stealthModeEnabled = true
local antiAFKEnabled = true

-- NEW: Bi·∫øn theo d√µi th√¥ng b√°o
local dungeonNotificationActive = false
local raidNotificationActive = false

-- Config file paths
local configFolder = "Himonohubver2/"
local configFile = configFolder .. "GameSettings.json"
local profilesFile = configFolder .. "UserProfiles.json"

-- T·∫°o folder n·∫øu ch∆∞a t·ªìn t·∫°i
if not isfolder("Himonohubver2") then
    makefolder("Himonohubver2")
end

-- Kh·ªüi t·∫°o random seed m·ªôt l·∫ßn duy nh·∫•t
local random = Random.new(tick())

-- M√†u s·∫Øc theme m·ªõi (Xanh Hi·ªán ƒê·∫°i)
local ColorTheme = {
    Background = Color3.fromRGB(10, 15, 25),
    Secondary = Color3.fromRGB(20, 25, 40),
    Accent = Color3.fromRGB(0, 170, 255),
    AccentHover = Color3.fromRGB(0, 200, 255),
    Text = Color3.fromRGB(240, 240, 255),
    TextSecondary = Color3.fromRGB(180, 200, 220),
    Success = Color3.fromRGB(0, 255, 140),
    Danger = Color3.fromRGB(255, 80, 80),
    Warning = Color3.fromRGB(255, 200, 0)
}

-- Safe remote fire
local function SafeFire(remote, ...)
    if stealthMode then RunService.Heartbeat:Wait() end
    remote:FireServer(...)
end

local function SafeWait()
    if not stealthMode then task.wait(); return end
    local delay = random:NextNumber(20, 50) / 100
    local start = tick()
    while tick() - start < delay do RunService.Heartbeat:Wait() end
end

local function SafeCall(func, ...)
    local success, result = pcall(func, ...)
    return success and result or nil
end

local function SafeConnect(signal, callback)
    local conn = signal:Connect(function(...)
        if stealthMode then SafeWait() end
        SafeCall(callback, ...)
    end)
    table.insert(safeConnections, conn)
    return conn
end

local function StartLoop(name, func, interval)
    if activeLoops[name] then activeLoops[name] = false; task.wait(0.1) end
    activeLoops[name] = true
    task.spawn(function()
        while activeLoops[name] do
            pcall(func)
            if interval then task.wait(interval) else RunService.Heartbeat:Wait() end
        end
    end)
end

local function StopLoop(name)
    if activeLoops[name] then activeLoops[name] = false end
end

-- NEW: H√†m ki·ªÉm tra th√¥ng b√°o tr√™n m√†n h√¨nh
local function CheckScreenNotifications()
    dungeonNotificationActive = false
    raidNotificationActive = false
    
    -- Ki·ªÉm tra t·∫•t c·∫£ GUI trong CoreGui
    local gui = game:GetService("CoreGui")
    for _, child in pairs(gui:GetDescendants()) do
        if child:IsA("TextLabel") or child:IsA("TextButton") or child:IsA("Frame") then
            local text = string.lower(tostring(child.Text or child.Name))
            if text:find("dungeon") and (text:find("open") or text:find("available") or text:find("easy") or text:find("medium") or text:find("hard")) then
                dungeonNotificationActive = true
            end
            if text:find("raid") and (text:find("open") or text:find("available")) then
                raidNotificationActive = true
            end
        end
    end
end

-- NEW: Auto Join Dungeon Logic (CH·ªà JOIN KHI C√ì TH√îNG B√ÅO)
local function AutoJoinDungeonLoop()
    if autoJoinDungeonEnabled then
        -- Ki·ªÉm tra th√¥ng b√°o
        CheckScreenNotifications()
        
        if dungeonNotificationActive then
            pcall(function()
                local remote = ReplicatedStorage:FindFirstChild("Reply") and ReplicatedStorage.Reply:FindFirstChild("Reliable")
                if remote then
                    local modeNumber
                    if selectedDungeonMode == "Easy" then
                        modeNumber = "1"
                    elseif selectedDungeonMode == "Medium" then
                        modeNumber = "2" 
                    elseif selectedDungeonMode == "Hard" then
                        modeNumber = "3"
                    else
                        modeNumber = "1"
                    end
                    
                    local dungeonCode = "Dungeon:" .. modeNumber
                    SafeFire(remote, "Join Gamemode", {[1]=dungeonCode})
                    
                    dungeonCompleted = false
                    originalPosition = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") and LocalPlayer.Character.HumanoidRootPart.Position
                    
                    -- T·ª± ƒë·ªông farm n·∫øu ƒë∆∞·ª£c b·∫≠t
                    if autoFarmDungeonEnabled then
                        task.wait(3)
                        StartLoop("FarmDungeon", FarmDungeonLogic, 0.2)
                    end
                end
            end)
        end
    end
end

-- NEW: Auto Join Raid Logic (CH·ªà JOIN KHI C√ì TH√îNG B√ÅO)
local function AutoJoinRaidLoop()
    if autoJoinRaidEnabled then
        -- Ki·ªÉm tra th√¥ng b√°o
        CheckScreenNotifications()
        
        if raidNotificationActive then
            pcall(function()
                local remote = ReplicatedStorage:FindFirstChild("Reply") and ReplicatedStorage.Reply:FindFirstChild("Reliable")
                if remote then
                    SafeFire(remote, "Join Gamemode", {[1]="Raid:1"})
                    
                    dungeonCompleted = false
                    originalPosition = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") and LocalPlayer.Character.HumanoidRootPart.Position
                end
            end)
        end
    end
end

local antiAFKConnection
local function EnableAntiAFK()
    if antiAFKConnection then antiAFKConnection:Disconnect() end
    antiAFKConnection = LocalPlayer.Idled:Connect(function()
        SafeCall(function()
            VirtualUser:CaptureController()
            VirtualUser:ClickButton2(Vector2.new())
        end)
    end)
end

local function DisableAntiAFK()
    if antiAFKConnection then
        antiAFKConnection:Disconnect()
        antiAFKConnection = nil
    end
end

-- SIMPLIFIED: Kh√¥ng l·ªçc NPC
local function FindEnemiesInRange(range)
    local character = LocalPlayer.Character
    if not character or not character:FindFirstChild("HumanoidRootPart") then return {} end
    local enemies = {}
    local playerPos = character.HumanoidRootPart.Position
    for _, obj in pairs(workspace:GetDescendants()) do
        if obj:IsA("Model") and obj:FindFirstChild("Humanoid") and obj:FindFirstChild("Head") then
            local isPlayer = false
            for _, player in pairs(Players:GetPlayers()) do
                if player.Character == obj then isPlayer = true; break end
            end
            if not isPlayer and obj.Humanoid.Health > 0 then
                local distance = (playerPos - obj.Head.Position).Magnitude
                if distance <= (range or 100) then
                    table.insert(enemies, {
                        Model = obj,
                        Name = obj.Name,
                        Position = obj.Head.Position,
                        Distance = distance,
                        Health = obj.Humanoid.Health,
                        MaxHealth = obj.Humanoid.MaxHealth
                    })
                end
            end
        end
    end
    table.sort(enemies, function(a, b) return a.Distance < b.Distance end)
    return enemies
end

-- NEW: T√¨m enemies trong dungeon
local function FindDungeonEnemies(range)
    local character = LocalPlayer.Character
    if not character or not character:FindFirstChild("HumanoidRootPart") then return {} end
    
    local enemies = {}
    local playerPos = character.HumanoidRootPart.Position
    
    local inDungeon = false
    for _, obj in pairs(workspace:GetDescendants()) do
        if (obj.Name:lower():find("dungeon") or obj.Name:lower():find("room") or obj.Name:lower():find("boss") or obj.Name:lower():find("raid")) 
           and (playerPos - obj.Position).Magnitude < 200 then
            inDungeon = true
            break
        end
    end
    
    if not inDungeon then return {} end
    
    for _, obj in pairs(workspace:GetDescendants()) do
        if obj:IsA("Model") and obj:FindFirstChild("Humanoid") and obj:FindFirstChild("Head") then
            local isPlayer = false
            for _, player in pairs(Players:GetPlayers()) do
                if player.Character == obj then isPlayer = true; break end
            end
            if not isPlayer and obj.Humanoid.Health > 0 then
                local distance = (playerPos - obj.Head.Position).Magnitude
                if distance <= (range or 100) then
                    table.insert(enemies, {
                        Model = obj,
                        Name = obj.Name,
                        Position = obj.Head.Position,
                        Distance = distance,
                        Health = obj.Humanoid.Health,
                        MaxHealth = obj.Humanoid.MaxHealth
                    })
                end
            end
        end
    end
    table.sort(enemies, function(a, b) return a.Distance < b.Distance end)
    return enemies
end

-- Group enemies by name
local function GetEnemyGroups()
    local enemies = FindEnemiesInRange(200)
    local groups = {}
    
    for _, enemy in ipairs(enemies) do
        if not groups[enemy.Name] then
            groups[enemy.Name] = {
                name = enemy.Name,
                count = 0,
                nearestDistance = math.huge
            }
        end
        
        groups[enemy.Name].count = groups[enemy.Name].count + 1
        if enemy.Distance < groups[enemy.Name].nearestDistance then
            groups[enemy.Name].nearestDistance = enemy.Distance
        end
    end
    
    return groups
end

-- Auto farm logic
local function FarmSelectedLogic()
    if #selectedEnemyNames == 0 then return end
    
    local character = LocalPlayer.Character
    if not character or not character:FindFirstChild("HumanoidRootPart") then return end
    
    local enemies = FindEnemiesInRange(200)
    local targets = {}
    
    for _, enemy in ipairs(enemies) do
        for _, selectedName in ipairs(selectedEnemyNames) do
            if enemy.Name == selectedName then
                table.insert(targets, enemy)
                break 
            end
        end
    end
    
    table.sort(targets, function(a, b) return a.Distance < b.Distance end)
    
    if #targets == 0 then return end
    
    for _, target in ipairs(targets) do
        if not activeLoops["FarmSelected"] then break end 
        
        if target.Model and target.Model:FindFirstChild("Humanoid") and target.Model.Humanoid.Health > 0 then
            local offset = Vector3.new(
                random:NextInteger(-15, 15) / 10,
                3,
                random:NextInteger(-15, 15) / 10
            )
            character.HumanoidRootPart.CFrame = CFrame.new(target.Position + offset)
            
            local remote = ReplicatedStorage:FindFirstChild("RemoteEvent") or ReplicatedStorage:FindFirstChild("Remote")
            if remote then 
                SafeFire(remote, "Attack", target.Model)
                task.wait(0.05)
                SafeFire(remote, "Attack", target.Model)
            end
        end
        task.wait(0.1) 
    end
end

-- Auto farm dungeon logic
local function FarmDungeonLogic()
    local character = LocalPlayer.Character
    if not character or not character:FindFirstChild("HumanoidRootPart") then return end
    
    if not originalPosition then
        originalPosition = character.HumanoidRootPart.Position
    end
    
    local enemies = FindDungeonEnemies(100)
    
    if #enemies > 0 then
        for _, enemy in ipairs(enemies) do
            if not activeLoops["FarmDungeon"] then break end
            
            if enemy.Model and enemy.Model:FindFirstChild("Humanoid") and enemy.Model.Humanoid.Health > 0 then
                local offset = Vector3.new(
                    random:NextInteger(-12, 12) / 10,
                    2,
                    random:NextInteger(-12, 12) / 10
                )
                character.HumanoidRootPart.CFrame = CFrame.new(enemy.Position + offset)
                
                local remote = ReplicatedStorage:FindFirstChild("RemoteEvent") or ReplicatedStorage:FindFirstChild("Remote")
                if remote then 
                    SafeFire(remote, "Attack", enemy.Model)
                    task.wait(0.05)
                    SafeFire(remote, "Attack", enemy.Model)
                end
                
                task.wait(0.1)
            end
        end
    else
        dungeonCompleted = true
        task.wait(2)
        
        if originalPosition then
            character.HumanoidRootPart.CFrame = CFrame.new(originalPosition)
            originalPosition = nil
        end
        
        StopLoop("FarmDungeon")
        autoFarmDungeonEnabled = false
    end
end

-- NEW: Auto stat logic
local function AutoStatLogic()
    if autoStatEnabled then
        DistributeStat(selectedStat)
    end
end

-- NEW: Auto hatch egg logic
local function AutoHatchEggLogic()
    if autoHatchEggEnabled then
        local remote = ReplicatedStorage:FindFirstChild("Reply") and ReplicatedStorage.Reply:FindFirstChild("Reliable")
        if remote then
            local function getNil(name, class)
                for _, v in next, getnilinstances() do
                    if v.ClassName == class and v.Name == name then
                        return v
                    end
                end
            end
            
            local args = {
                [1] = "Gacha Multi",
                [2] = {
                    [1] = getNil("InputObject", "InputObject"),
                    [2] = 0
                }
            }
            
            SafeFire(remote, unpack(args))
        end
    end
end

-- Auto farm logic
local function AutoAttackLogic()
    local enemies = FindEnemiesInRange(50)
    if #enemies > 0 then
        local nearestEnemy = enemies[1]
        local character = LocalPlayer.Character
        if character and character:FindFirstChild("HumanoidRootPart") then
            local offset = Vector3.new(
                random:NextInteger(-8, 8) / 10,
                2,
                random:NextInteger(-8, 8) / 10
            )
            character.HumanoidRootPart.CFrame = CFrame.new(nearestEnemy.Position + offset)
            local remote = ReplicatedStorage:FindFirstChild("RemoteEvent") or ReplicatedStorage:FindFirstChild("Remote")
            if remote then SafeFire(remote, "Attack", nearestEnemy.Model) end
        end
    end
end

local function FarmRandomLogic()
    local enemies = FindEnemiesInRange(50)
    if #enemies > 0 then
        local randomEnemy = enemies[random:NextInteger(1, #enemies)]
        local character = LocalPlayer.Character
        if character and character:FindFirstChild("HumanoidRootPart") then
            local offset = Vector3.new(
                random:NextInteger(-8, 8) / 10,
                2,
                random:NextInteger(-8, 8) / 10
            )
            character.HumanoidRootPart.CFrame = CFrame.new(randomEnemy.Position + offset)
            local remote = ReplicatedStorage:FindFirstChild("RemoteEvent") or ReplicatedStorage:FindFirstChild("Remote")
            if remote then SafeFire(remote, "Attack", randomEnemy.Model) end
        end
    end
end

local function AutoCollectLogic()
    local character = LocalPlayer.Character
    if not character then return end
    for _, obj in pairs(workspace:GetDescendants()) do
        if obj:IsA("Part") and (obj.Name:lower():find("drop") or obj.Name:lower():find("coin") or obj.Name:lower():find("reward")) then
            local distance = (character.HumanoidRootPart.Position - obj.Position).Magnitude
            if distance < 20 then
                local remote = ReplicatedStorage:FindFirstChild("RemoteEvent") or ReplicatedStorage:FindFirstChild("Remote")
                if remote then SafeFire(remote, "Collect", obj) end
            end
        end
    end
end

-- C√°c h√†m c∆° b·∫£n
local function StartGacha(gachaType)
    local remote = ReplicatedStorage:FindFirstChild("Reply") and ReplicatedStorage.Reply:FindFirstChild("Reliable")
    if remote then
        SafeFire(remote, "Crate Roll Start", {[1]=gachaType,[2]=true})
        task.wait(1)
        SafeFire(remote, "Crate Roll Stop")
    end
end

local function TeleportToZone(zoneName)
    local remote = ReplicatedStorage:FindFirstChild("Reply") and ReplicatedStorage.Reply:FindFirstChild("Reliable")
    if remote then
        SafeFire(remote, "Zone Teleport", {[1]=zoneName})
    end
end

local function DistributeStat(statName)
    local remote = ReplicatedStorage:FindFirstChild("Reply") and ReplicatedStorage.Reply:FindFirstChild("Reliable")
    if remote then
        SafeFire(remote, "Distribute Stat Point", {[1]=statName})
    end
end

-- NEW: Join dungeon function
local function JoinDungeon(mode)
    local remote = ReplicatedStorage:FindFirstChild("Reply") and ReplicatedStorage.Reply:FindFirstChild("Reliable")
    if remote then
        local modeNumber
        if mode == "Easy" then
            modeNumber = "1"
        elseif mode == "Medium" then
            modeNumber = "2"
        elseif mode == "Hard" then
            modeNumber = "3"
        else
            modeNumber = "1"
        end
        
        local dungeonCode = "Dungeon:" .. modeNumber
        SafeFire(remote, "Join Gamemode", {[1]=dungeonCode})
        
        dungeonCompleted = false
        originalPosition = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") and LocalPlayer.Character.HumanoidRootPart.Position
        
        if autoFarmDungeonEnabled then
            task.wait(3)
            StartLoop("FarmDungeon", FarmDungeonLogic, 0.2)
        end
    end
end

-- NEW: Join raid function
local function JoinRaid()
    local remote = ReplicatedStorage:FindFirstChild("Reply") and ReplicatedStorage.Reply:FindFirstChild("Reliable")
    if remote then
        SafeFire(remote, "Join Gamemode", {[1]="Raid:1"})
        
        dungeonCompleted = false
        originalPosition = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") and LocalPlayer.Character.HumanoidRootPart.Position
    end
end

-- NEW: Config Profiles System
local function SaveProfiles()
    local data = {
        profiles = configProfiles,
        autoLoadProfile = autoLoadProfile
    }
    local encoded = HttpService:JSONEncode(data)
    writefile(profilesFile, encoded)
end

local function LoadProfiles()
    if isfile(profilesFile) then
        local success, data = pcall(function()
            local encoded = readfile(profilesFile)
            return HttpService:JSONDecode(encoded)
        end)
        if success and data then
            configProfiles = data.profiles or {}
            autoLoadProfile = data.autoLoadProfile or ""
        end
    end
end

local function SaveConfig()
    local data = {
        selectedEnemyNames = selectedEnemyNames,
        selectedGachaType = selectedGachaType,
        selectedZone = selectedZone,
        selectedStat = selectedStat,
        autoOpenEggEnabled = autoOpenEggEnabled,
        autoStatEnabled = autoStatEnabled,
        autoHatchEggEnabled = autoHatchEggEnabled,
        stealthMode = stealthMode,
        
        -- Dungeon settings
        selectedDungeonMode = selectedDungeonMode,
        autoFarmDungeonEnabled = autoFarmDungeonEnabled,
        autoJoinDungeonEnabled = autoJoinDungeonEnabled,
        autoJoinRaidEnabled = autoJoinRaidEnabled,
        
        -- Toggle states
        selectedFarmEnabled = selectedFarmEnabled,
        autoAttackEnabled = autoAttackEnabled,
        farmRandomEnabled = farmRandomEnabled,
        autoCollectEnabled = autoCollectEnabled,
        stealthModeEnabled = stealthMode,
        antiAFKEnabled = antiAFKEnabled
    }
    
    configProfiles[selectedConfigProfile] = data
    SaveProfiles()
end

local function LoadConfig(profileName)
    if not profileName then profileName = selectedConfigProfile end
    
    if configProfiles[profileName] then
        local data = configProfiles[profileName]
        
        selectedEnemyNames = data.selectedEnemyNames or {}
        selectedGachaType = data.selectedGachaType or "Biju"
        selectedZone = data.selectedZone or "Zone 1"
        selectedStat = data.selectedStat or "Mastery"
        autoOpenEggEnabled = data.autoOpenEggEnabled or false
        autoStatEnabled = data.autoStatEnabled or false
        autoHatchEggEnabled = data.autoHatchEggEnabled or false
        stealthMode = data.stealthMode or true
        
        -- Dungeon settings
        selectedDungeonMode = data.selectedDungeonMode or "Easy"
        autoFarmDungeonEnabled = data.autoFarmDungeonEnabled or false
        autoJoinDungeonEnabled = data.autoJoinDungeonEnabled or false
        autoJoinRaidEnabled = data.autoJoinRaidEnabled or false
        
        -- Toggle states
        selectedFarmEnabled = data.selectedFarmEnabled or false
        autoAttackEnabled = data.autoAttackEnabled or false
        farmRandomEnabled = data.farmRandomEnabled or false
        autoCollectEnabled = data.autoCollectEnabled or false
        stealthModeEnabled = data.stealthModeEnabled or true
        antiAFKEnabled = data.antiAFKEnabled or true
        
        return true
    end
    return false
end

local function DeleteConfig(profileName)
    if not profileName then profileName = selectedConfigProfile end
    
    if configProfiles[profileName] then
        configProfiles[profileName] = nil
        
        if autoLoadProfile == profileName then
            autoLoadProfile = ""
        end
        
        SaveProfiles()
        return true
    end
    return false
end

local function CreateNewProfile(profileName)
    if not profileName or profileName == "" then return false end
    
    if not configProfiles[profileName] then
        configProfiles[profileName] = {
            selectedEnemyNames = {},
            selectedGachaType = "Biju",
            selectedZone = "Zone 1",
            selectedStat = "Mastery",
            autoOpenEggEnabled = false,
            autoStatEnabled = false,
            autoHatchEggEnabled = false,
            stealthMode = true,
            selectedDungeonMode = "Easy",
            autoFarmDungeonEnabled = false,
            autoJoinDungeonEnabled = false,
            autoJoinRaidEnabled = false,
            selectedFarmEnabled = false,
            autoAttackEnabled = false,
            farmRandomEnabled = false,
            autoCollectEnabled = false,
            stealthModeEnabled = true,
            antiAFKEnabled = true
        }
        
        SaveProfiles()
        return true
    end
    return false
end

local function SetAutoLoadProfile(profileName)
    if configProfiles[profileName] then
        autoLoadProfile = profileName
        SaveProfiles()
        return true
    end
    return false
end

-- GUI MODERN DESIGN
local HimonoHub = Instance.new("ScreenGui")
HimonoHub.Name = "HimonoHub"
HimonoHub.ResetOnSpawn = false
HimonoHub.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
HimonoHub.Parent = game.CoreGui

-- Main Container
local MainContainer = Instance.new("Frame")
MainContainer.Size = UDim2.new(0, 450, 0, 600)
MainContainer.Position = UDim2.new(0, 20, 0.5, -300)
MainContainer.BackgroundColor3 = ColorTheme.Background
MainContainer.BorderSizePixel = 0
MainContainer.Parent = HimonoHub

local ContainerCorner = Instance.new("UICorner")
ContainerCorner.CornerRadius = UDim.new(0.02, 0)
ContainerCorner.Parent = MainContainer

local ContainerStroke = Instance.new("UIStroke")
ContainerStroke.Color = Color3.fromRGB(40, 60, 90)
ContainerStroke.Thickness = 2
ContainerStroke.Parent = MainContainer

-- Header
local Header = Instance.new("Frame")
Header.Size = UDim2.new(1, 0, 0, 60)
Header.BackgroundColor3 = ColorTheme.Secondary
Header.BorderSizePixel = 0
Header.Parent = MainContainer

local HeaderCorner = Instance.new("UICorner")
HeaderCorner.CornerRadius = UDim.new(0.02, 0)
HeaderCorner.Parent = Header

local Logo = Instance.new("TextLabel")
Logo.Size = UDim2.new(1, -40, 1, 0)
Logo.Position = UDim2.new(0, 20, 0, 0)
Logo.BackgroundTransparency = 1
Logo.Text = "HIMONO HUB"
Logo.TextColor3 = ColorTheme.Accent
Logo.Font = Enum.Font.GothamBlack
Logo.TextSize = 18
Logo.TextXAlignment = Enum.TextXAlignment.Left
Logo.Parent = Header

local SearchBox = Instance.new("TextBox")
SearchBox.Size = UDim2.new(0, 120, 0, 30)
SearchBox.Position = UDim2.new(1, -140, 0.5, -15)
SearchBox.BackgroundColor3 = Color3.fromRGB(30, 40, 60)
SearchBox.TextColor3 = ColorTheme.Text
SearchBox.PlaceholderText = "Search"
SearchBox.PlaceholderColor3 = ColorTheme.TextSecondary
SearchBox.Text = ""
SearchBox.Font = Enum.Font.Gotham
SearchBox.TextSize = 12
SearchBox.Parent = Header

local SearchCorner = Instance.new("UICorner")
SearchCorner.CornerRadius = UDim.new(0.1, 0)
SearchCorner.Parent = SearchBox

-- Content Area
local ContentScroll = Instance.new("ScrollingFrame")
ContentScroll.Size = UDim2.new(1, -20, 1, -80)
ContentScroll.Position = UDim2.new(0, 10, 0, 70)
ContentScroll.BackgroundTransparency = 1
ContentScroll.ScrollBarThickness = 4
ContentScroll.ScrollBarImageColor3 = ColorTheme.Accent
ContentScroll.CanvasSize = UDim2.new(0, 0, 0, 1200)
ContentScroll.Parent = MainContainer

local ContentLayout = Instance.new("UIListLayout")
ContentLayout.Padding = UDim.new(0, 10)
ContentLayout.Parent = ContentScroll

-- H√†m t·∫°o section
local function CreateSection(title)
    local section = Instance.new("Frame")
    section.Size = UDim2.new(1, 0, 0, 40)
    section.BackgroundTransparency = 1
    section.Parent = ContentScroll
    
    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(1, 0, 1, 0)
    label.BackgroundTransparency = 1
    label.Text = title
    label.TextColor3 = ColorTheme.Text
    label.Font = Enum.Font.GothamBold
    label.TextSize = 16
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.Parent = section
    
    return section
end

-- H√†m t·∫°o toggle
local function CreateToggle(parent, text, description, default, callback)
    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(1, 0, 0, 60)
    frame.BackgroundTransparency = 1
    frame.Parent = parent
    
    local bg = Instance.new("Frame")
    bg.Size = UDim2.new(1, 0, 0, 50)
    bg.BackgroundColor3 = Color3.fromRGB(30, 40, 60)
    bg.Parent = frame
    
    local bgCorner = Instance.new("UICorner")
    bgCorner.CornerRadius = UDim.new(0.1, 0)
    bgCorner.Parent = bg
    
    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(0.7, 0, 0.5, 0)
    label.Position = UDim2.new(0, 15, 0, 5)
    label.BackgroundTransparency = 1
    label.Text = text
    label.TextColor3 = ColorTheme.Text
    label.Font = Enum.Font.GothamBold
    label.TextSize = 14
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.Parent = frame
    
    local desc = Instance.new("TextLabel")
    desc.Size = UDim2.new(0.7, 0, 0.5, 0)
    desc.Position = UDim2.new(0, 15, 0.5, 0)
    desc.BackgroundTransparency = 1
    desc.Text = description
    desc.TextColor3 = ColorTheme.TextSecondary
    desc.Font = Enum.Font.Gotham
    desc.TextSize = 11
    desc.TextXAlignment = Enum.TextXAlignment.Left
    desc.Parent = frame
    
    local toggle = Instance.new("TextButton")
    toggle.Size = UDim2.new(0, 50, 0, 26)
    toggle.Position = UDim2.new(1, -65, 0.5, -13)
    toggle.BackgroundColor3 = default and ColorTheme.Success or ColorTheme.Danger
    toggle.Text = default and "ON" or "OFF"
    toggle.TextColor3 = ColorTheme.Text
    toggle.Font = Enum.Font.GothamBold
    toggle.TextSize = 12
    toggle.Parent = frame
    
    local toggleCorner = Instance.new("UICorner")
    toggleCorner.CornerRadius = UDim.new(0.5, 0)
    toggleCorner.Parent = toggle
    
    local toggled = default
    toggle.MouseButton1Click:Connect(function()
        toggled = not toggled
        toggle.Text = toggled and "ON" or "OFF"
        toggle.BackgroundColor3 = toggled and ColorTheme.Success or ColorTheme.Danger
        if callback then callback(toggled) end
    end)
    
    return frame
end

-- H√†m t·∫°o button
local function CreateButton(parent, text, description, callback)
    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(1, 0, 0, 60)
    frame.BackgroundTransparency = 1
    frame.Parent = parent
    
    local btn = Instance.new("TextButton")
    btn.Size = UDim2.new(0.5, 0, 0, 40)
    btn.Position = UDim2.new(0, 10, 0, 10)
    btn.BackgroundColor3 = ColorTheme.Accent
    btn.Text = text
    btn.TextColor3 = ColorTheme.Text
    btn.Font = Enum.Font.GothamBold
    btn.TextSize = 13
    btn.Parent = frame
    
    local btnCorner = Instance.new("UICorner")
    btnCorner.CornerRadius = UDim.new(0.1, 0)
    btnCorner.Parent = btn
    
    local desc = Instance.new("TextLabel")
    desc.Size = UDim2.new(0.5, 0, 0, 20)
    desc.Position = UDim2.new(0.5, 20, 0, 20)
    desc.BackgroundTransparency = 1
    desc.Text = description
    desc.TextColor3 = ColorTheme.TextSecondary
    desc.Font = Enum.Font.Gotham
    desc.TextSize = 11
    desc.TextXAlignment = Enum.TextXAlignment.Left
    desc.Parent = frame
    
    -- Hover effect
    btn.MouseEnter:Connect(function()
        TweenService:Create(btn, TweenInfo.new(0.2), {BackgroundColor3 = ColorTheme.AccentHover}):Play()
    end)
    
    btn.MouseLeave:Connect(function()
        TweenService:Create(btn, TweenInfo.new(0.2), {BackgroundColor3 = ColorTheme.Accent}):Play()
    end)
    
    btn.MouseButton1Click:Connect(function()
        if callback then callback() end
    end)
    
    return frame
end

-- H√†m t·∫°o dropdown
local function CreateDropdown(parent, text, description, items, default, callback)
    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(1, 0, 0, 70)
    frame.BackgroundTransparency = 1
    frame.Parent = parent
    
    local bg = Instance.new("Frame")
    bg.Size = UDim2.new(1, 0, 0, 60)
    bg.BackgroundColor3 = Color3.fromRGB(30, 40, 60)
    bg.Parent = frame
    
    local bgCorner = Instance.new("UICorner")
    bgCorner.CornerRadius = UDim.new(0.1, 0)
    bgCorner.Parent = bg
    
    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(0.5, 0, 0.5, 0)
    label.Position = UDim2.new(0, 15, 0, 5)
    label.BackgroundTransparency = 1
    label.Text = text
    label.TextColor3 = ColorTheme.Text
    label.Font = Enum.Font.GothamBold
    label.TextSize = 14
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.Parent = frame
    
    local desc = Instance.new("TextLabel")
    desc.Size = UDim2.new(0.5, 0, 0.5, 0)
    desc.Position = UDim2.new(0, 15, 0.5, 0)
    desc.BackgroundTransparency = 1
    desc.Text = description
    desc.TextColor3 = ColorTheme.TextSecondary
    desc.Font = Enum.Font.Gotham
    desc.TextSize = 11
    desc.TextXAlignment = Enum.TextXAlignment.Left
    desc.Parent = frame
    
    local dropdown = Instance.new("TextButton")
    dropdown.Size = UDim2.new(0.4, 0, 0, 35)
    dropdown.Position = UDim2.new(0.55, 0, 0.2, 0)
    dropdown.BackgroundColor3 = ColorTheme.Accent
    dropdown.Text = default or items[1] or "Select"
    dropdown.TextColor3 = ColorTheme.Text
    dropdown.Font = Enum.Font.GothamBold
    dropdown.TextSize = 13
    dropdown.Parent = frame
    
    local btnCorner = Instance.new("UICorner")
    btnCorner.CornerRadius = UDim.new(0.1, 0)
    btnCorner.Parent = dropdown
    
    local selected = default or items[1]
    local menu = nil
    
    local function CloseMenu()
        if menu then
            menu:Destroy()
            menu = nil
        end
    end
    
    dropdown.MouseButton1Click:Connect(function()
        if menu then
            CloseMenu()
            return
        end
        
        menu = Instance.new("Frame")
        menu.Size = UDim2.new(0.4, 0, 0, #items * 35)
        menu.Position = UDim2.new(0.55, 0, 0.8, 0)
        menu.BackgroundColor3 = Color3.fromRGB(40, 40, 50)
        menu.Parent = frame
        
        local menuCorner = Instance.new("UICorner")
        menuCorner.CornerRadius = UDim.new(0.1, 0)
        menuCorner.Parent = menu
        
        local menuStroke = Instance.new("UIStroke")
        menuStroke.Color = ColorTheme.Accent
        menuStroke.Thickness = 1
        menuStroke.Parent = menu
        
        for i, item in ipairs(items) do
            local itemBtn = Instance.new("TextButton")
            itemBtn.Size = UDim2.new(1, 0, 0, 35)
            itemBtn.Position = UDim2.new(0, 0, 0, (i-1)*35)
            itemBtn.BackgroundColor3 = Color3.fromRGB(50, 50, 60)
            itemBtn.Text = item
            itemBtn.TextColor3 = ColorTheme.Text
            itemBtn.Font = Enum.Font.Gotham
            itemBtn.TextSize = 12
            itemBtn.Parent = menu
            
            local itemCorner = Instance.new("UICorner")
            itemCorner.CornerRadius = UDim.new(0, 0)
            itemCorner.Parent = itemBtn
            
            itemBtn.MouseButton1Click:Connect(function()
                dropdown.Text = item
                selected = item
                CloseMenu()
                if callback then callback(item) end
            end)
            
            -- Hover effect
            itemBtn.MouseEnter:Connect(function()
                TweenService:Create(itemBtn, TweenInfo.new(0.2), {BackgroundColor3 = Color3.fromRGB(60, 60, 70)}):Play()
            end)
            
            itemBtn.MouseLeave:Connect(function()
                TweenService:Create(itemBtn, TweenInfo.new(0.2), {BackgroundColor3 = Color3.fromRGB(50, 50, 60)}):Play()
            end)
        end
    end)
    
    -- Close menu khi click outside
    UserInputService.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 and menu then
            local mousePos = UserInputService:GetMouseLocation()
            local menuPos = menu.AbsolutePosition
            local menuSize = menu.AbsoluteSize
            
            if mousePos.X < menuPos.X or mousePos.X > menuPos.X + menuSize.X or
               mousePos.Y < menuPos.Y or mousePos.Y > menuPos.Y + menuSize.Y then
                CloseMenu()
            end
        end
    end)

    return frame
end

-- Auto Farm Section
local autoFarmSection = CreateSection("Auto Farm")
CreateToggle(autoFarmSection, "Auto Attack", "T·ª± ƒë·ªông t·∫•n c√¥ng k·∫ª ƒë·ªãch g·∫ßn nh·∫•t", false, function(enabled)
    autoAttackEnabled = enabled
    if enabled then StartLoop("AutoAttack", AutoAttackLogic, 0.3) else StopLoop("AutoAttack") end
end)

CreateToggle(autoFarmSection, "Auto Collect Drops", "T·ª± ƒë·ªông nh·∫∑t v·∫≠t ph·∫©m", false, function(enabled)
    autoCollectEnabled = enabled
    if enabled then StartLoop("AutoCollect", AutoCollectLogic, 1.0) else StopLoop("AutoCollect") end
end)

CreateToggle(autoFarmSection, "Farm Selected Mobs", "Farm mobs ƒë√£ ch·ªçn", false, function(enabled)
    selectedFarmEnabled = enabled
    if enabled then StartLoop("FarmSelected", FarmSelectedLogic, 0.1) else StopLoop("FarmSelected") end
end)

CreateToggle(autoFarmSection, "Farm Random Mobs", "Farm mobs ng·∫´u nhi√™n", false, function(enabled)
    farmRandomEnabled = enabled
    if enabled then StartLoop("FarmRandom", FarmRandomLogic, 0.5) else StopLoop("FarmRandom") end
end)

-- Select Mobs Section
local selectMobsSection = CreateSection("Select Mobs")
CreateButton(selectMobsSection, "Refresh Mob List", "Qu√©t v√† hi·ªÉn th·ªã enemy", function()
    -- Refresh mob list logic
    print("Refreshing mob list...")
end)

-- Gacha Section
local gachaSection = CreateSection("Gacha System")
CreateDropdown(gachaSection, "Gacha Type", "Ch·ªçn lo·∫°i gacha", {"Biju", "Sayajin", "Race", "Haki", "Fruits"}, "Biju", function(selected)
    selectedGachaType = selected
end)

CreateToggle(gachaSection, "Auto Roll Gacha", "T·ª± ƒë·ªông roll gacha", false, function(enabled)
    if enabled then
        StartLoop("AutoRoll"..selectedGachaType, function() StartGacha(selectedGachaType) end, 2)
    else
        StopLoop("AutoRoll"..selectedGachaType)
    end
end)

-- Stats Section
local statsSection = CreateSection("Stats System")
CreateDropdown(statsSection, "Stat Type", "Ch·ªçn stat ƒë·ªÉ c·ªông", {"Mastery", "Attack", "Speed", "Luck"}, "Mastery", function(selected)
    selectedStat = selected
end)

CreateToggle(statsSection, "Auto Add Stats", "T·ª± ƒë·ªông c·ªông ƒëi·ªÉm stat", false, function(enabled)
    autoStatEnabled = enabled
    if enabled then StartLoop("AutoStat", AutoStatLogic, 1) else StopLoop("AutoStat") end
end)

-- Egg Section (CH·ªà 1 OPTION)
local eggSection = CreateSection("Egg System")
CreateToggle(eggSection, "Auto Hatch Egg", "T·ª± ƒë·ªông hatch egg li√™n t·ª•c", false, function(enabled)
    autoHatchEggEnabled = enabled
    if enabled then 
        StartLoop("AutoHatchEgg", AutoHatchEggLogic, 0.5) 
    else 
        StopLoop("AutoHatchEgg") 
    end
end)

-- Teleport Section
local teleportSection = CreateSection("Teleport")
CreateDropdown(teleportSection, "Zone", "Ch·ªçn khu v·ª±c", {"Zone 1", "Zone 2", "Zone 3", "Zone 4"}, "Zone 1", function(selected)
    selectedZone = selected
end)

CreateButton(teleportSection, "Teleport", "Di chuy·ªÉn ƒë·∫øn khu v·ª±c", function()
    TeleportToZone(selectedZone)
end)

-- Dungeon Section
local dungeonSection = CreateSection("Dungeon System")
CreateDropdown(dungeonSection, "Dungeon Mode", "Ch·ªçn ch·∫ø ƒë·ªô dungeon", {"Easy", "Medium", "Hard"}, "Easy", function(selected)
    selectedDungeonMode = selected
end)

CreateToggle(dungeonSection, "Auto Join Dungeon", "T·ª± ƒë·ªông join khi c√≥ th√¥ng b√°o", false, function(enabled)
    autoJoinDungeonEnabled = enabled
    if enabled then StartLoop("AutoJoinDungeon", AutoJoinDungeonLoop, 5) else StopLoop("AutoJoinDungeon") end
end)

CreateToggle(dungeonSection, "Auto Join Raid", "T·ª± ƒë·ªông join khi c√≥ th√¥ng b√°o", false, function(enabled)
    autoJoinRaidEnabled = enabled
    if enabled then StartLoop("AutoJoinRaid", AutoJoinRaidLoop, 5) else StopLoop("AutoJoinRaid") end
end)

CreateToggle(dungeonSection, "Auto Farm Dungeon", "T·ª± ƒë·ªông farm + v·ªÅ ch·ªó c≈©", false, function(enabled)
    autoFarmDungeonEnabled = enabled
    if enabled then
        if dungeonNotificationActive then
            JoinDungeon(selectedDungeonMode)
        end
    else
        StopLoop("FarmDungeon")
    end
end)

CreateButton(dungeonSection, "Join Dungeon", "Tham gia dungeon", function()
    JoinDungeon(selectedDungeonMode)
end)

CreateButton(dungeonSection, "Join Raid", "Tham gia raid", function()
    JoinRaid()
end)

-- Config Section
local configSection = CreateSection("Config System")
local profileNameInput = Instance.new("TextBox")
profileNameInput.Size = UDim2.new(1, -20, 0, 35)
profileNameInput.Position = UDim2.new(0, 10, 0, 45)
profileNameInput.BackgroundColor3 = Color3.fromRGB(30, 40, 60)
profileNameInput.TextColor3 = ColorTheme.Text
profileNameInput.PlaceholderText = "Nh·∫≠p t√™n profile..."
profileNameInput.PlaceholderColor3 = ColorTheme.TextSecondary
profileNameInput.Text = ""
profileNameInput.Font = Enum.Font.Gotham
profileNameInput.TextSize = 12
profileNameInput.Parent = configSection

local inputCorner = Instance.new("UICorner")
inputCorner.CornerRadius = UDim.new(0.1, 0)
inputCorner.Parent = profileNameInput

CreateButton(configSection, "Create Profile", "T·∫°o profile m·ªõi", function()
    local profileName = profileNameInput.Text
    if profileName and profileName ~= "" then
        if CreateNewProfile(profileName) then
            selectedConfigProfile = profileName
            SaveConfig()
            profileNameInput.Text = ""
        end
    end
end)

CreateButton(configSection, "Save Config", "L∆∞u c·∫•u h√¨nh", function()
    SaveConfig()
end)

CreateButton(configSection, "Load Config", "T·∫£i c·∫•u h√¨nh", function()
    LoadConfig(selectedConfigProfile)
end)

CreateButton(configSection, "Delete Profile", "X√≥a profile hi·ªán t·∫°i", function()
    if selectedConfigProfile ~= "default" then
        DeleteConfig(selectedConfigProfile)
        selectedConfigProfile = "default"
        LoadConfig("default")
    end
end)

-- Settings Section
local settingsSection = CreateSection("Settings")
CreateToggle(settingsSection, "Stealth Mode", "·∫®n ho·∫°t ƒë·ªông kh·ªèi server", true, function(enabled)
    stealthMode = enabled
end)

CreateToggle(settingsSection, "Anti-AFK", "Ch·ªëng kick khi AFK", true, function(enabled)
    antiAFKEnabled = enabled
    if enabled then EnableAntiAFK() else DisableAntiAFK() end
end)

-- Mob List Container
local mobListSection = CreateSection("Mob List")
local MobListContainer = Instance.new("Frame")
MobListContainer.Size = UDim2.new(1, 0, 0, 200)
MobListContainer.BackgroundColor3 = ColorTheme.Secondary
MobListContainer.Parent = ContentScroll

local MobListCorner = Instance.new("UICorner")
MobListCorner.CornerRadius = UDim.new(0.02, 0)
MobListCorner.Parent = MobListContainer

local MobListScroll = Instance.new("ScrollingFrame")
MobListScroll.Size = UDim2.new(1, -10, 1, -10)
MobListScroll.Position = UDim2.new(0, 5, 0, 5)
MobListScroll.BackgroundTransparency = 1
MobListScroll.ScrollBarThickness = 3
MobListScroll.ScrollBarImageColor3 = ColorTheme.Accent
MobListScroll.CanvasSize = UDim2.new(0, 0, 0, 0)
MobListScroll.Parent = MobListContainer

local MobListLayout = Instance.new("UIListLayout")
MobListLayout.Padding = UDim.new(0, 5)
MobListLayout.Parent = MobListScroll

-- Auto-adjust content size
task.spawn(function()
    while true do
        ContentScroll.CanvasSize = UDim2.new(0, 0, 0, ContentLayout.AbsoluteContentSize.Y)
        MobListScroll.CanvasSize = UDim2.new(0, 0, 0, MobListLayout.AbsoluteContentSize.Y)
        task.wait(0.5)
    end
end)

-- Drag functionality
local dragging, dragInput, dragStart, startPos
Header.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = true
        dragStart = input.Position
        startPos = MainContainer.Position
    end
end)

Header.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement then
        dragInput = input
    end
end)

Header.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = false
    end
end)

UserInputService.InputChanged:Connect(function(input)
    if input == dragInput and dragging then
        local delta = input.Position - dragStart
        MainContainer.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
    end
end)

-- Initialize
LoadProfiles()
if autoLoadProfile ~= "" and configProfiles[autoLoadProfile] then
    selectedConfigProfile = autoLoadProfile
    LoadConfig(autoLoadProfile)
else
    if not configProfiles["default"] then
        CreateNewProfile("default")
        SaveConfig()
    end
    LoadConfig("default")
end

print("üéÆ HIMONO HUB v4.4 LOADED! - Full Features + Modern Design")
