--[[
    ⚡ HIMONO HUB v5.2 - DELTA EXECUTOR EDITION
    ----------------------------------------
    • Compatibility: Delta / Fluxus / Mobile / PC
    • Fixes: UI Parent (PlayerGui), Safe FileSystem, Anti-AFK
]]

-- // INIT CHECK // --
if not game:IsLoaded() then game.Loaded:Wait() end

-- // SERVICES // --
local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local HttpService = game:GetService("HttpService")
local VirtualInputManager = game:GetService("VirtualInputManager") -- Better for Delta
local Lighting = game:GetService("Lighting")

local LocalPlayer = Players.LocalPlayer
local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")

-- // GLOBAL HELPER // --
getgenv().getNil = function(name, class)
    -- Delta support check
    if getnilinstances then
        for _, v in next, getnilinstances() do
            if v.ClassName == class and v.Name == name then
                return v
            end
        end
    end
    return nil
end

-- // VARIABLES & SETTINGS // --
local FileName = "HimonoHub_Delta_Config.json"
local ProfileName = "default"

local Settings = {
    AutoFarm = false,
    AutoAttack = false,
    AutoCollect = false,
    StealthMode = true,
    AntiAFK = true,
    SelectedMobs = {},
    FarmMethod = "Behind",
    Distance = 5,
    AutoJoinDungeon = false,
    AutoJoinRaid = false,
    AutoFarmDungeon = false,
    DungeonMode = "Easy",
    AutoEgg = false,
    AutoMultiEgg = false,
    AutoRoll = false,
    SelectedGacha = "Biju",
    AutoStats = false,
    SelectedStat = "Mastery",
    FPSBoost = false,
    WhiteScreen = false
}

local State = {
    OriginalPos = nil,
    IsInDungeon = false,
    WasInDungeon = false
}

-- // NOTIFICATION SYSTEM // --
local function Notify(msg)
    print("[HIMONO]: " .. msg)
    -- Simple notification compatible with mobile
    game:GetService("StarterGui"):SetCore("SendNotification", {
        Title = "Himono Hub",
        Text = msg,
        Duration = 3
    })
end

-- // CONFIG SYSTEM (SAFE MODE) // --
local ConfigData = { Profiles = {} }

local function SaveSystem()
    pcall(function()
        ConfigData.Profiles[ProfileName] = Settings
        writefile(FileName, HttpService:JSONEncode(ConfigData))
        Notify("Config Saved: " .. ProfileName)
    end)
end

local function LoadSystem()
    pcall(function()
        if isfile(FileName) then
            local result = HttpService:JSONDecode(readfile(FileName))
            if result then
                ConfigData = result
                if ConfigData.Profiles[ProfileName] then
                    for k,v in pairs(ConfigData.Profiles[ProfileName]) do
                        Settings[k] = v
                    end
                    Notify("Config Loaded: " .. ProfileName)
                end
            end
        end
    end)
end

-- // REMOTE SYSTEM // --
local function FireRemote(args)
    if Settings.StealthMode then 
        if math.random(1, 15) == 1 then task.wait(0.1) end
    end
    
    local Remote = ReplicatedStorage:FindFirstChild("Reply") and ReplicatedStorage.Reply:FindFirstChild("Reliable")
    if Remote then
        Remote:FireServer(unpack(args))
    else
        -- Fallback
        pcall(function() ReplicatedStorage.Reply.Reliable:FireServer(unpack(args)) end)
    end
end

-- // LOGIC FUNCTIONS // --

local function UpdatePerformance()
    if Settings.FPSBoost then
        settings().Rendering.QualityLevel = 1
        Lighting.GlobalShadows = false
    else
        settings().Rendering.QualityLevel = 10
        Lighting.GlobalShadows = true
    end
    game:GetService("RunService"):Set3dRenderingEnabled(not Settings.WhiteScreen)
end

local function CheckDungeonState()
    local nowInDungeon = false
    if Workspace:FindFirstChild("Map") then
        local n = Workspace.Map.Name:lower()
        if n:find("dungeon") or n:find("raid") or n:find("boss") then nowInDungeon = true end
    end
    
    if State.WasInDungeon and not nowInDungeon then
        if State.OriginalPos and LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
            task.wait(1)
            LocalPlayer.Character.HumanoidRootPart.CFrame = CFrame.new(State.OriginalPos)
            Notify("Returned to Start")
            State.OriginalPos = nil
        end
    end
    State.WasInDungeon = nowInDungeon
    State.IsInDungeon = nowInDungeon
end

local function DungeonLoop()
    CheckDungeonState()
    if not State.IsInDungeon then
        if Settings.AutoJoinDungeon or Settings.AutoJoinRaid then
            if not State.OriginalPos and LocalPlayer.Character then 
                State.OriginalPos = LocalPlayer.Character.HumanoidRootPart.Position 
            end
        end
        
        if Settings.AutoJoinDungeon then
            local m = "1"
            if Settings.DungeonMode == "Medium" then m = "2" end
            if Settings.DungeonMode == "Hard" then m = "3" end
            FireRemote({[1] = "Join Gamemode", [2] = {[1] = "Dungeon:"..m}})
        end
        
        if Settings.AutoJoinRaid then
            FireRemote({[1] = "Join Gamemode", [2] = {[1] = "Raid:1"}})
        end
    end
end

local function FarmLoop()
    if not Settings.AutoFarm and not (Settings.AutoFarmDungeon and State.IsInDungeon) then return end
    if not LocalPlayer.Character or not LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then return end
    
    local target = nil
    for _, v in pairs(Workspace:GetDescendants()) do
        if v:IsA("Model") and v:FindFirstChild("Humanoid") and v.Humanoid.Health > 0 and not Players:GetPlayerFromCharacter(v) then
            if State.IsInDungeon and Settings.AutoFarmDungeon then
                target = v
                break
            elseif Settings.AutoFarm and table.find(Settings.SelectedMobs, v.Name) then
                target = v
                break
            end
        end
    end
    
    if target and target:FindFirstChild("HumanoidRootPart") then
        local HRP = LocalPlayer.Character.HumanoidRootPart
        local TPPos = target.HumanoidRootPart.Position
        
        if Settings.FarmMethod == "Over" then TPPos = TPPos + Vector3.new(0, Settings.Distance, 0) end
        if Settings.FarmMethod == "Under" then TPPos = TPPos - Vector3.new(0, Settings.Distance, 0) end
        if Settings.FarmMethod == "Behind" then TPPos = TPPos + (target.HumanoidRootPart.CFrame.LookVector * -Settings.Distance) end
        
        HRP.CFrame = CFrame.new(TPPos, target.HumanoidRootPart.Position)
        
        -- Attack
        FireRemote({[1] = "Settings", [2] = {[1] = "AutoClick", [2] = true}})
        FireRemote({[1] = "Attack", [2] = target})
    end
end

local function MiscLoop()
    if Settings.AutoEgg then
        local inp = getNil("InputObject", "InputObject")
        if inp then
            FireRemote({[1] = "Gacha Auto", [2] = {[1] = inp, [2] = 0}})
            if Settings.AutoMultiEgg then FireRemote({[1] = "Gacha Multi", [2] = {[1] = inp, [2] = 0}}) end
        end
    end
    if Settings.AutoRoll then
        FireRemote({[1] = "Crate Roll Start", [2] = {[1] = Settings.SelectedGacha, [2] = true}})
        task.wait(1.5)
        FireRemote({[1] = "Crate Roll Stop"})
    end
    if Settings.AutoStats then
        FireRemote({[1] = "Distribute Stat Point", [2] = {[1] = Settings.SelectedStat}})
    end
end

local function Teleport(zone)
    local map = "Dungeon"
    if zone == "Zone 2" then map = "Naruto" end
    if zone == "Zone 3" then map = "DragonBall" end
    if zone == "Zone 4" then map = "OnePiece" end
    if zone == "Zone 5" then map = "DemonSlayer" end
    FireRemote({[1] = "Zone Teleport", [2] = {[1] = map}})
end

-- // DELTA COMPATIBLE UI // --
local Library = {}
local UIVars = {
    Colors = { Main = Color3.fromRGB(18,18,22), Sec = Color3.fromRGB(25,25,30), Accent = Color3.fromRGB(0,140,255), Text = Color3.fromRGB(255,255,255) }
}

function Library:Init(title)
    -- Use PlayerGui for Delta Compatibility
    local GUI = Instance.new("ScreenGui")
    GUI.Name = "HimonoDelta"
    GUI.Parent = PlayerGui 
    GUI.ResetOnSpawn = false
    
    -- Toggle Button (Mini)
    local ToggleBtn = Instance.new("TextButton")
    ToggleBtn.Name = "ToggleUI"
    ToggleBtn.Size = UDim2.new(0, 50, 0, 50)
    ToggleBtn.Position = UDim2.new(0.8, 0, 0.1, 0)
    ToggleBtn.BackgroundColor3 = UIVars.Colors.Accent
    ToggleBtn.Text = "H"
    ToggleBtn.TextColor3 = UIVars.Colors.Text
    ToggleBtn.Font = Enum.Font.GothamBold
    ToggleBtn.TextSize = 20
    ToggleBtn.Parent = GUI
    Instance.new("UICorner", ToggleBtn).CornerRadius = UDim.new(1,0)
    
    local Main = Instance.new("Frame")
    Main.Size = UDim2.new(0, 500, 0, 350)
    Main.Position = UDim2.new(0.5, -250, 0.5, -175)
    Main.BackgroundColor3 = UIVars.Colors.Main
    Main.Parent = GUI
    Instance.new("UICorner", Main).CornerRadius = UDim.new(0, 6)
    
    -- Drag
    local dragging, dragStart, startPos
    Main.InputBegan:Connect(function(i) if i.UserInputType==Enum.UserInputType.MouseButton1 then dragging=true; dragStart=i.Position; startPos=Main.Position end end)
    Main.InputEnded:Connect(function(i) if i.UserInputType==Enum.UserInputType.MouseButton1 then dragging=false end end)
    UserInputService.InputChanged:Connect(function(i) if dragging and i.UserInputType==Enum.UserInputType.MouseMovement then local d=i.Position-dragStart; Main.Position=UDim2.new(startPos.X.Scale,startPos.X.Offset+d.X,startPos.Y.Scale,startPos.Y.Offset+d.Y) end end)

    ToggleBtn.MouseButton1Click:Connect(function() Main.Visible = not Main.Visible end)

    local Top = Instance.new("Frame")
    Top.Size = UDim2.new(1,0,0,30); Top.BackgroundColor3 = UIVars.Colors.Sec; Top.Parent = Main
    Instance.new("UICorner", Top).CornerRadius = UDim.new(0,6)
    local Txt = Instance.new("TextLabel"); Txt.Text=title; Txt.Size=UDim2.new(1,-10,1,0); Txt.Position=UDim2.new(0,10,0,0); Txt.BackgroundTransparency=1; Txt.TextColor3=UIVars.Colors.Text; Txt.Font=Enum.Font.GothamBold; Txt.TextXAlignment=Enum.TextXAlignment.Left; Txt.Parent=Top

    local TabC = Instance.new("ScrollingFrame"); TabC.Size=UDim2.new(0,100,1,-35); TabC.Position=UDim2.new(0,5,0,35); TabC.BackgroundTransparency=1; TabC.Parent=Main
    Instance.new("UIListLayout", TabC).Padding = UDim.new(0,5)
    local PageC = Instance.new("Frame"); PageC.Size=UDim2.new(1,-115,1,-35); PageC.Position=UDim2.new(0,110,0,35); PageC.BackgroundColor3=UIVars.Colors.Sec; PageC.Parent=Main
    Instance.new("UICorner", PageC).CornerRadius = UDim.new(0,4)

    return {TabC=TabC, PageC=PageC}
end

function Library:Tab(win, name)
    local Btn = Instance.new("TextButton")
    Btn.Size=UDim2.new(1,-5,0,25); Btn.BackgroundColor3=UIVars.Colors.Sec; Btn.Text=name; Btn.TextColor3=UIVars.Colors.Text; Btn.Font=Enum.Font.GothamBold; Btn.TextSize=11; Btn.Parent=win.TabC
    Instance.new("UICorner", Btn).CornerRadius=UDim.new(0,4)
    local Page = Instance.new("ScrollingFrame"); Page.Size=UDim2.new(1,-10,1,-10); Page.Position=UDim2.new(0,5,0,5); Page.BackgroundTransparency=1; Page.Visible=false; Page.Parent=win.PageC
    local L = Instance.new("UIListLayout"); L.Padding=UDim.new(0,5); L.Parent=Page
    L:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function() Page.CanvasSize=UDim2.new(0,0,0,L.AbsoluteContentSize.Y+10) end)
    Btn.MouseButton1Click:Connect(function()
        for _,v in pairs(win.TabC:GetChildren()) do if v:IsA("TextButton") then v.BackgroundColor3=UIVars.Colors.Sec end end
        for _,v in pairs(win.PageC:GetChildren()) do v.Visible=false end
        Btn.BackgroundColor3=UIVars.Colors.Accent; Page.Visible=true
    end)
    return Page
end

function Library:Toggle(page, text, flag, callback)
    local B = Instance.new("TextButton"); B.Size=UDim2.new(1,0,0,30); B.BackgroundColor3=Color3.fromRGB(35,35,40); B.Text="  "..text; B.TextColor3=UIVars.Colors.Text; B.Font=Enum.Font.Gotham; B.TextSize=11; B.TextXAlignment=Enum.TextXAlignment.Left; B.Parent=page
    Instance.new("UICorner", B).CornerRadius=UDim.new(0,4)
    local I = Instance.new("Frame"); I.Size=UDim2.new(0,8,0,8); I.Position=UDim2.new(1,-15,0.5,-4); I.Parent=B; Instance.new("UICorner", I).CornerRadius=UDim.new(1,0)
    local function Update() I.BackgroundColor3 = Settings[flag] and UIVars.Colors.Accent or UIVars.Colors.Danger end
    Update()
    B.MouseButton1Click:Connect(function() Settings[flag]=not Settings[flag]; Update(); if callback then callback(Settings[flag]) end SaveSystem() end)
end

function Library:Dropdown(page, text, list, flag, callback)
    local B = Instance.new("TextButton"); B.Size=UDim2.new(1,0,0,30); B.BackgroundColor3=Color3.fromRGB(35,35,40); B.TextColor3=UIVars.Colors.Text; B.Font=Enum.Font.Gotham; B.TextSize=11; B.TextXAlignment=Enum.TextXAlignment.Left; B.Parent=page
    Instance.new("UICorner", B).CornerRadius=UDim.new(0,4)
    local function Update() B.Text = "  "..text..": "..tostring(Settings[flag] or list[1]) end
    Update()
    B.MouseButton1Click:Connect(function()
        local cur = Settings[flag] or list[1]; local idx = table.find(list, cur) or 0
        if idx >= #list then idx=0 end
        Settings[flag] = list[idx+1]; Update(); if callback then callback(Settings[flag]) end SaveSystem()
    end)
end

function Library:Box(page, ph, callback)
    local Box = Instance.new("TextBox"); Box.Size=UDim2.new(1,0,0,30); Box.BackgroundColor3=Color3.fromRGB(35,35,40); Box.Text=""; Box.PlaceholderText=ph; Box.TextColor3=UIVars.Colors.Text; Box.Font=Enum.Font.Gotham; Box.TextSize=11; Box.Parent=page
    Instance.new("UICorner", Box).CornerRadius=UDim.new(0,4)
    Box.FocusLost:Connect(function(enter) if enter then callback(Box.Text); Box.Text="" end end)
end

function Library:Label(page, txt)
    local L = Instance.new("TextLabel"); L.Size=UDim2.new(1,0,0,20); L.BackgroundTransparency=1; L.Text=txt; L.TextColor3=UIVars.Colors.Accent; L.Font=Enum.Font.GothamBold; L.TextSize=11; L.Parent=page
end

-- // BUILD UI // --
local Win = Library:Init("Himono Hub v5.2 [Delta]")

local Main = Library:Tab(Win, "Main")
Library:Toggle(Main, "Auto Attack", "AutoAttack")
Library:Toggle(Main, "Auto Collect", "AutoCollect")
Library:Toggle(Main, "Anti-AFK", "AntiAFK")

local Farm = Library:Tab(Win, "Farm")
Library:Toggle(Farm, "Enable Farm", "AutoFarm")
Library:Dropdown(Farm, "Method", {"Over", "Behind", "Under"}, "FarmMethod")
Library:Label(Farm, "Mobs:")
local Mobs = {"Thug", "Ninja", "Pirate", "Marine", "Demon", "Boss", "Bandit"}
for _,m in pairs(Mobs) do
    Library:Toggle(Farm, "Mob: "..m, "Mob_"..m, function(v)
        if v then table.insert(Settings.SelectedMobs, m)
        else for i,n in ipairs(Settings.SelectedMobs) do if n==m then table.remove(Settings.SelectedMobs, i) end end end
    end)
end

local Dung = Library:Tab(Win, "Dungeon")
Library:Dropdown(Dung, "Mode", {"Easy", "Medium", "Hard"}, "DungeonMode")
Library:Toggle(Dung, "Auto Join Dungeon", "AutoJoinDungeon")
Library:Toggle(Dung, "Auto Join Raid", "AutoJoinRaid")
Library:Toggle(Dung, "Auto Farm (Kill All)", "AutoFarmDungeon")

local Extra = Library:Tab(Win, "Extra")
Library:Toggle(Extra, "Auto Egg", "AutoEgg")
Library:Toggle(Extra, "Multi Egg", "AutoMultiEgg")
Library:Dropdown(Extra, "Crate", {"Biju", "Sayajin", "Race", "Haki", "Fruits"}, "SelectedGacha")
Library:Toggle(Extra, "Auto Roll", "AutoRoll")
Library:Toggle(Extra, "Auto Stats", "AutoStats")
Library:Dropdown(Extra, "Stat", {"Mastery", "Damage", "Luck", "Yen"}, "SelectedStat")

local Conf = Library:Tab(Win, "System")
Library:Toggle(Conf, "FPS Boost", "FPSBoost", UpdatePerformance)
Library:Toggle(Conf, "White Screen", "WhiteScreen", UpdatePerformance)
Library:Label(Conf, "Profile Manager")
Library:Box(Conf, "Create/Select Profile...", function(t) ProfileName=t; LoadSystem() end)
Library:Dropdown(Conf, "Saved Profiles", (function() local t={} if ConfigData then for k,_ in pairs(ConfigData.Profiles) do table.insert(t,k) end end return t end)(), "Dummy", function(v) ProfileName=v; LoadSystem() end)
Library:Toggle(Conf, "Force Save Config", "DummySave", function() SaveSystem() end)

-- // INIT // --
LoadSystem()
RunService.Heartbeat:Connect(FarmLoop)
task.spawn(function()
    while task.wait(1) do
        DungeonLoop()
        MiscLoop()
        if Settings.AutoCollect and LocalPlayer.Character then
            for _,v in pairs(Workspace:GetDescendants()) do
                if (v.Name:find("Drop") or v.Name:find("Coin")) and (LocalPlayer.Character.HumanoidRootPart.Position - v.Position).Magnitude < 30 then
                    FireRemote({[1]="Collect", [2]=v})
                end
            end
        end
    end
end)

-- Anti-AFK (Delta Safe)
LocalPlayer.Idled:Connect(function()
    if Settings.AntiAFK then
        VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.Unknown, false, game)
    end
end)

Notify("Himono Hub v5.2 Loaded!")
