-- Himono Hub v4.2 - PURPLE EDITION (FULL AUTO-LOAD FIXED)
-- Himono Hub v4.2 - PURPLE EDITION (FINAL VERSION: SPEED FARM / AUTO-LOAD / MINI-UI)

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local HttpService = game:GetService("HttpService")
local LocalPlayer = Players.LocalPlayer

-- Bi·∫øn Tr·∫°ng Th√°i C·ªët L√µi
local stealthMode = true
local safeConnections = {}
local activeLoops = {}
local selectedEnemyNames = {}
local selectedGachaType = "Biju"
local selectedZone = "Zone 1"
local selectedStat = "Attack"
local autoOpenEggEnabled = false

-- NEW: Bi·∫øn theo d√µi tr·∫°ng th√°i c√°c toggle
-- NEW: Bi·∫øn theo d√µi tr·∫°ng th√°i c√°c toggle ƒë·ªÉ l∆∞u/t·∫£i
local selectedFarmEnabled = false
local autoAttackEnabled = false
local farmRandomEnabled = false
local autoCollectEnabled = false
local stealthModeEnabled = true
local antiAFKEnabled = true

-- Config file path
local configFile = "HimonoHubPurpleConfig.txt"

-- Safe remote fire
local function SafeFire(remote, ...)
    if stealthMode then RunService.Heartbeat:Wait() end
    remote:FireServer(...)
end

local function SafeWait()
    if not stealthMode then task.wait(); return end
    math.randomseed(tick())
    local delay = math.random(20, 50) / 100
    local start = tick()
    while tick() - start < delay do RunService.Heartbeat:Wait() end
end

local function SafeCall(func, ...)
    local success, result = pcall(func, ...)
    return success and result or nil
end

local function SafeConnect(signal, callback)
    local conn = signal:Connect(function(...)
        if stealthMode then SafeWait() end
        SafeCall(callback, ...)
    end)
    table.insert(safeConnections, conn)
    return conn
end

local function StartLoop(name, func, interval)
    if activeLoops[name] then activeLoops[name] = false; task.wait(0.1) end
    activeLoops[name] = true
    task.spawn(function()
        while activeLoops[name] do
            pcall(func)
            if interval then task.wait(interval) else RunService.Heartbeat:Wait() end
        end
    end)
end

local function StopLoop(name)
    if activeLoops[name] then activeLoops[name] = false end
end

local antiAFKConnection
local function EnableAntiAFK()
    if antiAFKConnection then antiAFKConnection:Disconnect() end
    antiAFKConnection = LocalPlayer.Idled:Connect(function()
        SafeCall(function()
            VirtualUser:CaptureController()
            VirtualUser:ClickButton2(Vector2.new())
        end)
    end)
end

local function DisableAntiAFK()
    if antiAFKConnection then
        antiAFKConnection:Disconnect()
        antiAFKConnection = nil
    end
end

-- SIMPLIFIED: Kh√¥ng l·ªçc NPC nh∆∞ phi√™n b·∫£n v√†ng
-- SIMPLIFIED: Kh√¥ng l·ªçc NPC
local function FindEnemiesInRange(range)
    local character = LocalPlayer.Character
    if not character or not character:FindFirstChild("HumanoidRootPart") then return {} end
    local enemies = {}
    local playerPos = character.HumanoidRootPart.Position
    for _, obj in pairs(workspace:GetDescendants()) do
        if obj:IsA("Model") and obj:FindFirstChild("Humanoid") and obj:FindFirstChild("Head") then
            local isPlayer = false
            for _, player in pairs(Players:GetPlayers()) do
                if player.Character == obj then isPlayer = true; break end
            end
            -- ƒê∆†N GI·∫¢N: Ch·ªâ ki·ªÉm tra kh√¥ng ph·∫£i player v√† c√≤n m√°u
            if not isPlayer and obj.Humanoid.Health > 0 then
                local distance = (playerPos - obj.Head.Position).Magnitude
                if distance <= (range or 100) then
                    table.insert(enemies, {
                        Model = obj,
                        Name = obj.Name,
                        Position = obj.Head.Position,
                        Distance = distance,
                        Health = obj.Humanoid.Health,
                        MaxHealth = obj.Humanoid.MaxHealth
                    })
                end
            end
        end
    end
    table.sort(enemies, function(a, b) return a.Distance < b.Distance end)
    return enemies
end

local function RefreshEnemiesList()
    return FindEnemiesInRange(100)
end

-- NEW: Group enemies by name (t√≠nh nƒÉng m·ªõi)
-- Group enemies by name
local function GetEnemyGroups()
    local enemies = FindEnemiesInRange(200)
    local groups = {}

    for _, enemy in ipairs(enemies) do
        if not groups[enemy.Name] then
            groups[enemy.Name] = {
                name = enemy.Name,
                count = 0,
                nearestDistance = math.huge
            }
        end

        groups[enemy.Name].count = groups[enemy.Name].count + 1
        if enemy.Distance < groups[enemy.Name].nearestDistance then
            groups[enemy.Name].nearestDistance = enemy.Distance
        end
    end

    return groups
end

-- Auto farm logic
local function AutoAttackLogic()
    local enemies = FindEnemiesInRange(50)
    if #enemies > 0 then
        local nearestEnemy = enemies[1]
        local character = LocalPlayer.Character
        if character and character:FindFirstChild("HumanoidRootPart") then
            character.HumanoidRootPart.CFrame = CFrame.new(nearestEnemy.Position + Vector3.new(0,2,0))
            local remote = ReplicatedStorage:FindFirstChild("RemoteEvent") or ReplicatedStorage:FindFirstChild("Remote")
            if remote then SafeFire(remote, "Attack", nearestEnemy.Model) end
        end
    end
end

-- IMPROVED: Farm V√≤ng L·∫∑p M·ª•c Ti√™u T·ªëc ƒê·ªô Cao (Target Rotation)
-- Auto farm logic (V√≤ng L·∫∑p M·ª•c Ti√™u T·ªëc ƒê·ªô Cao)
local function FarmSelectedLogic()
    if #selectedEnemyNames == 0 then return end

    local character = LocalPlayer.Character
    if not character or not character:FindFirstChild("HumanoidRootPart") then return end

    local enemies = FindEnemiesInRange(200) -- Ph·∫°m vi qu√©t r·ªông
    local targets = {}

    -- L·ªçc ra T·∫§T C·∫¢ c√°c k·∫ª ƒë·ªãch c√≥ t√™n ƒë√£ ch·ªçn
    for _, enemy in ipairs(enemies) do
        for _, selectedName in ipairs(selectedEnemyNames) do
            if enemy.Name == selectedName then
                table.insert(targets, enemy)
                break 
            end
        end
    end

    -- S·∫Øp x·∫øp danh s√°ch m·ª•c ti√™u theo kho·∫£ng c√°ch g·∫ßn nh·∫•t ƒë·ªÉ b·∫Øt ƒë·∫ßu v√≤ng l·∫∑p
    table.sort(targets, function(a, b) return a.Distance < b.Distance end)

    if #targets == 0 then return end

    -- T·∫•n c√¥ng t·ª´ng m·ª•c ti√™u theo th·ª© t·ª±
    for _, target in ipairs(targets) do
        if not activeLoops["FarmSelected"] then break end 

        -- Ch·ªâ t·∫•n c√¥ng n·∫øu m·ª•c ti√™u c√≤n t·ªìn t·∫°i v√† c√≤n m√°u
        if target.Model and target.Model:FindFirstChild("Humanoid") and target.Model.Humanoid.Health > 0 then

            -- Teleport ƒë·∫øn m·ª•c ti√™u (s·ª≠ d·ª•ng offset ng·∫´u nhi√™n nh·∫π)
            local offset = Vector3.new(
                math.random(-10, 10) / 10, -- Offset ng·∫´u nhi√™n nh·ªè
                math.random(-10, 10) / 10,
                3,
                math.random(-10, 10) / 10
            )
            character.HumanoidRootPart.CFrame = CFrame.new(target.Position + offset)

            local remote = ReplicatedStorage:FindFirstChild("RemoteEvent") or ReplicatedStorage:FindFirstChild("Remote")
            if remote then 
                -- T·∫•n c√¥ng nhanh (burst attack)
                SafeFire(remote, "Attack", target.Model)
                task.wait(0.05) -- ƒê·ªô tr·ªÖ r·∫•t nh·ªè gi·ªØa c√°c l·∫ßn t·∫•n c√¥ng
                task.wait(0.05)
                SafeFire(remote, "Attack", target.Model)
            end
        end

        -- ƒê·ªô tr·ªÖ ng·∫Øn tr∆∞·ªõc khi chuy·ªÉn sang m·ª•c ti√™u ti·∫øp theo trong danh s√°ch
        -- ƒê·ªô tr·ªÖ ng·∫Øn tr∆∞·ªõc khi chuy·ªÉn sang m·ª•c ti√™u ti·∫øp theo
        task.wait(0.1) 
    end
end

-- Auto farm logic
local function AutoAttackLogic()
    local enemies = FindEnemiesInRange(50)
    if #enemies > 0 then
        local nearestEnemy = enemies[1]
        local character = LocalPlayer.Character
        if character and character:FindFirstChild("HumanoidRootPart") then
            character.HumanoidRootPart.CFrame = CFrame.new(nearestEnemy.Position + Vector3.new(0,2,0))
            local remote = ReplicatedStorage:FindFirstChild("RemoteEvent") or ReplicatedStorage:FindFirstChild("Remote")
            if remote then SafeFire(remote, "Attack", nearestEnemy.Model) end
        end
    end
end

local function FarmRandomLogic()
    local enemies = FindEnemiesInRange(50)
    if #enemies > 0 then
        local randomEnemy = enemies[math.random(1, #enemies)]
        local character = LocalPlayer.Character
        if character and character:FindFirstChild("HumanoidRootPart") then
            character.HumanoidRootPart.CFrame = CFrame.new(randomEnemy.Position + Vector3.new(0,2,0))
            local remote = ReplicatedStorage:FindFirstChild("RemoteEvent") or ReplicatedStorage:FindFirstChild("Remote")
            if remote then SafeFire(remote, "Attack", randomEnemy.Model) end
        end
    end
end

local function AutoCollectLogic()
    local character = LocalPlayer.Character
    if not character then return end
    for _, obj in pairs(workspace:GetDescendants()) do
        if obj:IsA("Part") and (obj.Name:lower():find("drop") or obj.Name:lower():find("coin") or obj.Name:lower():find("reward")) then
            local distance = (character.HumanoidRootPart.Position - obj.Position).Magnitude
            if distance < 20 then
                local remote = ReplicatedStorage:FindFirstChild("RemoteEvent") or ReplicatedStorage:FindFirstChild("Remote")
                if remote then SafeFire(remote, "Collect", obj) end
            end
        end
    end
end

-- C√°c h√†m c∆° b·∫£n (Gacha, Teleport, Stats)
local function StartGacha(gachaType)
    local remote = ReplicatedStorage:FindFirstChild("Reply") and ReplicatedStorage.Reply:FindFirstChild("Reliable")
    if remote then
        SafeFire(remote, "Crate Roll Start", {[1]=gachaType,[2]=true})
        task.wait(1)
        SafeFire(remote, "Crate Roll Stop")
    end
end

local function TeleportToZone(zoneName)
    local remote = ReplicatedStorage:FindFirstChild("Reply") and ReplicatedStorage.Reply:FindFirstChild("Reliable")
    if remote then
        SafeFire(remote, "Zone Teleport", {[1]=zoneName})
    end
end

local function DistributeStat(statName)
    local remote = ReplicatedStorage:FindFirstChild("Reply") and ReplicatedStorage.Reply:FindFirstChild("Reliable")
    if remote then
        SafeFire(remote, "Distribute Stat Point", {[1]=statName})
    end
end

-- FIXED: Auto Open Egg v·ªõi logic ki·ªÉm tra kho·∫£ng c√°ch
-- Auto Open Egg v·ªõi logic ki·ªÉm tra kho·∫£ng c√°ch
local function AutoOpenEggLogic()
    local character = LocalPlayer.Character
    if not character or not character:FindFirstChild("HumanoidRootPart") then return end

    -- Ch·ªâ m·ªü egg khi g·∫ßn (15m)
    for _, obj in pairs(workspace:GetDescendants()) do
        if obj:IsA("Model") and (obj.Name:lower():find("egg") or obj.Name:lower():find("crate")) then
            local distance = (character.HumanoidRootPart.Position - obj:GetPivot().Position).Magnitude
            if distance < 15 then
                local remote = ReplicatedStorage:FindFirstChild("Reply") and ReplicatedStorage.Reply:FindFirstChild("Reliable")
                if remote then
                    SafeFire(remote, "Open Star", {[1]="Egg"})
                end
                break
            end
        end
    end
end

-- FIXED: Th√™m h√†m Save/Load Config v·ªõi t·∫•t c·∫£ tr·∫°ng th√°i
-- Save/Load Config
local function SaveConfig()
    local data = {
        selectedEnemyNames = selectedEnemyNames,
        selectedGachaType = selectedGachaType,
        selectedZone = selectedZone,
        selectedStat = selectedStat,
        autoOpenEggEnabled = autoOpenEggEnabled,
        stealthMode = stealthMode,
        
        -- NEW: L∆∞u t·∫•t c·∫£ tr·∫°ng th√°i toggle
        selectedFarmEnabled = activeLoops["FarmSelected"] or false,
        autoAttackEnabled = activeLoops["AutoAttack"] or false,
        farmRandomEnabled = activeLoops["FarmRandom"] or false,
        autoCollectEnabled = activeLoops["AutoCollect"] or false,
        stealthModeEnabled = stealthMode,
        antiAFKEnabled = antiAFKEnabled
    }
    local encoded = HttpService:JSONEncode(data)
    writefile(configFile, encoded)
end

local function LoadConfig()
    if isfile(configFile) then
        local success, data = pcall(function()
            local encoded = readfile(configFile)
            return HttpService:JSONDecode(encoded)
        end)
        if success and data then
            selectedEnemyNames = data.selectedEnemyNames or {}
            selectedGachaType = data.selectedGachaType or "Biju"
            selectedZone = data.selectedZone or "Zone 1"
            selectedStat = data.selectedStat or "Attack"
            autoOpenEggEnabled = data.autoOpenEggEnabled or false
            stealthMode = data.stealthMode or true

            -- NEW: T·∫£i t·∫•t c·∫£ tr·∫°ng th√°i toggle
            selectedFarmEnabled = data.selectedFarmEnabled or false
            autoAttackEnabled = data.autoAttackEnabled or false
            farmRandomEnabled = data.farmRandomEnabled or false
            autoCollectEnabled = data.autoCollectEnabled or false
            stealthModeEnabled = data.stealthModeEnabled or true
            antiAFKEnabled = data.antiAFKEnabled or true
        end
    end
end

local function DeleteConfig()
    if isfile(configFile) then
        delfile(configFile)
    end
end

-- GUI Creation v·ªõi m√†u T√çM
-- GUI Initialization
local HimonoHub = Instance.new("ScreenGui")
HimonoHub.Name = "HimonoHubPurple"
HimonoHub.ResetOnSpawn = false
HimonoHub.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
HimonoHub.Parent = game.CoreGui
HimonoHub.Enabled = true -- M·∫∑c ƒë·ªãnh hi·ªán

-- MINI UI (N√∫t Neo)
local HimonoMini = Instance.new("ScreenGui")
HimonoMini.Name = "HimonoHubMini"
HimonoMini.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
HimonoMini.Enabled = false -- M·∫∑c ƒë·ªãnh ·∫©n
HimonoMini.Parent = game.CoreGui

-- H√ÄM ·∫®N/HI·ªÜN (Global Toggle)
local function ToggleUI(showMain)
    if showMain then
        -- Hi·ªán UI Ch√≠nh, ·∫®n UI Mini
        HimonoHub.Enabled = true
        HimonoMini.Enabled = false
    else
        -- ·∫®n UI Ch√≠nh, Hi·ªán UI Mini
        HimonoHub.Enabled = false
        HimonoMini.Enabled = true
    end
end

local MiniButton = Instance.new("TextButton")
MiniButton.Size = UDim2.new(0, 40, 0, 40)
MiniButton.Position = UDim2.new(1, -50, 0, 50) -- G√≥c tr√™n b√™n ph·∫£i
MiniButton.BackgroundColor3 = Color3.fromRGB(120, 0, 200) -- Purple
MiniButton.Text = "üü£"
MiniButton.TextColor3 = Color3.fromRGB(255, 255, 255)
MiniButton.Font = Enum.Font.GothamBold
MiniButton.TextSize = 24
MiniButton.Parent = HimonoMini

local MiniCorner = Instance.new("UICorner")
MiniCorner.CornerRadius = UDim.new(1, 0)
MiniCorner.Parent = MiniButton

SafeConnect(MiniButton.MouseButton1Click, function()
    ToggleUI(true)
end)

-- T·∫°o Main Container
local MainContainer = Instance.new("Frame")
MainContainer.Size = UDim2.new(0, 600, 0, 500)
MainContainer.Position = UDim2.new(0.5, -300, 0.5, -250)
MainContainer.BackgroundColor3 = Color3.fromRGB(120, 0, 200) -- Purple
MainContainer.BackgroundColor3 = Color3.fromRGB(120, 0, 200) 
MainContainer.BorderSizePixel = 0
MainContainer.Parent = HimonoHub

local ContainerCorner = Instance.new("UICorner")
ContainerCorner.CornerRadius = UDim.new(0, 12)
ContainerCorner.Parent = MainContainer

local TitleBar = Instance.new("Frame")
TitleBar.Size = UDim2.new(1, 0, 0, 45)
TitleBar.BackgroundColor3 = Color3.fromRGB(80, 0, 160) -- Dark Purple
TitleBar.BackgroundColor3 = Color3.fromRGB(80, 0, 160) 
TitleBar.Parent = MainContainer

local TitleCorner = Instance.new("UICorner")
TitleCorner.CornerRadius = UDim.new(0, 12)
TitleCorner.Parent = TitleBar

local Title = Instance.new("TextLabel")
Title.Size = UDim2.new(1, -100, 1, 0)
Title.BackgroundTransparency = 1
Title.Text = "üü£ HIMONO HUB v4.2 - AUTO LOAD FIXED"
Title.TextColor3 = Color3.fromRGB(255, 255, 255)
Title.Font = Enum.Font.GothamBold
Title.TextSize = 18
Title.Parent = TitleBar

-- Stealth Indicator
local StealthIndicator = Instance.new("Frame")
StealthIndicator.Size = UDim2.new(0, 12, 0, 12)
StealthIndicator.Position = UDim2.new(1, -90, 0.5, -6)
StealthIndicator.BackgroundColor3 = stealthMode and Color3.fromRGB(0, 255, 0) or Color3.fromRGB(255, 0, 0)
StealthIndicator.Parent = TitleBar

local StealthCorner = Instance.new("UICorner")
StealthCorner.CornerRadius = UDim.new(1, 0)
StealthCorner.Parent = StealthIndicator

local StealthLabel = Instance.new("TextLabel")
StealthLabel.Size = UDim2.new(0, 80, 1, 0)
StealthLabel.Position = UDim2.new(1, -80, 0, 0)
StealthLabel.BackgroundTransparency = 1
StealthLabel.Text = stealthMode and "STEALTH: ON" or "STEALTH: OFF"
StealthLabel.TextColor3 = stealthMode and Color3.fromRGB(0, 255, 0) or Color3.fromRGB(255, 0, 0)
StealthLabel.Font = Enum.Font.Gotham
StealthLabel.TextSize = 11
StealthLabel.Parent = TitleBar

-- NEW: N√∫t ·∫®n UI (tr√™n TitleBar c·ªßa UI ch√≠nh)
local HideButton = Instance.new("TextButton")
HideButton.Name = "HideButton"
HideButton.Size = UDim2.new(0, 30, 0, 30)
HideButton.Position = UDim2.new(1, -35, 0.5, -15)
HideButton.BackgroundColor3 = Color3.fromRGB(160, 0, 255)
HideButton.Text = "‚ûñ" 
HideButton.TextColor3 = Color3.fromRGB(255, 255, 255)
HideButton.Font = Enum.Font.GothamBold
HideButton.TextSize = 18
HideButton.Parent = TitleBar

local HideCorner = Instance.new("UICorner")
HideCorner.CornerRadius = UDim.new(0, 6)
HideCorner.Parent = HideButton

SafeConnect(HideButton.MouseButton1Click, function()
    ToggleUI(false)
end)


local TabContainer = Instance.new("ScrollingFrame")
TabContainer.Size = UDim2.new(1, -20, 0, 40)
TabContainer.Position = UDim2.new(0, 10, 0, 55)
TabContainer.BackgroundTransparency = 1
TabContainer.ScrollBarThickness = 3
TabContainer.ScrollBarImageColor3 = Color3.fromRGB(160, 0, 255)
TabContainer.CanvasSize = UDim2.new(2, 0, 0, 0)
TabContainer.Parent = MainContainer

local TabListLayout = Instance.new("UIListLayout")
TabListLayout.FillDirection = Enum.FillDirection.Horizontal
TabListLayout.Padding = UDim.new(0, 8)
TabListLayout.Parent = TabContainer

local ContentContainer = Instance.new("Frame")
ContentContainer.Size = UDim2.new(1, -20, 1, -120)
ContentContainer.Position = UDim2.new(0, 10, 0, 105)
ContentContainer.BackgroundColor3 = Color3.fromRGB(200, 150, 255) -- Light Purple
ContentContainer.BackgroundColor3 = Color3.fromRGB(200, 150, 255) 
ContentContainer.Parent = MainContainer

local ContentCorner = Instance.new("UICorner")
ContentCorner.CornerRadius = UDim.new(0, 8)
ContentCorner.Parent = ContentContainer

local ContentScroll = Instance.new("ScrollingFrame")
ContentScroll.Size = UDim2.new(1, 0, 1, 0)
ContentScroll.BackgroundTransparency = 1
ContentScroll.ScrollBarThickness = 5
ContentScroll.ScrollBarImageColor3 = Color3.fromRGB(160, 0, 255)
ContentScroll.CanvasSize = UDim2.new(0, 0, 2, 0)
ContentScroll.Parent = ContentContainer

local ContentLayout = Instance.new("UIListLayout")
ContentLayout.Padding = UDim.new(0, 15)
ContentLayout.Parent = ContentScroll

-- UPDATED: Ch·ªâ gi·ªØ c√°c tab ch√≠nh
local tabs = {
    "üè† MAIN", "üåæ FARM", "üé∞ GACHA", "‚ö° STATS", 
    "üöÄ TELEPORT", "ü•ö OPEN EGG", "‚öôÔ∏è SETTINGS"
}
local tabFrames, tabButtons = {}, {}

for i, tabName in pairs(tabs) do
    local tabButton = Instance.new("TextButton")
    tabButton.Size = UDim2.new(0, 120, 1, 0)
    tabButton.BackgroundColor3 = i == 1 and Color3.fromRGB(200, 100, 255) or Color3.fromRGB(120, 0, 200)
    tabButton.Text = tabName
    tabButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    tabButton.Font = Enum.Font.GothamBold
    tabButton.TextSize = 12
    tabButton.Parent = TabContainer

    local tabButtonCorner = Instance.new("UICorner")
    tabButtonCorner.CornerRadius = UDim.new(0, 6)
    tabButtonCorner.Parent = tabButton

    local contentFrame = Instance.new("ScrollingFrame")
    contentFrame.Size = UDim2.new(1, 0, 1, 0)
    contentFrame.BackgroundTransparency = 1
    contentFrame.ScrollBarThickness = 5
    contentFrame.ScrollBarImageColor3 = Color3.fromRGB(160, 0, 255)
    contentFrame.CanvasSize = UDim2.new(0, 0, 2, 0)
    contentFrame.Visible = i == 1
    contentFrame.Parent = ContentScroll

    local contentFrameLayout = Instance.new("UIListLayout")
    contentFrameLayout.Padding = UDim.new(0, 10)
    contentFrameLayout.Parent = contentFrame

    tabFrames[tabName] = contentFrame
    tabButtons[tabName] = tabButton

    SafeConnect(tabButton.MouseButton1Click, function()
        for name, frame in pairs(tabFrames) do
            frame.Visible = (name == tabName)
        end
        for name, btn in pairs(tabButtons) do
            btn.BackgroundColor3 = (name == tabName) and Color3.fromRGB(200, 100, 255) or Color3.fromRGB(120, 0, 200)
        end
    end)
end

-- NEW: H√†m c·∫≠p nh·∫≠t toggle button
local function UpdateToggleButton(toggleFrame, enabled)
    local toggleBtn = toggleFrame:FindFirstChildOfClass("TextButton")
    if toggleBtn then
        toggleBtn.Text = enabled and "ON" or "OFF"
        toggleBtn.BackgroundColor3 = enabled and Color3.fromRGB(0, 200, 0) or Color3.fromRGB(200, 0, 0)
    end
end

function CreateToggleSwitch(text, description, default, callback)
    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(1, 0, 0, 50)
    frame.BackgroundTransparency = 1

    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(0.7, 0, 0.5, 0)
    label.Position = UDim2.new(0, 10, 0, 5)
    label.BackgroundTransparency = 1
    label.Text = text
    label.TextColor3 = Color3.fromRGB(255, 255, 255)
@@ -641,91 +699,90 @@
    return frame
end

-- MAIN TAB
local mainContent = tabFrames["üè† MAIN"]
local mainStatus = Instance.new("TextLabel")
mainStatus.Size = UDim2.new(1, -20, 0, 30)
mainStatus.BackgroundTransparency = 1
mainStatus.Text = "üü£ AUTO-LOAD FIXED - T·∫•t c·∫£ n√∫t ƒë·ªÅu nh·ªõ tr·∫°ng th√°i!"
mainStatus.TextColor3 = Color3.fromRGB(255, 255, 255)
mainStatus.Font = Enum.Font.Gotham
mainStatus.TextSize = 14
mainStatus.Parent = mainContent

-- Bi·∫øn l∆∞u c√°c toggle ƒë·ªÉ c√≥ th·ªÉ c·∫≠p nh·∫≠t sau
local autoAttackToggleFrame, autoFarmSelectedToggleFrame, autoFarmRandomToggleFrame, autoDropsToggleFrame
local stealthToggleFrame, antiAfkToggleFrame, autoOpenEggToggleFrame

autoAttackToggleFrame = CreateToggleSwitch("Enable Auto Attack", "T·ª± ƒë·ªông t·∫•n c√¥ng k·∫ª ƒë·ªãch g·∫ßn nh·∫•t", false, function(enabled)
    autoAttackEnabled = enabled
    if enabled then StartLoop("AutoAttack", AutoAttackLogic, 0.3) else StopLoop("AutoAttack") end
end)
autoAttackToggleFrame.Parent = mainContent

autoFarmSelectedToggleFrame = CreateToggleSwitch("Enable Auto Farm Selected Enemies", "T·ª± ƒë·ªông farm T·∫§T C·∫¢ enemy c√πng t√™n (SPEED: 0.1s)", false, function(enabled)
    selectedFarmEnabled = enabled
    if enabled then StartLoop("FarmSelected", FarmSelectedLogic, 0.1) else StopLoop("FarmSelected") end 
end)
autoFarmSelectedToggleFrame.Parent = mainContent

autoFarmRandomToggleFrame = CreateToggleSwitch("Enable Farm Random Enemies", "T·ª± ƒë·ªông farm ng·∫´u nhi√™n", false, function(enabled)
    farmRandomEnabled = enabled
    if enabled then StartLoop("FarmRandom", FarmRandomLogic, 0.5) else StopLoop("FarmRandom") end
end)
autoFarmRandomToggleFrame.Parent = mainContent

autoDropsToggleFrame = CreateToggleSwitch("Enable Auto Collect All Drops", "T·ª± ƒë·ªông nh·∫∑t v·∫≠t ph·∫©m quanh b·∫°n", false, function(enabled)
    autoCollectEnabled = enabled
    if enabled then StartLoop("AutoCollect", AutoCollectLogic, 1.0) else StopLoop("AutoCollect") end
end)
autoDropsToggleFrame.Parent = mainContent

-- FARM TAB
local farmContent = tabFrames["üåæ FARM"]

-- NEW: Refresh enemy groups display
local refreshGroupsBtn = CreateActionButton("Refresh Enemy Groups", "Qu√©t v√† hi·ªÉn th·ªã enemy theo nh√≥m", function()
    for _, child in pairs(farmContent:GetChildren()) do
        if child:IsA("Frame") and string.find(child.Name or "", "GroupFrame") then
            child:Destroy()
        end
    end

    local enemyGroups = GetEnemyGroups()

    for enemyName, group in pairs(enemyGroups) do
        local groupFrame = Instance.new("Frame")
        groupFrame.Name = "GroupFrame_" .. enemyName
        groupFrame.Size = UDim2.new(1, 0, 0, 60)
        groupFrame.BackgroundColor3 = Color3.fromRGB(180, 120, 255)
        groupFrame.Parent = farmContent

        local cornerRadius = Instance.new("UICorner")
        cornerRadius.CornerRadius = UDim.new(0, 6)
        cornerRadius.Parent = groupFrame

        local nameLabel = Instance.new("TextLabel")
        nameLabel.Size = UDim2.new(0.6, 0, 0.5, 0)
        nameLabel.Position = UDim2.new(0, 10, 0, 5)
        nameLabel.BackgroundTransparency = 1
        nameLabel.Text = "üëπ " .. enemyName
        nameLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
        nameLabel.Font = Enum.Font.GothamBold
        nameLabel.TextSize = 14
        nameLabel.TextXAlignment = Enum.TextXAlignment.Left
        nameLabel.Parent = groupFrame

        local infoLabel = Instance.new("TextLabel")
        infoLabel.Size = UDim2.new(0.6, 0, 0.5, 0)
        infoLabel.Position = UDim2.new(0, 10, 0.5, 0)
        infoLabel.BackgroundTransparency = 1
        infoLabel.Text = "üìä S·ªë l∆∞·ª£ng: " .. group.count .. " | Kho·∫£ng c√°ch: " .. math.floor(group.nearestDistance) .. "m"
        infoLabel.TextColor3 = Color3.fromRGB(230, 230, 255)
        infoLabel.Font = Enum.Font.Gotham
        infoLabel.TextSize = 11
        infoLabel.TextXAlignment = Enum.TextXAlignment.Left
        infoLabel.Parent = groupFrame

        local selectBtn = Instance.new("TextButton")
        selectBtn.Size = UDim2.new(0.3, 0, 0.6, 0)
        selectBtn.Position = UDim2.new(0.65, 0, 0.2, 0)
@@ -805,168 +862,171 @@

for _, gacha in ipairs(gachaTypes) do
    local toggle = CreateToggleSwitch("Enable Auto Roll " .. gacha, "T·ª± ƒë·ªông roll " .. gacha, false, function(enabled)
        if enabled then
            StartLoop("AutoRoll"..gacha, function() StartGacha(gacha) end, 2)
        else
            StopLoop("AutoRoll"..gacha)
        end
    end)
    toggle.Parent = gachaContent
end

-- STATS TAB
local statsContent = tabFrames["‚ö° STATS"]
local statTypes = {"Attack", "Mastery", "Speed", "Luck"}
local statCombo = CreateComboBox("Stat Type", "Ch·ªçn lo·∫°i stat ƒë·ªÉ c·ªông", statTypes, function(selected)
    selectedStat = selected
end)
statCombo.Parent = statsContent

local distributeBtn = CreateActionButton("Distribute Stat Point", "C·ªông ƒëi·ªÉm stat ƒë√£ ch·ªçn", function()
    DistributeStat(selectedStat)
end)
distributeBtn.Parent = statsContent

-- TELEPORT TAB
local teleportContent = tabFrames["üöÄ TELEPORT"]
local zoneList = {"Zone 1", "Zone 2", "Zone 3", "Zone 4"}
local zoneCombo = CreateComboBox("Zone", "Ch·ªçn khu v·ª±c ƒë·ªÉ teleport", zoneList, function(selected)
    selectedZone = selected
end)
zoneCombo.Parent = teleportContent

local teleportBtn = CreateActionButton("Teleport", "Di chuy·ªÉn ƒë·∫øn khu v·ª±c ƒë√£ ch·ªçn", function()
    TeleportToZone(selectedZone)
end)
teleportBtn.Parent = teleportContent

-- OPEN EGG TAB
local eggContent = tabFrames["ü•ö OPEN EGG"]
local openEggBtn = CreateActionButton("Open Egg", "M·ªü egg g·∫ßn b·∫°n", function()
    AutoOpenEggLogic()
end)
openEggBtn.Parent = eggContent

-- FIXED: Auto Open Egg v·ªõi logic ki·ªÉm tra kho·∫£ng c√°ch
autoOpenEggToggleFrame = CreateToggleSwitch("Enable Auto Open Egg", "T·ª± ƒë·ªông m·ªü egg khi g·∫ßn (15m)", false, function(enabled)
    autoOpenEggEnabled = enabled
    if enabled then
        StartLoop("AutoOpenEgg", AutoOpenEggLogic, 2)
    else
        StopLoop("AutoOpenEgg")
    end
end)
autoOpenEggToggleFrame.Parent = eggContent

-- SETTINGS TAB
local settingsContent = tabFrames["‚öôÔ∏è SETTINGS"]
antiAfkToggleFrame = CreateToggleSwitch("Enable Anti-AFK", "Ch·ªëng kick khi AFK", true, function(enabled)
    antiAFKEnabled = enabled
    if enabled then EnableAntiAFK() else DisableAntiAFK() end
end)
antiAfkToggleFrame.Parent = settingsContent

stealthToggleFrame = CreateToggleSwitch("Enable Stealth Mode", "·∫®n ho·∫°t ƒë·ªông kh·ªèi server", true, function(enabled)
    stealthMode = enabled
    stealthModeEnabled = enabled
    StealthIndicator.BackgroundColor3 = enabled and Color3.fromRGB(0, 255, 0) or Color3.fromRGB(255, 0, 0)
    StealthLabel.Text = enabled and "STEALTH: ON" or "STEALTH: OFF"
    StealthLabel.TextColor3 = enabled and Color3.fromRGB(0, 255, 0) or Color3.fromRGB(255, 0, 0)
end)
stealthToggleFrame.Parent = settingsContent

-- FIXED: Th√™m n√∫t Config v√†o SETTINGS
-- Th√™m n√∫t Config v√†o SETTINGS
local saveConfigBtn = CreateActionButton("Save Config", "L∆∞u l·∫°i c·∫•u h√¨nh hi·ªán t·∫°i", function()
    SaveConfig()
    mainStatus.Text = "üíæ ƒê√£ l∆∞u c·∫•u h√¨nh!"
end)
saveConfigBtn.Parent = settingsContent

local loadConfigBtn = CreateActionButton("Load Config", "T·∫£i l·∫°i c·∫•u h√¨nh ƒë√£ l∆∞u", function()
    LoadConfig()
    ApplyLoadedConfig()
    mainStatus.Text = "üìÇ ƒê√£ t·∫£i c·∫•u h√¨nh!"
end)
loadConfigBtn.Parent = settingsContent

local deleteConfigBtn = CreateActionButton("Delete Config", "X√≥a file config ƒë√£ l∆∞u", function()
    DeleteConfig()
    mainStatus.Text = "üóëÔ∏è ƒê√£ x√≥a c·∫•u h√¨nh!"
end)
deleteConfigBtn.Parent = settingsContent

-- NEW: H√†m √°p d·ª•ng config ƒë√£ load
local function ApplyLoadedConfig()
    -- C·∫≠p nh·∫≠t t·∫•t c·∫£ c√°c n√∫t toggle
    UpdateToggleButton(autoAttackToggleFrame, autoAttackEnabled)
    UpdateToggleButton(autoFarmSelectedToggleFrame, selectedFarmEnabled)
    UpdateToggleButton(autoFarmRandomToggleFrame, farmRandomEnabled)
    UpdateToggleButton(autoDropsToggleFrame, autoCollectEnabled)
    UpdateToggleButton(stealthToggleFrame, stealthModeEnabled)
    UpdateToggleButton(antiAfkToggleFrame, antiAFKEnabled)
    UpdateToggleButton(autoOpenEggToggleFrame, autoOpenEggEnabled)

    -- C·∫≠p nh·∫≠t stealth indicator
    StealthIndicator.BackgroundColor3 = stealthMode and Color3.fromRGB(0, 255, 0) or Color3.fromRGB(255, 0, 0)
    StealthLabel.Text = stealthMode and "STEALTH: ON" or "STEALTH: OFF"
    StealthLabel.TextColor3 = stealthMode and Color3.fromRGB(0, 255, 0) or Color3.fromRGB(255, 0, 0)

    -- K√≠ch ho·∫°t c√°c v√≤ng l·∫∑p n·∫øu c·∫ßn
    if autoAttackEnabled then StartLoop("AutoAttack", AutoAttackLogic, 0.3) end
    if selectedFarmEnabled then StartLoop("FarmSelected", FarmSelectedLogic, 0.1) end
    if farmRandomEnabled then StartLoop("FarmRandom", FarmRandomLogic, 0.5) end
    if autoCollectEnabled then StartLoop("AutoCollect", AutoCollectLogic, 1.0) end
    if autoOpenEggEnabled then StartLoop("AutoOpenEgg", AutoOpenEggLogic, 2) end
    if antiAFKEnabled then EnableAntiAFK() else DisableAntiAFK() end

    -- Refresh farm display n·∫øu ƒëang ·ªü tab FARM
    if farmContent.Visible then
    if tabFrames["üåæ FARM"].Visible then
        refreshGroupsBtn.MouseButton1Click:Fire()
    end
end

-- DRAG FUNCTIONALITY
local dragging, dragInput, dragStart, startPos
SafeConnect(TitleBar.InputBegan, function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = true
        dragStart = input.Position
        startPos = MainContainer.Position
    end
end)
SafeConnect(TitleBar.InputChanged, function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement then
        dragInput = input
    end
end)
SafeConnect(TitleBar.InputEnded, function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = false
    end
end)
SafeConnect(UserInputService.InputChanged, function(input)
    if input == dragInput and dragging then
        local delta = input.Position - dragStart
        MainContainer.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
    end
end)

-- NEW: Ph√≠m t·∫Øt Insert ƒë·ªÉ ·∫©n/hi·ªán UI
SafeConnect(UserInputService.InputBegan, function(input, gameProcessedEvent)
    if input.KeyCode == Enum.KeyCode.Insert and not gameProcessedEvent then
        ToggleUI(not HimonoHub.Enabled)
    end
end)

-- Auto-adjust canvas sizes
task.spawn(function()
    while true do
        for _, frame in pairs(tabFrames) do
            frame.CanvasSize = UDim2.new(0, 0, 0, frame.UIListLayout.AbsoluteContentSize.Y + 20)
        end
        TabContainer.CanvasSize = UDim2.new(0, TabListLayout.AbsoluteContentSize.X + 20, 0, 0)
        task.wait(0.5)
    end
end)

-- Initialize
LoadConfig() -- T·∫£i config tr∆∞·ªõc
ApplyLoadedConfig() -- √Åp d·ª•ng config ƒë√£ load
LoadConfig() 
ApplyLoadedConfig()

print("üü£ HIMONO HUB v4.2 - AUTO LOAD FIXED EDITION LOADED!")
print("‚úÖ T·∫§T C·∫¢ n√∫t toggle ƒë·ªÅu nh·ªõ tr·∫°ng th√°i khi load l·∫°i!")
print("‚ö° T·ªëc ƒë·ªô farm: 0.1s - Target Rotation Mode")
print("üíæ Config system ho√†n ch·ªânh")
print("üü£ HIMONO HUB v4.2 - FULLY LOADED!")
