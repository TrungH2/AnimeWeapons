-- Himono Hub v4.7 - PURPLE EDITION (FIXED VERSION)

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local LocalPlayer = Players.LocalPlayer

-- ===================================================================
-- I. CONFIGURATION
-- ===================================================================

local Config = {
    StealthMode = true,
    AttackRange = 50, 
    CollectRange = 20, 
    EnemyRefreshRate = 0.5,
    FarmInterval = 0.1,
    TeleportCooldown = 2,
    MaxCollectPerFrame = 10,
    Zones = {
        ["Shinobi Village"] = "Naruto",
        ["Namek Planet"] = "DragonBall", 
        ["Desert Land"] = "OnePiece",
        ["Demon Land"] = "DemonSlayer",
        ["Dungeon Easy"] = "Dungeon:1",
        ["Zone 1"] = "Zone 1", 
        ["Zone 2"] = "Zone 2", 
        ["Zone 3"] = "Zone 3", 
        ["Zone 4"] = "Zone 4", 
    },
    StatTypes = {"Damage", "Mastery", "Luck", "Yen"},
    GachaTypes = {"Biju", "Race", "Sayajin", "Haki", "Fruits"},
}

local sortedZoneKeys = {}
for key, _ in pairs(Config.Zones) do table.insert(sortedZoneKeys, key) end
table.sort(sortedZoneKeys)

-- ===================================================================
-- II. STATE VARIABLES
-- ===================================================================

local stealthMode = Config.StealthMode
local safeConnections = {}
local activeLoops = {}
local selectedEnemyNames = {} 
local selectedGachaType = Config.GachaTypes[1] or "Biju"
local selectedStat = Config.StatTypes[1] or "Damage"
local selectedZone = sortedZoneKeys[1] or "Zone 1"
local lastTeleportTime = 0 
local HimonoHub, HimonoMini 
local TitleBar, MainContainer, MiniButton

-- ===================================================================
-- III. CORE UTILITIES (FIXED)
-- ===================================================================

local function GetReplyRemote()
    for _, name in pairs({"Reply", "ReplicatedStorage", "MainRemote"}) do
        local remote = ReplicatedStorage:FindFirstChild(name)
        if remote then
            local reliable = remote:FindFirstChild("Reliable")
            if reliable then return reliable end
            return remote
        end
    end
    return nil
end

local function GetAttackRemote()
    for _, name in pairs({"RemoteEvent", "AttackRemote", "CombatRemote", "Remote"}) do
        local remote = ReplicatedStorage:FindFirstChild(name)
        if remote and (remote:IsA("RemoteEvent") or remote:IsA("RemoteFunction")) then
            return remote
        end
    end
    return nil
end

local function SafeFire(remote, ...)
    if remote and (remote:IsA("RemoteEvent") or remote:IsA("RemoteFunction")) then
        if stealthMode then 
            wait(0.1)
        end
        pcall(function()
            remote:FireServer(...)
        end)
    end
end

local function SafeWait()
    if not stealthMode then 
        wait() 
        return 
    end
    local delay = math.random(20, 50) / 100
    wait(delay)
end

local function SafeCall(func, ...)
    local success, result = pcall(func, ...)
    if not success then
        warn("SafeCall Error:", result)
    end
    return success
end

local function SafeConnect(signal, callback)
    local conn = signal:Connect(function(...)
        if stealthMode then SafeWait() end
        SafeCall(callback, ...)
    end)
    table.insert(safeConnections, conn)
    return conn
end

local function StartLoop(name, func, interval)
    if activeLoops[name] then 
        activeLoops[name] = false
        wait(0.1)
    end
    activeLoops[name] = true
    spawn(function()
        while activeLoops[name] do
            local success = SafeCall(func)
            if not success then
                warn("Loop ["..name.."] encountered an error")
            end
            if interval then 
                wait(interval) 
            else 
                wait(0.1)
            end
        end
    end)
end

local function StopLoop(name)
    if activeLoops[name] then 
        activeLoops[name] = false 
    end
end

-- ===================================================================
-- IV. GAME LOGIC IMPLEMENTATION (FIXED)
-- ===================================================================

local function ValidatePlayerState()
    local character = LocalPlayer.Character
    if not character then return false end
    local humanoid = character:FindFirstChild("Humanoid")
    return humanoid and humanoid.Health > 0
end

local function EnableAntiAFK()
    local VirtualUser = game:GetService("VirtualUser")
    LocalPlayer.Idled:Connect(function()
        SafeCall(function()
            VirtualUser:CaptureController()
            VirtualUser:ClickButton2(Vector2.new())
        end)
    end)
end

local function FindEnemiesInRange(range)
    local enemies = {}
    local character = LocalPlayer.Character
    if not character then return enemies end
    
    local root = character:FindFirstChild("HumanoidRootPart")
    if not root then return enemies end
    
    local playerPos = root.Position

    for _, obj in pairs(workspace:GetChildren()) do
        if obj:IsA("Model") and obj:FindFirstChild("Humanoid") and obj.Humanoid.Health > 0 then
            local head = obj:FindFirstChild("Head")
            if head then
                local isPlayer = false
                for _, player in pairs(Players:GetPlayers()) do
                    if player.Character == obj then 
                        isPlayer = true
                        break 
                    end
                end
                if not isPlayer then
                    local distance = (playerPos - head.Position).Magnitude
                    if distance <= (range or Config.AttackRange) then
                        table.insert(enemies, {
                            Model = obj,
                            Name = obj.Name,
                            Position = head.Position,
                            Distance = distance
                        })
                    end
                end
            end
        end
    end
    
    table.sort(enemies, function(a, b) return a.Distance < b.Distance end)
    return enemies
end

local function FarmSelectedLogic()
    if not ValidatePlayerState() then return end
    if #selectedEnemyNames == 0 then return end
    
    local character = LocalPlayer.Character
    local root = character and character:FindFirstChild("HumanoidRootPart")
    if not root then return end
    
    local enemies = FindEnemiesInRange(200)
    local targets = {}
    
    for _, enemy in ipairs(enemies) do
        for _, selectedName in ipairs(selectedEnemyNames) do
            if enemy.Name == selectedName then
                table.insert(targets, enemy)
                break 
            end
        end
    end
    
    table.sort(targets, function(a, b) return a.Distance < b.Distance end)
    
    if #targets == 0 then return end
    
    local remote = GetAttackRemote()
    if not remote then return end

    for _, target in ipairs(targets) do
        if not activeLoops["FarmSelected"] then break end 
        
        if target.Model and target.Model.Parent and target.Model:FindFirstChild("Humanoid") and target.Model.Humanoid.Health > 0 then
            local offset = Vector3.new(
                math.random(-10, 10) / 10,
                3,
                math.random(-10, 10) / 10
            )
            root.CFrame = CFrame.new(target.Position + offset)
            
            SafeFire(remote, "Attack", target.Model)
            wait(0.05)
            SafeFire(remote, "Attack", target.Model)
            
            wait(0.05)
        end
    end
end

local function AutoAttackLogic()
    if not ValidatePlayerState() then return end
    local enemies = FindEnemiesInRange(Config.AttackRange)
    if #enemies > 0 then
        local nearestEnemy = enemies[1]
        local remote = GetAttackRemote()
        if remote then 
            SafeFire(remote, "Attack", nearestEnemy.Model) 
        end
    end
end

local function FarmRandomLogic()
    if not ValidatePlayerState() then return end
    local enemies = FindEnemiesInRange(Config.AttackRange)
    if #enemies > 0 then
        local randomEnemy = enemies[math.random(1, #enemies)]
        local character = LocalPlayer.Character
        if character and character:FindFirstChild("HumanoidRootPart") then
            character.HumanoidRootPart.CFrame = CFrame.new(randomEnemy.Position + Vector3.new(0,2,0))
            local remote = GetAttackRemote()
            if remote then 
                SafeFire(remote, "Attack", randomEnemy.Model) 
            end
        end
    end
end

local function AutoCollectLogic()
    if not ValidatePlayerState() then return end
    local character = LocalPlayer.Character
    local remote = GetAttackRemote()
    if not remote then return end
    
    local root = character and character:FindFirstChild("HumanoidRootPart")
    if not root then return end 

    local collected = 0
    
    for _, obj in pairs(workspace:GetDescendants()) do
        if collected >= Config.MaxCollectPerFrame then break end
        
        if obj:IsA("Part") and (obj.Name:lower():find("drop") or obj.Name:lower():find("coin") or obj.Name:lower():find("reward")) then
            local distance = (root.Position - obj.Position).Magnitude
            if distance < Config.CollectRange then
                SafeFire(remote, "Collect", obj)
                collected = collected + 1
            end
        end
    end
end

local function AutoRebirthLogic()
    if not ValidatePlayerState() then return end
    local remote = GetReplyRemote()
    if remote then
        SafeFire(remote, "RankUp")
    end
end

local function AutoOpenEggLogic()
    if not ValidatePlayerState() then return end
    local remote = GetReplyRemote()
    if remote then
        SafeFire(remote, "Open Star", {[1] = "Egg"})
    end
end

local function StartGacha(gachaType)
    local remote = GetReplyRemote()
    if remote then
        SafeFire(remote, "Crate Roll Start", {[1] = gachaType, [2] = true}) 
        wait(1)
        SafeFire(remote, "Crate Roll Stop") 
    end
end

local function DistributeStat(statName)
    local remote = GetReplyRemote()
    if remote then
        SafeFire(remote, "Distribute Stat Point", {[1] = statName})
    end
end

local function TeleportToZone(zoneKey)
    local zoneName = Config.Zones[zoneKey]
    if not zoneName then return end

    local remote = GetReplyRemote()
    if remote then
        SafeFire(remote, "Zone Teleport", {[1] = zoneName}) 
        selectedZone = zoneKey
        print("ðŸš€ Teleport to: " .. zoneKey)
    end
end

local function SafeTeleportToZone(zoneKey)
    if tick() - lastTeleportTime < Config.TeleportCooldown then
        return
    end
    
    TeleportToZone(zoneKey)
    lastTeleportTime = tick()
end

local function StartAutoRollLoop(gachaName)
    local loopName = "AutoRoll"..gachaName
    
    for name, _ in pairs(activeLoops) do
        if name:find("AutoRoll") then 
            StopLoop(name) 
        end
    end
    
    StartLoop(loopName, function() 
        StartGacha(gachaName) 
    end, 2)
end

local function GetEnemyGroups()
    local enemies = FindEnemiesInRange(200)
    local groups = {}
    
    for _, enemy in ipairs(enemies) do
        if not groups[enemy.Name] then
            groups[enemy.Name] = {
                name = enemy.Name,
                count = 0,
                nearestDistance = math.huge
            }
        end
        
        groups[enemy.Name].count = groups[enemy.Name].count + 1
        if enemy.Distance < groups[enemy.Name].nearestDistance then
            groups[enemy.Name].nearestDistance = enemy.Distance
        end
    end
    
    return groups
end

-- ===================================================================
-- V. GUI FRAMEWORK (FIXED)
-- ===================================================================

local COLOR_PRIMARY = Color3.fromRGB(80, 0, 160)
local COLOR_SECONDARY = Color3.fromRGB(120, 0, 200)
local COLOR_ACCENT = Color3.fromRGB(200, 100, 255)
local COLOR_TEXT = Color3.fromRGB(255, 255, 255)
local COLOR_TEXT_DIM = Color3.fromRGB(200, 200, 255)
local COLOR_ON = Color3.fromRGB(0, 200, 0)
local COLOR_OFF = Color3.fromRGB(200, 0, 0)

local function CreatePanel(size, position, parent)
    local panel = Instance.new("Frame")
    panel.Size = size
    panel.Position = position
    panel.BackgroundColor3 = COLOR_PRIMARY
    panel.Parent = parent
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 12)
    corner.Parent = panel
    
    return panel
end

local function CreateLabel(text, size, position, parent, bold, fontSize, color)
    local label = Instance.new("TextLabel")
    label.Size = size
    label.Position = position
    label.BackgroundTransparency = 1
    label.Text = text
    label.TextColor3 = color or COLOR_TEXT
    label.Font = bold and Enum.Font.GothamBold or Enum.Font.Gotham
    label.TextSize = fontSize or 14
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.Parent = parent
    return label
end

function CreateToggleSwitch(text, description, default, callback, parent)
    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(1, 0, 0, 50)
    frame.BackgroundTransparency = 1
    frame.Parent = parent

    local label = CreateLabel(text, UDim2.new(0.6, 0, 0.5, 0), UDim2.new(0, 10, 0, 0), frame, true, 13)
    local desc = CreateLabel(description, UDim2.new(0.8, 0, 0.5, 0), UDim2.new(0, 10, 0.5, 0), frame, false, 11, COLOR_TEXT_DIM)

    local toggleButton = Instance.new("TextButton")
    toggleButton.Size = UDim2.new(0, 65, 0, 28)
    toggleButton.Position = UDim2.new(1, -75, 0.5, -14)
    toggleButton.Text = default and "ON" or "OFF"
    toggleButton.TextColor3 = COLOR_TEXT
    toggleButton.Font = Enum.Font.GothamBold
    toggleButton.TextSize = 13
    toggleButton.BackgroundColor3 = default and COLOR_ON or COLOR_OFF
    toggleButton.Parent = frame

    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 6)
    corner.Parent = toggleButton
    
    local isOn = default

    toggleButton.MouseButton1Click:Connect(function()
        isOn = not isOn
        toggleButton.Text = isOn and "ON" or "OFF"
        toggleButton.BackgroundColor3 = isOn and COLOR_ON or COLOR_OFF
        callback(isOn)
    end)

    return frame
end

function CreateActionButton(text, description, callback, parent)
    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(1, 0, 0, 50)
    frame.BackgroundTransparency = 1
    frame.Parent = parent
    
    local btn = Instance.new("TextButton")
    btn.Size = UDim2.new(0.4, 0, 0, 32)
    btn.Position = UDim2.new(0, 10, 0.5, -16)
    btn.BackgroundColor3 = COLOR_ACCENT
    btn.Text = text
    btn.TextColor3 = COLOR_TEXT
    btn.Font = Enum.Font.GothamBold
    btn.TextSize = 13
    btn.Parent = frame

    local btnCorner = Instance.new("UICorner")
    btnCorner.CornerRadius = UDim.new(0, 6)
    btnCorner.Parent = btn

    local desc = CreateLabel(description, UDim2.new(0.5, 0, 0.5, 0), UDim2.new(0.4, 20, 0.5, -10), frame, false, 11, COLOR_TEXT_DIM)
    desc.TextXAlignment = Enum.TextXAlignment.Left

    btn.MouseButton1Click:Connect(function()
        if callback then callback() end
    end)

    return frame
end

function CreateComboBox(text, description, items, callback, parent)
    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(1, 0, 0, 60)
    frame.BackgroundTransparency = 1
    frame.Parent = parent
    
    local label = CreateLabel(text, UDim2.new(0.5, 0, 0.5, 0), UDim2.new(0, 10, 0, 5), frame, true, 14)
    local desc = CreateLabel(description, UDim2.new(0.5, 0, 0.5, 0), UDim2.new(0, 10, 0.5, 0), frame, false, 11, COLOR_TEXT_DIM)

    local dropdown = Instance.new("TextButton")
    dropdown.Size = UDim2.new(0.4, 0, 0, 32)
    dropdown.Position = UDim2.new(0.55, 0, 0.25, 0)
    dropdown.BackgroundColor3 = COLOR_SECONDARY
    dropdown.Text = items[1] or "Select"
    dropdown.TextColor3 = COLOR_TEXT
    dropdown.Font = Enum.Font.GothamBold
    dropdown.TextSize = 13
    dropdown.Parent = frame

    local btnCorner = Instance.new("UICorner")
    btnCorner.CornerRadius = UDim.new(0, 6)
    btnCorner.Parent = dropdown

    local selected = items[1]
    
    dropdown.MouseButton1Click:Connect(function()
        local menu = Instance.new("Frame")
        menu.Size = UDim2.new(0.4, 0, 0, math.min(#items * 28, 200))
        menu.Position = UDim2.new(0.55, 0, 0.75, 0)
        menu.BackgroundColor3 = COLOR_SECONDARY
        menu.Parent = frame

        local menuCorner = Instance.new("UICorner")
        menuCorner.CornerRadius = UDim.new(0, 6)
        menuCorner.Parent = menu

        for i, item in ipairs(items) do
            local itemBtn = Instance.new("TextButton")
            itemBtn.Size = UDim2.new(1, 0, 0, 28)
            itemBtn.Position = UDim2.new(0, 0, 0, (i-1)*28)
            itemBtn.BackgroundColor3 = (item == selected) and COLOR_PRIMARY or COLOR_SECONDARY
            itemBtn.Text = item
            itemBtn.TextColor3 = COLOR_TEXT
            itemBtn.Font = Enum.Font.Gotham
            itemBtn.TextSize = 12
            itemBtn.Parent = menu
            
            itemBtn.MouseButton1Click:Connect(function()
                dropdown.Text = item
                selected = item
                menu:Destroy()
                if callback then callback(item) end
            end)
        end
    end)

    return frame
end

-- ===================================================================
-- VI. GUI CONSTRUCTION (FIXED)
-- ===================================================================

-- Mini UI Setup
HimonoMini = Instance.new("ScreenGui")
HimonoMini.Name = "HimonoHubMini"
HimonoMini.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
HimonoMini.Enabled = false
HimonoMini.Parent = game.CoreGui

local function ToggleUI(showMain)
    if showMain then
        HimonoHub.Enabled = true
        HimonoMini.Enabled = false
    else
        HimonoHub.Enabled = false
        HimonoMini.Enabled = true
    end
end

MiniButton = Instance.new("TextButton")
MiniButton.Name = "MiniButton"
MiniButton.Size = UDim2.new(0, 40, 0, 40)
MiniButton.Position = UDim2.new(1, -50, 0, 50)
MiniButton.BackgroundColor3 = COLOR_ACCENT
MiniButton.Text = "ðŸŸ£"
MiniButton.TextColor3 = COLOR_TEXT
MiniButton.Font = Enum.Font.GothamBold
MiniButton.TextSize = 24
MiniButton.Parent = HimonoMini

local MiniCorner = Instance.new("UICorner")
MiniCorner.CornerRadius = UDim.new(1, 0)
MiniCorner.Parent = MiniButton

MiniButton.MouseButton1Click:Connect(function()
    ToggleUI(true)
end)

-- Main UI Setup
HimonoHub = Instance.new("ScreenGui")
HimonoHub.Name = "HimonoHub"
HimonoHub.ResetOnSpawn = false
HimonoHub.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
HimonoHub.Parent = game.CoreGui

MainContainer = CreatePanel(UDim2.new(0, 500, 0, 480), UDim2.new(0.5, -250, 0.5, -240), HimonoHub)

-- TitleBar Setup
TitleBar = Instance.new("Frame")
TitleBar.Name = "TitleBar"
TitleBar.Size = UDim2.new(1, 0, 0, 40)
TitleBar.BackgroundColor3 = COLOR_PRIMARY
TitleBar.Parent = MainContainer

local Title = CreateLabel("ðŸŸ£ HIMONO HUB v4.7 - PURPLE EDITION", UDim2.new(1, -100, 1, 0), UDim2.new(0, 15, 0, 0), TitleBar, true, 16, COLOR_ACCENT)
Title.TextXAlignment = Enum.TextXAlignment.Left

local StealthIndicator = Instance.new("Frame")
StealthIndicator.Name = "StealthIndicator"
StealthIndicator.Size = UDim2.new(0, 10, 0, 10)
StealthIndicator.Position = UDim2.new(1, -70, 0.5, -5)
StealthIndicator.BackgroundColor3 = stealthMode and COLOR_ON or COLOR_OFF
StealthIndicator.Parent = TitleBar

local StealthCorner = Instance.new("UICorner")
StealthCorner.CornerRadius = UDim.new(1, 0)
StealthCorner.Parent = StealthIndicator

local StealthLabel = CreateLabel(stealthMode and "STEALTH: ON" or "STEALTH: OFF", UDim2.new(0, 60, 1, 0), UDim2.new(1, -60, 0, 0), TitleBar, false, 11, stealthMode and COLOR_ON or COLOR_OFF)
StealthLabel.Name = "StealthLabel"
StealthLabel.TextXAlignment = Enum.TextXAlignment.Right

-- Hide Button
local HideButton = Instance.new("TextButton")
HideButton.Name = "HideButton"
HideButton.Size = UDim2.new(0, 30, 0, 30)
HideButton.Position = UDim2.new(1, -35, 0.5, -15)
HideButton.BackgroundColor3 = COLOR_SECONDARY
HideButton.Text = "âž–"
HideButton.TextColor3 = COLOR_TEXT
HideButton.Font = Enum.Font.GothamBold
HideButton.TextSize = 18
HideButton.Parent = TitleBar

local HideCorner = Instance.new("UICorner")
HideCorner.CornerRadius = UDim.new(0, 6)
HideCorner.Parent = HideButton

HideButton.MouseButton1Click:Connect(function()
    ToggleUI(false)
end)

-- Tab System
local TabContainer = CreatePanel(UDim2.new(0, 150, 1, -50), UDim2.new(0, 10, 0, 45), MainContainer)

local TabListLayout = Instance.new("UIListLayout")
TabListLayout.FillDirection = Enum.FillDirection.Vertical
TabListLayout.Padding = UDim.new(0, 5)
TabListLayout.Parent = TabContainer

local ContentScroll = Instance.new("ScrollingFrame")
ContentScroll.Size = UDim2.new(1, -170, 1, -50)
ContentScroll.Position = UDim2.new(0, 160, 0, 45)
ContentScroll.BackgroundColor3 = COLOR_SECONDARY
ContentScroll.BorderSizePixel = 0
ContentScroll.ScrollBarThickness = 5
ContentScroll.ScrollBarImageColor3 = COLOR_ACCENT
ContentScroll.CanvasSize = UDim2.new(0, 0, 2, 0)
ContentScroll.Parent = MainContainer

local ContentCorner = Instance.new("UICorner")
ContentCorner.CornerRadius = UDim.new(0, 8)
ContentCorner.Parent = ContentScroll

local ContentLayout = Instance.new("UIListLayout")
ContentLayout.Padding = UDim.new(0, 10)
ContentLayout.Parent = ContentScroll

-- Tabs definition
local tabs = {
    "ðŸ  MAIN", "ðŸŒ¾ FARM", "ðŸŽ° GACHA", 
    "âš¡ STATS", "ðŸš€ TELEPORT", "ðŸ¥š EGG", "âš™ï¸ SETTINGS"
}
local tabFrames, tabButtons = {}, {}

for i, tabName in ipairs(tabs) do
    local tabButton = Instance.new("TextButton")
    tabButton.Size = UDim2.new(1, -10, 0, 35)
    tabButton.BackgroundColor3 = i == 1 and COLOR_ACCENT or COLOR_PRIMARY
    tabButton.Text = tabName
    tabButton.TextColor3 = i == 1 and COLOR_TEXT or COLOR_TEXT
    tabButton.Font = Enum.Font.GothamBold
    tabButton.TextSize = 13
    tabButton.Parent = TabContainer
    tabButton.LayoutOrder = i

    local tabButtonCorner = Instance.new("UICorner")
    tabButtonCorner.CornerRadius = UDim.new(0, 6)
    tabButtonCorner.Parent = tabButton

    local contentFrame = Instance.new("Frame")
    contentFrame.Size = UDim2.new(1, 0, 1, 0)
    contentFrame.BackgroundTransparency = 1
    contentFrame.Visible = i == 1
    contentFrame.Parent = ContentScroll

    local contentLayout = Instance.new("UIListLayout")
    contentLayout.Padding = UDim.new(0, 10)
    contentLayout.Parent = contentFrame

    tabFrames[tabName] = contentFrame
    tabButtons[tabName] = tabButton

    tabButton.MouseButton1Click:Connect(function()
        for name, frame in pairs(tabFrames) do
            frame.Visible = (name == tabName)
        end
        for name, btn in pairs(tabButtons) do
            btn.BackgroundColor3 = (name == tabName) and COLOR_ACCENT or COLOR_PRIMARY
        end
    end)
end

-- MAIN TAB CONTENT
local mainContent = tabFrames["ðŸ  MAIN"]
CreateLabel("CORE AUTOMATION:", UDim2.new(1, 0, 0, 20), UDim2.new(0, 10, 0, 5), mainContent, true, 16, COLOR_ACCENT)

CreateToggleSwitch(
    "Auto Attack (Nearest)", "Tá»± Ä‘á»™ng táº¥n cÃ´ng káº» Ä‘á»‹ch gáº§n nháº¥t", false, 
    function(enabled)
        if enabled then 
            StartLoop("AutoAttack", AutoAttackLogic, Config.FarmInterval) 
        else 
            StopLoop("AutoAttack") 
        end
    end, mainContent
)

CreateToggleSwitch(
    "Auto Collect All Drops", "Tá»± Ä‘á»™ng nháº·t váº­t pháº©m quanh báº¡n", false, 
    function(enabled)
        if enabled then 
            StartLoop("AutoCollect", AutoCollectLogic, 1.0) 
        else 
            StopLoop("AutoCollect") 
        end
    end, mainContent
)

-- FARM TAB CONTENT
local farmContent = tabFrames["ðŸŒ¾ FARM"]
CreateLabel("FARMING METHODS:", UDim2.new(1, 0, 0, 20), UDim2.new(0, 10, 0, 5), farmContent, true, 16, COLOR_ACCENT)

CreateToggleSwitch(
    "Auto Farm Selected Enemies", "Farm Táº¤T Cáº¢ enemy cÃ¹ng tÃªn", false, 
    function(enabled)
        if enabled then 
            StartLoop("FarmSelected", FarmSelectedLogic, Config.FarmInterval) 
        else 
            StopLoop("FarmSelected") 
        end
    end, farmContent
)

CreateToggleSwitch(
    "Farm Random Enemies", "Tá»± Ä‘á»™ng Teleport vÃ  farm ngáº«u nhiÃªn", false, 
    function(enabled)
        if enabled then 
            StartLoop("FarmRandom", FarmRandomLogic, Config.FarmInterval) 
        else 
            StopLoop("FarmRandom") 
        end
    end, farmContent
)

-- Enemy Selection in FARM tab
CreateLabel("ENEMY SELECTION:", UDim2.new(1, 0, 0, 20), UDim2.new(0, 10, 0, 5), farmContent, true, 16, COLOR_ACCENT)

CreateActionButton("Clear Selected (" .. #selectedEnemyNames .. "x)", "XÃ³a danh sÃ¡ch enemy Ä‘Æ°á»£c chá»n", function()
    selectedEnemyNames = {}
end, farmContent)

local refreshEnemiesBtn = CreateActionButton("Refresh/Scan Enemies", "QuÃ©t láº¡i káº» Ä‘á»‹ch trong pháº¡m vi", function()
    for _, child in pairs(farmContent:GetChildren()) do
        if child.Name == "EnemyGroupToggle" then 
            child:Destroy() 
        end
    end
    
    local enemyGroups = GetEnemyGroups()
    local sortedEnemyNames = {}
    for name, _ in pairs(enemyGroups) do 
        table.insert(sortedEnemyNames, name) 
    end
    table.sort(sortedEnemyNames)

    for _, name in ipairs(sortedEnemyNames) do
        local group = enemyGroups[name]
        local isSelected = false
        for _, selectedName in ipairs(selectedEnemyNames) do
            if selectedName == name then 
                isSelected = true
                break 
            end
        end

        local toggle = CreateToggleSwitch(
            name .. " (" .. group.count .. "x)", 
            "Gáº§n nháº¥t: " .. math.floor(group.nearestDistance) .. "m", 
            isSelected, 
            function(enabled)
                if enabled then
                    local found = false
                    for _, n in ipairs(selectedEnemyNames) do
                        if n == name then 
                            found = true
                            break 
                        end
                    end
                    if not found then 
                        table.insert(selectedEnemyNames, name) 
                    end
                else
                    for i, n in ipairs(selectedEnemyNames) do
                        if n == name then 
                            table.remove(selectedEnemyNames, i)
                            break 
                        end
                    end
                end
            end, farmContent
        )
        toggle.Name = "EnemyGroupToggle"
    end
end, farmContent)

-- GACHA TAB CONTENT
local gachaContent = tabFrames["ðŸŽ° GACHA"]
CreateLabel("GACHA AUTOMATION:", UDim2.new(1, 0, 0, 20), UDim2.new(0, 10, 0, 5), gachaContent, true, 16, COLOR_ACCENT)

CreateComboBox("Select Gacha", "Chá»n loáº¡i gacha Ä‘á»ƒ auto roll", Config.GachaTypes, function(selected)
    selectedGachaType = selected
end, gachaContent)

CreateActionButton("Manual Roll: " .. Config.GachaTypes[1], "Roll gacha Ä‘Ã£ chá»n má»™t láº§n", function()
    StartGacha(selectedGachaType)
end, gachaContent)

for i, gacha in ipairs(Config.GachaTypes) do
    CreateToggleSwitch(
        "Auto Roll: " .. gacha, 
        "Tá»± Ä‘á»™ng roll " .. gacha, 
        false, 
        function(enabled)
            if enabled then
                StartAutoRollLoop(gacha)
            else
                StopLoop("AutoRoll"..gacha)
            end
        end, gachaContent
    )
end

-- STATS TAB CONTENT
local statsContent = tabFrames["âš¡ STATS"]
CreateLabel("STAT POINT DISTRIBUTION:", UDim2.new(1, 0, 0, 20), UDim2.new(0, 10, 0, 5), statsContent, true, 16, COLOR_ACCENT)

CreateComboBox("Select Stat", "Chá»n loáº¡i stat Ä‘á»ƒ cá»™ng Ä‘iá»ƒm", Config.StatTypes, function(selected)
    selectedStat = selected
end, statsContent)

CreateActionButton("Distribute: " .. Config.StatTypes[1], "Cá»™ng 1 Ä‘iá»ƒm vÃ o stat Ä‘Ã£ chá»n", function()
    DistributeStat(selectedStat)
end, statsContent)

-- TELEPORT TAB CONTENT
local teleportContent = tabFrames["ðŸš€ TELEPORT"]
CreateLabel("ZONE TELEPORT:", UDim2.new(1, 0, 0, 20), UDim2.new(0, 10, 0, 5), teleportContent, true, 16, COLOR_ACCENT)

CreateComboBox("Select Destination", "Di chuyá»ƒn nhanh Ä‘áº¿n khu vá»±c", sortedZoneKeys, function(selected)
    selectedZone = selected
end, teleportContent)

CreateActionButton("TELEPORT NOW", "Di chuyá»ƒn Ä‘áº¿n khu vá»±c Ä‘Ã£ chá»n", function()
    SafeTeleportToZone(selectedZone)
end, teleportContent)

-- EGG TAB CONTENT
local eggContent = tabFrames["ðŸ¥š EGG"]
CreateLabel("EGG HATCHING:", UDim2.new(1, 0, 0, 20), UDim2.new(0, 10, 0, 5), eggContent, true, 16, COLOR_ACCENT)

CreateActionButton("Manual Open Egg", "Má»Ÿ egg gáº§n báº¡n má»™t láº§n", function()
    AutoOpenEggLogic()
end, eggContent)

CreateToggleSwitch(
    "Enable Auto Open Egg", 
    "Tá»± Ä‘á»™ng má»Ÿ egg khi gáº§n", 
    false, 
    function(enabled)
        if enabled then
            StartLoop("AutoOpenEgg", AutoOpenEggLogic, 2)
        else
            StopLoop("AutoOpenEgg")
        end
    end, eggContent
)

-- SETTINGS TAB CONTENT
local settingsContent = tabFrames["âš™ï¸ SETTINGS"]
CreateLabel("SYSTEM SETTINGS:", UDim2.new(1, 0, 0, 20), UDim2.new(0, 10, 0, 5), settingsContent, true, 16, COLOR_ACCENT)

CreateToggleSwitch(
    "Enable Anti-AFK", 
    "Chá»‘ng bá»‹ kick khi treo mÃ¡y", 
    true, 
    function(enabled)
        if enabled then 
            EnableAntiAFK() 
        end
    end, settingsContent
)

CreateToggleSwitch(
    "Enable Stealth Mode", 
    "Giáº£m tá»‘c Ä‘á»™ Remote Calls", 
    Config.StealthMode, 
    function(enabled)
        stealthMode = enabled
        StealthIndicator.BackgroundColor3 = enabled and COLOR_ON or COLOR_OFF
        StealthLabel.Text = enabled and "STEALTH: ON" or "STEALTH: OFF"
        StealthLabel.TextColor3 = enabled and COLOR_ON or COLOR_OFF
    end, settingsContent
)

-- ===================================================================
-- VII. DRAG & HOTKEY FUNCTIONALITY
-- ===================================================================

-- Drag functionality for main UI
local dragging = false
local dragInput, dragStart, startPos

TitleBar.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = true
        dragStart = input.Position
        startPos = MainContainer.Position
    end
end)

TitleBar.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement then
        dragInput = input
    end
end)

UserInputService.InputChanged:Connect(function(input)
    if input == dragInput and dragging then
        local delta = input.Position - dragStart
        MainContainer.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
    end
end)

TitleBar.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = false
    end
end)

-- Drag functionality for mini UI
local draggingMini = false
local dragStartMini, startPosMini

MiniButton.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        draggingMini = true
        dragStartMini = input.Position
        startPosMini = MiniButton.Position
    end
end)

UserInputService.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement and draggingMini then
        local delta = input.Position - dragStartMini
        MiniButton.Position = UDim2.new(startPosMini.X.Scale, startPosMini.X.Offset + delta.X, startPosMini.Y.Scale, startPosMini.Y.Offset + delta.Y)
    end
end)

MiniButton.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        draggingMini = false
    end
end)

-- Hotkey (Left Control)
UserInputService.InputBegan:Connect(function(input, gameProcessedEvent)
    if input.KeyCode == Enum.KeyCode.LeftControl and not gameProcessedEvent then
        ToggleUI(not HimonoHub.Enabled)
    end
end)

-- ===================================================================
-- VIII. INITIALIZATION
-- ===================================================================

-- Enable Anti-AFK
EnableAntiAFK()

-- Auto-update UI elements
spawn(function()
    while HimonoHub.Parent do
        wait(0.5)
        for _, frame in pairs(tabFrames) do
            local layout = frame:FindFirstChildOfClass("UIListLayout")
            if layout then
                ContentScroll.CanvasSize = UDim2.new(0, 0, 0, layout.AbsoluteContentSize.Y + 20)
            end
        end
    end
end)

print("ðŸŸ£ HIMONO HUB v4.7 - PURPLE EDITION LOADED! (Press Left Control to toggle)")
