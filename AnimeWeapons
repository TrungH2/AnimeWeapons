local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local LocalPlayer = Players.LocalPlayer

local stealthMode = true
local safeConnections = {}
local activeLoops = {}
local selectedEnemyPositions = {}
local selectedGachaType = "Biju"
local selectedZone = "Zone 1"
local selectedStat = "Attack"
local autoOpenEggEnabled = false

local isDungeonActive = false         -- C·ªù: B·∫¨T khi Auto Join/Farm Dungeon ON
local autoDungeonFarmEnabled = false  -- C·ªù: B·∫¨T khi Auto Farm Dungeon ON
local isPlayerInDungeon = false       -- C·ªù: Theo d√µi tr·∫°ng th√°i player trong Dungeon

-- C√°c bi·∫øn l∆∞u tr·∫°ng th√°i Farm tr∆∞·ªõc khi v√†o Dungeon
local wasAutoAttackEnabled = false
local wasFarmSelectedEnabled = false
local wasFarmRandomEnabled = false
local wasAutoCollectEnabled = false

-- BI·∫æN M·ªöI ƒê·ªÇ QUAY L·∫†I V·ªä TR√ç C≈®
local lastZone = "Zone 1" 

-- Safe remote fire
local function SafeFire(remote, ...)
    if stealthMode then RunService.Heartbeat:Wait() end
    remote:FireServer(...)
end

local function SafeWait()
    if not stealthMode then task.wait(); return end
    math.randomseed(tick())
    local delay = math.random(20, 50) / 100
    local start = tick()
    while tick() - start < delay do RunService.Heartbeat:Wait() end
end

local function SafeCall(func, ...)
    local success, result = pcall(func, ...)
    return success and result or nil
end

local function SafeConnect(signal, callback)
    local conn = signal:Connect(function(...)
        if stealthMode then SafeWait() end
        SafeCall(callback, ...)
    end)
    table.insert(safeConnections, conn)
    return conn
end

local function StartLoop(name, func, interval)
    if activeLoops[name] then activeLoops[name] = false; task.wait(0.1) end
    activeLoops[name] = true
    task.spawn(function()
        while activeLoops[name] do
            pcall(func)
            if interval then task.wait(interval) else RunService.Heartbeat:Wait() end
        end
    end)
end

local function StopLoop(name)
    if activeLoops[name] then activeLoops[name] = false end
end

-- -------------------------------------------------------------------
-- CH·ª®C NƒÇNG QU·∫¢N L√ù FARM LOOPS
-- -------------------------------------------------------------------

local function SaveAndStopFarmLoops()
    -- L∆∞u tr·∫°ng th√°i c√°c loop farm map
    wasAutoAttackEnabled = activeLoops["AutoAttack"] or false
    wasFarmSelectedEnabled = activeLoops["FarmSelected"] or false
    wasFarmRandomEnabled = activeLoops["FarmRandom"] or false
    wasAutoCollectEnabled = activeLoops["AutoCollect"] or false
    
    -- D·ª´ng c√°c loop farm map
    StopLoop("AutoAttack")
    StopLoop("FarmSelected")
    StopLoop("FarmRandom")
    StopLoop("AutoCollect")
end

local function RestoreFarmLoops()
    if wasAutoAttackEnabled then StartLoop("AutoAttack", AutoAttackLogic, 0.3) end
    if wasFarmSelectedEnabled then StartLoop("FarmSelected", FarmSelectedLogic, 0.5) end
    if wasFarmRandomEnabled then StartLoop("FarmRandom", FarmRandomLogic, 0.5) end
    if wasAutoCollectEnabled then StartLoop("AutoCollect", AutoCollectLogic, 1.0) end
    
    print("‚úÖ ƒê√£ kh√¥i ph·ª•c c√†i ƒë·∫∑t Farm map c≈©.")
    -- Reset c·ªù l∆∞u tr·∫°ng th√°i
    wasAutoAttackEnabled = false
    wasFarmSelectedEnabled = false
    wasFarmRandomEnabled = false
    wasAutoCollectEnabled = false
end

-- -------------------------------------------------------------------
-- CH·ª®C NƒÇNG C∆† B·∫¢N V√Ä C·∫¨P NH·∫¨T FARM LOGIC
-- -------------------------------------------------------------------

local antiAFKConnection
local function EnableAntiAFK()
    if antiAFKConnection then antiAFKConnection:Disconnect() end
    antiAFKConnection = LocalPlayer.Idled:Connect(function()
        SafeCall(function()
            VirtualUser:CaptureController()
            VirtualUser:ClickButton2(Vector2.new())
        end)
    end)
end

local function FindEnemiesInRange(range)
    local character = LocalPlayer.Character
    if not character or not character:FindFirstChild("HumanoidRootPart") then return {} end
    local enemies = {}
    local playerPos = character.HumanoidRootPart.Position
    for _, obj in pairs(workspace:GetDescendants()) do
        if obj:IsA("Model") and obj:FindFirstChild("Humanoid") and obj:FindFirstChild("Head") then
            local isPlayer = false
            for _, player in pairs(Players:GetPlayers()) do
                if player.Character == obj then isPlayer = true; break end
            end
            if not isPlayer and obj.Humanoid.Health > 0 then
                local distance = (playerPos - obj.Head.Position).Magnitude
                if distance <= (range or 100) then
                    table.insert(enemies, {
                        Model = obj,
                        Name = obj.Name,
                        Position = obj.Head.Position,
                        Distance = distance,
                        Health = obj.Humanoid.Health,
                        MaxHealth = obj.Humanoid.MaxHealth
                    })
                end
            end
        end
    end
    table.sort(enemies, function(a, b) return a.Distance < b.Distance end)
    return enemies
end

local function RefreshEnemiesList()
    return FindEnemiesInRange(100)
end

local function AutoAttackLogic()
    if isDungeonActive then return end 
    local enemies = FindEnemiesInRange(50)
    if #enemies > 0 then
        local nearestEnemy = enemies[1]
        local character = LocalPlayer.Character
        if character and character:FindFirstChild("HumanoidRootPart") then
            character.HumanoidRootPart.CFrame = CFrame.new(nearestEnemy.Position + Vector3.new(0,2,0))
            local remote = ReplicatedStorage:FindFirstChild("RemoteEvent") or ReplicatedStorage:FindFirstChild("Remote")
            if remote then SafeFire(remote, "Attack", nearestEnemy.Model) end
        end
    end
end

local function FarmSelectedLogic()
    if isDungeonActive then return end 
    if #selectedEnemyPositions == 0 then return end
    local character = LocalPlayer.Character
    if not character or not character:FindFirstChild("HumanoidRootPart") then return end
    local playerPos = character.HumanoidRootPart.Position
    local nearestPos, nearestDistance = nil, math.huge
    for _, pos in pairs(selectedEnemyPositions) do
        local distance = (playerPos - pos).Magnitude
        if distance < nearestDistance then nearestDistance = distance; nearestPos = pos end
    end
    if nearestPos then
        character.HumanoidRootPart.CFrame = CFrame.new(nearestPos + Vector3.new(0,2,0))
        local remote = ReplicatedStorage:FindFirstChild("RemoteEvent") or ReplicatedStorage:FindFirstChild("Remote")
        if remote then SafeFire(remote, "AttackAtPosition", nearestPos) end
    end
end

local function FarmRandomLogic()
    if isDungeonActive then return end 
    local enemies = FindEnemiesInRange(50)
    if #enemies > 0 then
        local randomEnemy = enemies[math.random(1, #enemies)]
        local character = LocalPlayer.Character
        if character and character:FindFirstChild("HumanoidRootPart") then
            character.HumanoidRootPart.CFrame = CFrame.new(randomEnemy.Position + Vector3.new(0,2,0))
            local remote = ReplicatedStorage:FindFirstChild("RemoteEvent") or ReplicatedStorage:FindFirstChild("Remote")
            if remote then SafeFire(remote, "Attack", randomEnemy.Model) end
        end
    end
end

local function AutoCollectLogic()
    if isDungeonActive then return end 
    local character = LocalPlayer.Character
    if not character then return end
    for _, obj in pairs(workspace:GetDescendants()) do
        if obj:IsA("Part") and (obj.Name:lower():find("drop") or obj.Name:lower():find("coin") or obj.Name:lower():find("reward")) then
            local distance = (character.HumanoidRootPart.Position - obj.Position).Magnitude
            if distance < 20 then
                local remote = ReplicatedStorage:FindFirstChild("RemoteEvent") or ReplicatedStorage:FindFirstChild("Remote")
                if remote then SafeFire(remote, "Collect", obj) end
            end
        end
    end
end

local function StartGacha(gachaType)
    local remote = ReplicatedStorage:FindFirstChild("Reply") and ReplicatedStorage.Reply:FindFirstChild("Reliable")
    if remote then
        SafeFire(remote, "Crate Roll Start", {[1]=gachaType,[2]=true})
        task.wait(1)
        SafeFire(remote, "Crate Roll Stop")
    end
end

local function TeleportToZone(zoneName)
    local remote = ReplicatedStorage:FindFirstChild("Reply") and ReplicatedStorage.Reply:FindFirstChild("Reliable")
    if remote then
        SafeFire(remote, "Zone Teleport", {[1]=zoneName})
        selectedZone = zoneName -- C·∫≠p nh·∫≠t selectedZone
        lastZone = zoneName
    end
end

local function DistributeStat(statName)
    local remote = ReplicatedStorage:FindFirstChild("Reply") and ReplicatedStorage.Reply:FindFirstChild("Reliable")
    if remote then
        SafeFire(remote, "Distribute Stat Point", {[1]=statName})
    end
end

local function AutoOpenEggLogic()
    local remote = ReplicatedStorage:FindFirstChild("Reply") and ReplicatedStorage.Reply:FindFirstChild("Reliable")
    if remote then
        SafeFire(remote, "Open Star", {[1]="Egg"})
    end
end

-- -------------------------------------------------------------------
-- LOGIC AUTO REBIRTH & DUNGEON
-- -------------------------------------------------------------------

local function AutoRebirthLogic()
    local remote = ReplicatedStorage:FindFirstChild("Reply") and ReplicatedStorage.Reply:FindFirstChild("Reliable")
    if remote then
        local args = {
            [1] = "RankUp" -- L·ªánh RankUp/Rebirth
        }
        SafeFire(remote, unpack(args))
        print("‚ö° ƒê√£ k√≠ch ho·∫°t Auto Rebirth/RankUp!")
    end
end

local function AutoJoinDungeonEasyLogic()
    -- Ghi nh·ªõ zone hi·ªán t·∫°i (d√πng selectedZone) tr∆∞·ªõc khi join dungeon
    lastZone = selectedZone 
    
    local remote = ReplicatedStorage:FindFirstChild("Reply") and ReplicatedStorage.Reply:FindFirstChild("Reliable")
    if remote then
        local args = {
            [1] = "Join Gamemode",
            [2] = {
                [1] = "Dungeon:1" -- "Dungeon:1" l√† Dungeon Easy
            }
        }
        SafeFire(remote, unpack(args))
        print("üó∫Ô∏è ƒê√£ g·ª≠i y√™u c·∫ßu tham gia Dungeon Easy!")
    end
end

local function AutoFarmDungeonLogic()
    local character = LocalPlayer.Character
    if not character or not character:FindFirstChild("HumanoidRootPart") then 
        isPlayerInDungeon = false
        return 
    end

    local enemies = FindEnemiesInRange(200)
    if #enemies > 0 then
        isPlayerInDungeon = true 
        local nearestEnemy = enemies[1]
        
        -- Teleport ƒë·∫øn v·ªã tr√≠ k·∫ª ƒë·ªãch
        character.HumanoidRootPart.CFrame = CFrame.new(nearestEnemy.Position + Vector3.new(0,5,0))
        
        -- T·∫•n c√¥ng
        local remote = ReplicatedStorage:FindFirstChild("RemoteEvent") or ReplicatedStorage:FindFirstChild("Remote")
        if remote then 
            SafeFire(remote, "Attack", nearestEnemy.Model) 
        end
    else
        isPlayerInDungeon = false
    end
end

local function DungeonExitCheck()
    -- Ki·ªÉm tra n·∫øu Dungeon ƒë√£ ƒë∆∞·ª£c k√≠ch ho·∫°t, nh∆∞ng hi·ªán t·∫°i kh√¥ng t√¨m th·∫•y k·∫ª ƒë·ªãch Dungeon (c√≥ th·ªÉ ƒë√£ tho√°t/ho√†n th√†nh)
    -- v√† c·∫£ hai Toggle Dungeon (Join v√† Farm) ƒë·ªÅu OFF.
    if isDungeonActive and not isPlayerInDungeon and not activeLoops["AutoJoinDungeon"] and not activeLoops["AutoFarmDungeon"] then
        
        -- D·ª´ng loop ki·ªÉm tra n√†y trong m·ªôt kho·∫£ng ng·∫Øn ƒë·ªÉ tr√°nh g·ªçi Teleport li√™n t·ª•c
        StopLoop("DungeonExitLoop")
        
        isDungeonActive = false
        autoDungeonFarmEnabled = false
        
        print("üö™ ƒê√£ tho√°t Dungeon. Quay v·ªÅ Zone c≈©: " .. lastZone)
        TeleportToZone(lastZone) -- Teleport v·ªÅ Zone ƒë√£ l∆∞u
        
        RestoreFarmLoops() -- Kh√¥i ph·ª•c l·∫°i c√°c loop farm map
        
        -- Kh·ªüi ƒë·ªông l·∫°i loop ki·ªÉm tra
        StartLoop("DungeonExitLoop", DungeonExitCheck, 5)
    end
end
-- B·∫Øt ƒë·∫ßu loop ki·ªÉm tra tho√°t Dungeon
StartLoop("DungeonExitLoop", DungeonExitCheck, 5)

-- -------------------------------------------------------------------
-- GUI FRAMEWORK FUNCTIONS
-- -------------------------------------------------------------------

-- <<< H√ÄM CreateToggleSwitch ƒê√É HO√ÄN THI·ªÜN >>>
function CreateToggleSwitch(text, description, default, callback)
    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(1, -20, 0, 60)
    frame.BackgroundTransparency = 1

    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(0.7, 0, 1, -20)
    label.Position = UDim2.new(0, 0, 0, 0)
    label.Text = text .. "\n" .. description
    label.TextColor3 = Color3.fromRGB(40, 40, 20) -- Thay ƒë·ªïi m√†u ch·ªØ ƒë·ªÉ d·ªÖ nh√¨n tr√™n n·ªÅn v√†ng
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.Font = Enum.Font.Gotham
    label.TextSize = 12
    label.BackgroundTransparency = 1
    label.Parent = frame

    local toggleButton = Instance.new("TextButton")
    toggleButton.Size = UDim2.new(0, 60, 0, 28)
    toggleButton.Position = UDim2.new(1, -80, 0.5, -14)
    toggleButton.Text = default and "ON" or "OFF"
    toggleButton.TextColor3 = default and Color3.fromRGB(0, 180, 0) or Color3.fromRGB(180, 0, 0) -- Gi·∫£m ƒë·ªô s√°ng
    toggleButton.Font = Enum.Font.GothamBold
    toggleButton.TextSize = 14
    toggleButton.BackgroundColor3 = Color3.fromRGB(255, 255, 40) -- N·ªÅn v√†ng s√°ng

    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 6)
    corner.Parent = toggleButton
    toggleButton.Parent = frame

    local isOn = default

    SafeConnect(toggleButton.MouseButton1Click, function()
        isOn = not isOn
        toggleButton.Text = isOn and "ON" or "OFF"
        toggleButton.TextColor3 = isOn and Color3.fromRGB(0, 180, 0) or Color3.fromRGB(180, 0, 0)
        callback(isOn)
    end)

    return frame
end
-- <<< H√ÄM CreateToggleSwitch ƒê√É HO√ÄN THI·ªÜN >>>

function CreateActionButton(text, description, callback)
    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(1, 0, 0, 50)
    frame.BackgroundTransparency = 1

    local btn = Instance.new("TextButton")
    btn.Size = UDim2.new(0.5, 0, 0, 32)
    btn.Position = UDim2.new(0, 10, 0, 9)
    btn.BackgroundColor3 = Color3.fromRGB(255, 255, 40)
    btn.Text = text
    btn.TextColor3 = Color3.fromRGB(40,40,20)
    btn.Font = Enum.Font.GothamBold
    btn.TextSize = 13
    btn.Parent = frame

    local btnCorner = Instance.new("UICorner")
    btnCorner.CornerRadius = UDim.new(0, 6)
    btnCorner.Parent = btn

    local desc = Instance.new("TextLabel")
    desc.Size = UDim2.new(0.5, 0, 0, 20)
    desc.Position = UDim2.new(0.5, 20, 0, 15)
    desc.BackgroundTransparency = 1
    desc.Text = description
    desc.TextColor3 = Color3.fromRGB(120,120,60)
    desc.Font = Enum.Font.Gotham
    desc.TextSize = 11
    desc.TextXAlignment = Enum.TextXAlignment.Left
    desc.Parent = frame

    btn.MouseButton1Click:Connect(function()
        if callback then callback() end
    end)

    return frame
end

function CreateComboBox(text, description, items, callback)
    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(1, 0, 0, 60)
    frame.BackgroundTransparency = 1

    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(0.5, 0, 0.5, 0)
    label.Position = UDim2.new(0, 10, 0, 5)
    label.BackgroundTransparency = 1
    label.Text = text
    label.TextColor3 = Color3.fromRGB(40,40,20)
    label.Font = Enum.Font.GothamBold
    label.TextSize = 14
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.Parent = frame

    local desc = Instance.new("TextLabel")
    desc.Size = UDim2.new(0.5, 0, 0.5, 0)
    desc.Position = UDim2.new(0, 10, 0.5, 0)
    desc.BackgroundTransparency = 1
    desc.Text = description
    desc.TextColor3 = Color3.fromRGB(120,120,60)
    desc.Font = Enum.Font.Gotham
    desc.TextSize = 11
    desc.TextXAlignment = Enum.TextXAlignment.Left
    desc.Parent = frame

    local dropdown = Instance.new("TextButton")
    dropdown.Size = UDim2.new(0.4, 0, 0, 32)
    dropdown.Position = UDim2.new(0.55, 0, 0.25, 0)
    dropdown.BackgroundColor3 = Color3.fromRGB(255, 255, 40)
    dropdown.Text = items[1] or "Select"
    dropdown.TextColor3 = Color3.fromRGB(40,40,20)
    dropdown.Font = Enum.Font.GothamBold
    dropdown.TextSize = 13
    dropdown.Parent = frame

    local btnCorner = Instance.new("UICorner")
    btnCorner.CornerRadius = UDim.new(0, 6)
    btnCorner.Parent = dropdown

    local selected = items[1]
    dropdown.MouseButton1Click:Connect(function()
        local menu = Instance.new("Frame")
        menu.Size = UDim2.new(0.4, 0, 0, #items*28)
        menu.Position = UDim2.new(0.55, 0, 0.75, 0)
        menu.BackgroundColor3 = Color3.fromRGB(255, 255, 180)
        menu.Parent = frame
        local menuCorner = Instance.new("UICorner")
        menuCorner.CornerRadius = UDim.new(0, 6)
        menuCorner.Parent = menu
        for i, item in ipairs(items) do
            local itemBtn = Instance.new("TextButton")
            itemBtn.Size = UDim2.new(1, 0, 0, 28)
            itemBtn.Position = UDim2.new(0, 0, 0, (i-1)*28)
            itemBtn.BackgroundColor3 = Color3.fromRGB(255, 255, 40)
            itemBtn.Text = item
            itemBtn.TextColor3 = Color3.fromRGB(40,40,20)
            itemBtn.Font = Enum.Font.Gotham
            itemBtn.TextSize = 12
            itemBtn.Parent = menu
            itemBtn.MouseButton1Click:Connect(function()
                dropdown.Text = item
                selected = item
                menu:Destroy()
                if callback then callback(item) end
            end)
        end
    end)

    return frame
end


-- -------------------------------------------------------------------
-- GUI CONSTRUCTION
-- -------------------------------------------------------------------

local HimonoHub = Instance.new("ScreenGui")
HimonoHub.Name = "HimonoHubSulfur"
HimonoHub.ResetOnSpawn = false
HimonoHub.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
HimonoHub.Parent = game.CoreGui

local MainContainer = Instance.new("Frame")
MainContainer.Size = UDim2.new(0, 600, 0, 500)
MainContainer.Position = UDim2.new(0.5, -300, 0.5, -250)
MainContainer.BackgroundColor3 = Color3.fromRGB(220, 255, 40)
MainContainer.BorderSizePixel = 0
MainContainer.Parent = HimonoHub

local ContainerCorner = Instance.new("UICorner")
ContainerCorner.CornerRadius = UDim.new(0, 12)
ContainerCorner.Parent = MainContainer

local TitleBar = Instance.new("Frame")
TitleBar.Size = UDim2.new(1, 0, 0, 45)
TitleBar.BackgroundColor3 = Color3.fromRGB(180, 220, 40)
TitleBar.Parent = MainContainer

local TitleCorner = Instance.new("UICorner")
TitleCorner.CornerRadius = UDim.new(0, 12)
TitleCorner.Parent = TitleBar

local Title = Instance.new("TextLabel")
Title.Size = UDim2.new(1, -100, 1, 0)
Title.BackgroundTransparency = 1
Title.Text = "üü° HIMONO HUB v4.2 - SULFUR EDITION"
Title.TextColor3 = Color3.fromRGB(40, 40, 20)
Title.Font = Enum.Font.GothamBold
Title.TextSize = 18
Title.Parent = TitleBar

local StealthIndicator = Instance.new("Frame")
StealthIndicator.Size = UDim2.new(0, 12, 0, 12)
StealthIndicator.Position = UDim2.new(1, -90, 0.5, -6)
StealthIndicator.BackgroundColor3 = Color3.fromRGB(0, 255, 0)
StealthIndicator.Parent = TitleBar

local StealthCorner = Instance.new("UICorner")
StealthCorner.CornerRadius = UDim.new(1, 0)
StealthCorner.Parent = StealthIndicator

local StealthLabel = Instance.new("TextLabel")
StealthLabel.Size = UDim2.new(0, 80, 1, 0)
StealthLabel.Position = UDim2.new(1, -80, 0, 0)
StealthLabel.BackgroundTransparency = 1
StealthLabel.Text = "STEALTH: ON"
StealthLabel.TextColor3 = Color3.fromRGB(0, 255, 0)
StealthLabel.Font = Enum.Font.Gotham
StealthLabel.TextSize = 11
StealthLabel.Parent = TitleBar

local TabContainer = Instance.new("ScrollingFrame")
TabContainer.Size = UDim2.new(1, -20, 0, 40)
TabContainer.Position = UDim2.new(0, 10, 0, 55)
TabContainer.BackgroundTransparency = 1
TabContainer.ScrollBarThickness = 3
TabContainer.ScrollBarImageColor3 = Color3.fromRGB(180, 220, 40)
TabContainer.CanvasSize = UDim2.new(2, 0, 0, 0)
TabContainer.Parent = MainContainer

local TabListLayout = Instance.new("UIListLayout")
TabListLayout.FillDirection = Enum.FillDirection.Horizontal
TabListLayout.Padding = UDim.new(0, 8)
TabListLayout.Parent = TabContainer

local ContentContainer = Instance.new("Frame")
ContentContainer.Size = UDim2.new(1, -20, 1, -120)
ContentContainer.Position = UDim2.new(0, 10, 0, 105)
ContentContainer.BackgroundColor3 = Color3.fromRGB(255, 255, 180)
ContentContainer.Parent = MainContainer

local ContentCorner = Instance.new("UICorner")
ContentCorner.CornerRadius = UDim.new(0, 8)
ContentCorner.Parent = ContentContainer

local ContentScroll = Instance.new("ScrollingFrame")
ContentScroll.Size = UDim2.new(1, 0, 1, 0)
ContentScroll.BackgroundTransparency = 1
ContentScroll.ScrollBarThickness = 5
ContentScroll.ScrollBarImageColor3 = Color3.fromRGB(180, 220, 40)
ContentScroll.CanvasSize = UDim2.new(0, 0, 2, 0)
ContentScroll.Parent = ContentContainer

local ContentLayout = Instance.new("UIListLayout")
ContentLayout.Padding = UDim.new(0, 15)
ContentLayout.Parent = ContentScroll

local tabs = {
    "üè† MAIN", "üó∫Ô∏è DUNGEON", "üåæ FARM", "üé∞ GACHA", "‚ö° STATS", 
    "üöÄ TELEPORT", "ü•ö OPEN EGG", "‚öôÔ∏è SETTINGS", "üéØ ENEMIES"
}
local tabFrames, tabButtons = {}, {}

for i, tabName in pairs(tabs) do
    local tabButton = Instance.new("TextButton")
    tabButton.Size = UDim2.new(0, 120, 1, 0)
    tabButton.BackgroundColor3 = i == 1 and Color3.fromRGB(255, 255, 40) or Color3.fromRGB(220, 255, 40)
    tabButton.Text = tabName
    tabButton.TextColor3 = Color3.fromRGB(40, 40, 20)
    tabButton.Font = Enum.Font.GothamBold
    tabButton.TextSize = 12
    tabButton.Parent = TabContainer

    local tabButtonCorner = Instance.new("UICorner")
    tabButtonCorner.CornerRadius = UDim.new(0, 6)
    tabButtonCorner.Parent = tabButton

    local contentFrame = Instance.new("ScrollingFrame")
    contentFrame.Size = UDim2.new(1, 0, 1, 0)
    contentFrame.BackgroundTransparency = 1
    contentFrame.ScrollBarThickness = 5
    contentFrame.ScrollBarImageColor3 = Color3.fromRGB(180, 220, 40)
    contentFrame.CanvasSize = UDim2.new(0, 0, 2, 0)
    contentFrame.Visible = i == 1
    contentFrame.Parent = ContentScroll

    local contentFrameLayout = Instance.new("UIListLayout")
    contentFrameLayout.Padding = UDim.new(0, 10)
    contentFrameLayout.Parent = contentFrame

    tabFrames[tabName] = contentFrame
    tabButtons[tabName] = tabButton

    SafeConnect(tabButton.MouseButton1Click, function()
        for name, frame in pairs(tabFrames) do
            frame.Visible = (name == tabName)
        end
        for name, btn in pairs(tabButtons) do
            btn.BackgroundColor3 = (name == tabName) and Color3.fromRGB(255, 255, 40) or Color3.fromRGB(220, 255, 40)
        end
    end)
end


-- -------------------------------------------------------------------
-- TAB DEFINITIONS - ADDING TOGGLES
-- -------------------------------------------------------------------

-- MAIN TAB
local mainContent = tabFrames["üè† MAIN"]
local mainStatus = Instance.new("TextLabel")
mainStatus.Size = UDim2.new(1, -20, 0, 30)
mainStatus.BackgroundTransparency = 1
mainStatus.Text = "üü° Himono Hub ƒë√£ s·∫µn s√†ng!"
mainStatus.TextColor3 = Color3.fromRGB(40,40,20)
mainStatus.Font = Enum.Font.Gotham
mainStatus.TextSize = 14
mainStatus.Parent = mainContent

local autoAttackToggle = CreateToggleSwitch(
    "Enable Auto Attack", 
    "T·ª± ƒë·ªông t·∫•n c√¥ng k·∫ª ƒë·ªãch g·∫ßn nh·∫•t", 
    false, 
    function(enabled)
        if enabled then StartLoop("AutoAttack", AutoAttackLogic, 0.3) else StopLoop("AutoAttack") end
    end
)
autoAttackToggle.Parent = mainContent

local autoFarmSelectedToggle = CreateToggleSwitch(
    "Enable Auto Farm Selected Enemies", 
    "T·ª± ƒë·ªông farm c√°c k·∫ª ƒë·ªãch ƒë√£ ch·ªçn", 
    false, 
    function(enabled)
        if enabled then StartLoop("FarmSelected", FarmSelectedLogic, 0.5) else StopLoop("FarmSelected") end
    end
)
autoFarmSelectedToggle.Parent = mainContent

local autoFarmRandomToggle = CreateToggleSwitch(
    "Enable Farm Random Enemies", 
    "T·ª± ƒë·ªông farm ng·∫´u nhi√™n", 
    false, 
    function(enabled)
        if enabled then StartLoop("FarmRandom", FarmRandomLogic, 0.5) else StopLoop("FarmRandom") end
    end
)
autoFarmRandomToggle.Parent = mainContent

local autoDropsToggle = CreateToggleSwitch(
    "Enable Auto Collect All Drops", 
    "T·ª± ƒë·ªông nh·∫∑t v·∫≠t ph·∫©m quanh b·∫°n", 
    false, 
    function(enabled)
        if enabled then StartLoop("AutoCollect", AutoCollectLogic, 1.0) else StopLoop("AutoCollect") end
    end
)
autoDropsToggle.Parent = mainContent

-- AUTO REBIRTH
local autoRebirthToggle = CreateToggleSwitch(
    "Enable Auto Rebirth", 
    "T·ª± ƒë·ªông RankUp/Rebirth khi c√≥ th·ªÉ", 
    false, 
    function(enabled)
        if enabled then StartLoop("AutoRebirth", AutoRebirthLogic, 10) -- Ki·ªÉm tra m·ªói 10 gi√¢y
        else StopLoop("AutoRebirth") end
    end
)
autoRebirthToggle.Parent = mainContent

-- DUNGEON TAB
local dungeonContent = tabFrames["üó∫Ô∏è DUNGEON"]

local autoJoinDungeonToggle = CreateToggleSwitch(
    "Enable Auto Join Dungeon Easy", 
    "T·ª± ƒë·ªông g·ª≠i y√™u c·∫ßu v√†o Dungeon Easy.", 
    false, 
    function(enabled)
        if enabled then 
            isDungeonActive = true -- K√≠ch ho·∫°t c·ªù ng·∫Øt farm map
            SaveAndStopFarmLoops() -- L∆∞u v√† d·ª´ng c√°c loop farm map
            
            StartLoop("AutoJoinDungeon", AutoJoinDungeonEasyLogic, 15) -- Th·ª≠ join m·ªói 15s
        else 
            StopLoop("AutoJoinDungeon")
            -- Gi·ªØ c·ªù isDungeonActive n·∫øu Auto Farm Dungeon v·∫´n b·∫≠t
            isDungeonActive = activeLoops["AutoFarmDungeon"] or false 
            
            if not isDungeonActive then 
                -- N·∫øu c·∫£ Join v√† Farm ƒë·ªÅu OFF, kh√¥i ph·ª•c farm map
                RestoreFarmLoops() 
            end
        end
    end
)
autoJoinDungeonToggle.Parent = dungeonContent

local autoFarmDungeonToggle = CreateToggleSwitch(
    "Enable Auto Farm Dungeon", 
    "T·ª± ƒë·ªông Teleport v√† farm qu√°i trong Dungeon.", 
    false, 
    function(enabled)
        autoDungeonFarmEnabled = enabled
        if enabled then 
            isDungeonActive = true -- K√≠ch ho·∫°t c·ªù ng·∫Øt farm map
            SaveAndStopFarmLoops() -- L∆∞u v√† d·ª´ng c√°c loop farm map
            
            StartLoop("AutoFarmDungeon", AutoFarmDungeonLogic, 0.4) -- Farm nhanh
        else 
            StopLoop("AutoFarmDungeon")
            -- Ch·ªâ t·∫Øt c·ªù isDungeonActive n·∫øu Auto Join Dungeon c≈©ng OFF
            isDungeonActive = activeLoops["AutoJoinDungeon"] or false 
            
            if not isDungeonActive then 
                 -- N·∫øu c·∫£ Join v√† Farm ƒë·ªÅu OFF, kh√¥i ph·ª•c farm map
                RestoreFarmLoops()
            end
        end
    end
)
autoFarmDungeonToggle.Parent = dungeonContent


-- FARM TAB
local farmContent = tabFrames["üåæ FARM"]
local selectEnemyBtn = CreateActionButton("Select Enemies to Farm", "Ch·ªçn k·∫ª ƒë·ªãch ƒë·ªÉ farm", function()
    local enemies = RefreshEnemiesList()
    local items = {}
    for _, enemy in ipairs(enemies) do table.insert(items, enemy.Name) end
    local combo = CreateComboBox("Enemy List", "Ch·ªçn enemy ƒë·ªÉ farm", items, function(selected)
        for _, enemy in ipairs(enemies) do
            if enemy.Name == selected then
                table.insert(selectedEnemyPositions, enemy.Position)
            end
        end
    end)
    combo.Parent = farmContent
end)
selectEnemyBtn.Parent = farmContent

local refreshBtn = CreateActionButton("Refresh Enemy List", "Tap this to refresh enemies", function()
    print("üîÑ Refreshed enemy list!")
end)
refreshBtn.Parent = farmContent

-- GACHA TAB
local gachaContent = tabFrames["üé∞ GACHA"]
local gachaTypes = {"Biju", "Sayajin", "Race", "Haki", "Fruits"}
local gachaCombo = CreateComboBox("Gacha Type", "Ch·ªçn lo·∫°i gacha ƒë·ªÉ roll", gachaTypes, function(selected)
    selectedGachaType = selected
end)
gachaCombo.Parent = gachaContent

for _, gacha in ipairs(gachaTypes) do
    local toggle = CreateToggleSwitch(
        "Enable Auto Roll " .. gacha, 
        "T·ª± ƒë·ªông roll " .. gacha, 
        false, 
        function(enabled)
            if enabled then
                StartLoop("AutoRoll"..gacha, function() StartGacha(gacha) end, 2)
            else
                StopLoop("AutoRoll"..gacha)
            end
        end
    )
    toggle.Parent = gachaContent
end

-- STATS TAB
local statsContent = tabFrames["‚ö° STATS"]
local statTypes = {"Attack", "Mastery", "Speed", "Luck"}
local statCombo = CreateComboBox("Stat Type", "Ch·ªçn lo·∫°i stat ƒë·ªÉ c·ªông", statTypes, function(selected)
    selectedStat = selected
end)
statCombo.Parent = statsContent

local distributeBtn = CreateActionButton("Distribute Stat Point", "C·ªông ƒëi·ªÉm stat ƒë√£ ch·ªçn", function()
    DistributeStat(selectedStat)
end)
distributeBtn.Parent = statsContent

-- TELEPORT TAB
local teleportContent = tabFrames["üöÄ TELEPORT"]
local zoneList = {"Zone 1", "Zone 2", "Zone 3", "Zone 4"}
local zoneCombo = CreateComboBox("Zone", "Ch·ªçn khu v·ª±c ƒë·ªÉ teleport", zoneList, function(selected)
    selectedZone = selected
end)
zoneCombo.Parent = teleportContent

local teleportBtn = CreateActionButton("Teleport", "Di chuy·ªÉn ƒë·∫øn khu v·ª±c ƒë√£ ch·ªçn", function()
    TeleportToZone(selectedZone)
end)
teleportBtn.Parent = teleportContent

-- OPEN EGG TAB
local eggContent = tabFrames["ü•ö OPEN EGG"]
local openEggBtn = CreateActionButton("Open Egg", "M·ªü egg g·∫ßn b·∫°n", function()
    AutoOpenEggLogic()
end)
openEggBtn.Parent = eggContent

local autoOpenEggToggle = CreateToggleSwitch(
    "Enable Auto Open Egg", 
    "T·ª± ƒë·ªông m·ªü egg khi g·∫ßn", 
    false, 
    function(enabled)
        autoOpenEggEnabled = enabled
        if enabled then
            StartLoop("AutoOpenEgg", AutoOpenEggLogic, 2)
        else
            StopLoop("AutoOpenEgg")
        end
    end
)
autoOpenEggToggle.Parent = eggContent

-- SETTINGS TAB
local settingsContent = tabFrames["‚öôÔ∏è SETTINGS"]
local antiAfkToggle = CreateToggleSwitch(
    "Enable Anti-AFK", 
    "Ch·ªëng kick khi AFK", 
    true, 
    function(enabled)
        if enabled then EnableAntiAFK() end
    end
)
antiAfkToggle.Parent = settingsContent

local stealthToggle = CreateToggleSwitch(
    "Enable Stealth Mode", 
    "·∫®n ho·∫°t ƒë·ªông kh·ªèi server", 
    true, 
    function(enabled)
        stealthMode = enabled
    end
)
stealthToggle.Parent = settingsContent

-- ENEMIES TAB
local enemiesContent = tabFrames["üéØ ENEMIES"]
local refreshEnemiesBtn = CreateActionButton("Refresh Enemy List", "Qu√©t l·∫°i danh s√°ch k·∫ª ƒë·ªãch", function()
    for _, child in pairs(enemiesContent:GetChildren()) do
        if child:IsA("Frame") and child ~= refreshEnemiesBtn then child:Destroy() end
    end
    local enemies = RefreshEnemiesList()
    for _, enemy in ipairs(enemies) do
        local combo = CreateComboBox("Enemy: " .. enemy.Name, "Ch·ªçn ƒë·ªÉ farm ho·∫∑c b·ªè qua", {enemy.Name, "B·ªè qua"}, function(selected)
            if selected == enemy.Name then
                table.insert(selectedEnemyPositions, enemy.Position)
            end
        end)
        combo.Parent = enemiesContent
    end
end)
refreshEnemiesBtn.Parent = enemiesContent

-- DRAG FUNCTIONALITY
local dragging, dragInput, dragStart, startPos
SafeConnect(TitleBar.InputBegan, function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = true
        dragStart = input.Position
        startPos = MainContainer.Position
    end
end)
SafeConnect(TitleBar.InputChanged, function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement then
        dragInput = input
    end
end)
SafeConnect(TitleBar.InputEnded, function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = false
    end
end)
SafeConnect(UserInputService.InputChanged, function(input)
    if input == dragInput and dragging then
        local delta = input.Position - dragStart
        MainContainer.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
    end
end)

EnableAntiAFK()

task.spawn(function()
    while true do
        for _, frame in pairs(tabFrames) do
            frame.CanvasSize = UDim2.new(0, 0, 0, frame.UIListLayout.AbsoluteContentSize.Y + 20)
        end
        TabContainer.CanvasSize = UDim2.new(0, TabListLayout.AbsoluteContentSize.X + 20, 0, 0)
        task.wait(0.5)
    end
end)


print("üü° Himono Hub v4.2 - SULFUR EDITION LOADED! (Dungeon & Rebirth ready)")
