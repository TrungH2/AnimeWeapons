-- Himono Hub v4.3 - DARK EDITION (MODERN UI / DUNGEON SYSTEM / CONFIG PROFILES) - ANTI-CHEAT OPTIMIZED
-- MODIFIED: Integrated Notification-Based Auto Join from v4.4

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local HttpService = game:GetService("HttpService")
local TweenService = game:GetService("TweenService")
local LocalPlayer = Players.LocalPlayer

-- Bi·∫øn Tr·∫°ng Th√°i C·ªët L√µi
local stealthMode = true
local safeConnections = {}
local activeLoops = {}
local selectedEnemyNames = {}
local selectedGachaType = "Biju"
local selectedZone = "Zone 1"
local selectedStat = "Mastery"
local autoOpenEggEnabled = false
local autoStatEnabled = false
local autoHatchEggEnabled = false

-- NEW: Bi·∫øn dungeon system
local selectedDungeonMode = "Easy"
local autoFarmDungeonEnabled = false
local autoJoinDungeonEnabled = false
local autoJoinRaidEnabled = false
local dungeonCompleted = false
local originalPosition = nil

-- NEW: Bi·∫øn config system
local configProfiles = {}
local selectedConfigProfile = "default"
local autoLoadProfile = ""

-- Bi·∫øn theo d√µi tr·∫°ng th√°i c√°c toggle ƒë·ªÉ l∆∞u/t·∫£i
local selectedFarmEnabled = false
local autoAttackEnabled = false
local farmRandomEnabled = false
local autoCollectEnabled = false
local stealthModeEnabled = true
local antiAFKEnabled = true

-- NEW: Bi·∫øn theo d√µi th√¥ng b√°o (T·ª™ V4.4)
local dungeonNotificationActive = false
local raidNotificationActive = false

-- Config file paths
local configFolder = "Himonohubver2/"
local configFile = configFolder .. "GameSettings.json"
local profilesFile = configFolder .. "UserProfiles.json"

-- T·∫°o folder n·∫øu ch∆∞a t·ªìn t·∫°i
if not isfolder("Himonohubver2") then
    makefolder("Himonohubver2")
end

-- Kh·ªüi t·∫°o random seed m·ªôt l·∫ßn duy nh·∫•t
local random = Random.new(tick())

-- M√†u s·∫Øc theme m·ªõi (Dark Modern)
local ColorTheme = {
    Background = Color3.fromRGB(15, 15, 20),
    Secondary = Color3.fromRGB(25, 25, 35),
    Accent = Color3.fromRGB(0, 150, 255),
    AccentHover = Color3.fromRGB(0, 170, 255),
    Text = Color3.fromRGB(240, 240, 240),
    TextSecondary = Color3.fromRGB(180, 180, 200),
    Success = Color3.fromRGB(0, 200, 100),
    Danger = Color3.fromRGB(220, 60, 60),
    Warning = Color3.fromRGB(255, 180, 0)
}

-- Safe remote fire
local function SafeFire(remote, ...)
    if stealthMode then RunService.Heartbeat:Wait() end
    remote:FireServer(...)
end

local function SafeWait()
    if not stealthMode then task.wait(); return end
    local delay = random:NextNumber(20, 50) / 100
    local start = tick()
    while tick() - start < delay do RunService.Heartbeat:Wait() end
end

local function SafeCall(func, ...)
    local success, result = pcall(func, ...)
    return success and result or nil
end

local function SafeConnect(signal, callback)
    local conn = signal:Connect(function(...)
        if stealthMode then SafeWait() end
        SafeCall(callback, ...)
    end)
    table.insert(safeConnections, conn)
    return conn
end

local function StartLoop(name, func, interval)
    if activeLoops[name] then activeLoops[name] = false; task.wait(0.1) end
    activeLoops[name] = true
    task.spawn(function()
        while activeLoops[name] do
            pcall(func)
            if interval then task.wait(interval) else RunService.Heartbeat:Wait() end
        end
    end)
end

local function StopLoop(name)
    if activeLoops[name] then activeLoops[name] = false end
end

-- NEW: H√†m ki·ªÉm tra th√¥ng b√°o tr√™n m√†n h√¨nh (T·ª™ V4.4)
local function CheckScreenNotifications()
    dungeonNotificationActive = false
    raidNotificationActive = false
    
    -- Ki·ªÉm tra t·∫•t c·∫£ GUI trong CoreGui
    local gui = game:GetService("CoreGui")
    for _, child in pairs(gui:GetDescendants()) do
        if child:IsA("TextLabel") or child:IsA("TextButton") or child:IsA("Frame") then
            local text = string.lower(tostring(child.Text or child.Name))
            -- Logic t√¨m ki·∫øm Dungeon
            if text:find("dungeon") and (text:find("open") or text:find("available") or text:find(selectedDungeonMode:lower())) then
                dungeonNotificationActive = true
            end
            -- Logic t√¨m ki·∫øm Raid
            if text:find("raid") and (text:find("open") or text:find("available")) then
                raidNotificationActive = true
            end
        end
    end
end

-- NEW: Auto Join Dungeon Logic (Notification-Based t·ª´ V4.4)
local function AutoJoinDungeonLoop()
    if autoJoinDungeonEnabled then
        CheckScreenNotifications() -- Ki·ªÉm tra th√¥ng b√°o tr∆∞·ªõc khi join
        
        if dungeonNotificationActive then
            pcall(function()
                JoinDungeon(selectedDungeonMode)
                -- T·∫Øt c·ªù t·∫°m th·ªùi ƒë·ªÉ tr√°nh spam ngay l·∫≠p t·ª©c
                dungeonNotificationActive = false
            end)
        end
    end
end

-- NEW: Auto Join Raid Logic (Notification-Based t·ª´ V4.4)
local function AutoJoinRaidLoop()
    if autoJoinRaidEnabled then
        CheckScreenNotifications() -- Ki·ªÉm tra th√¥ng b√°o tr∆∞·ªõc khi join
        
        if raidNotificationActive then
            pcall(function()
                JoinRaid()
                -- T·∫Øt c·ªù t·∫°m th·ªùi ƒë·ªÉ tr√°nh spam ngay l·∫≠p t·ª©c
                raidNotificationActive = false
            end)
        end
    end
end

local antiAFKConnection
local function EnableAntiAFK()
    if antiAFKConnection then antiAFKConnection:Disconnect() end
    antiAFKConnection = LocalPlayer.Idled:Connect(function()
        SafeCall(function()
            VirtualUser:CaptureController()
            VirtualUser:ClickButton2(Vector2.new())
        end)
    end)
end

local function DisableAntiAFK()
    if antiAFKConnection then
        antiAFKConnection:Disconnect()
        antiAFKConnection = nil
    end
end

-- SIMPLIFIED: Kh√¥ng l·ªçc NPC
local function FindEnemiesInRange(range)
    local character = LocalPlayer.Character
    if not character or not character:FindFirstChild("HumanoidRootPart") then return {} end
    local enemies = {}
    local playerPos = character.HumanoidRootPart.Position
    
    for _, obj in pairs(workspace:GetDescendants()) do
        if obj:IsA("Model") and obj:FindFirstChild("Humanoid") and obj:FindFirstChild("Head") then
            local isPlayer = false
            for _, player in pairs(Players:GetPlayers()) do
                if player.Character == obj then isPlayer = true; break end
            end
            if not isPlayer and obj.Humanoid.Health > 0 then
                local distance = (playerPos - obj.Head.Position).Magnitude
                if distance <= (range or 100) then
                    table.insert(enemies, {
                        Model = obj,
                        Name = obj.Name,
                        Position = obj.Head.Position,
                        Distance = distance,
                        Health = obj.Humanoid.Health,
                        MaxHealth = obj.Humanoid.MaxHealth
                    })
                end
            end
        end
    end
    table.sort(enemies, function(a, b) return a.Distance < b.Distance end)
    return enemies
end

-- NEW: T√¨m enemies trong dungeon
local function FindDungeonEnemies(range)
    local character = LocalPlayer.Character
    if not character or not character:FindFirstChild("HumanoidRootPart") then return {} end
    
    local enemies = {}
    local playerPos = character.HumanoidRootPart.Position
    
    local inDungeon = false
    for _, obj in pairs(workspace:GetDescendants()) do
        if (obj.Name:lower():find("dungeon") or obj.Name:lower():find("room") or obj.Name:lower():find("boss") or obj.Name:lower():find("raid")) 
           and (playerPos - obj.Position).Magnitude < 200 then
            inDungeon = true
            break
        end
    end
    
    if not inDungeon then return {} end
    
    for _, obj in pairs(workspace:GetDescendants()) do
        if obj:IsA("Model") and obj:FindFirstChild("Humanoid") and obj:FindFirstChild("Head") then
            local isPlayer = false
            for _, player in pairs(Players:GetPlayers()) do
                if player.Character == obj then isPlayer = true; break end
            end
            if not isPlayer and obj.Humanoid.Health > 0 then
                local distance = (playerPos - obj.Head.Position).Magnitude
                if distance <= (range or 100) then
                    table.insert(enemies, {
                        Model = obj,
                        Name = obj.Name,
                        Position = obj.Head.Position,
                        Distance = distance,
                        Health = obj.Humanoid.Health,
                        MaxHealth = obj.Humanoid.MaxHealth
                    })
                end
            end
        end
    end
    table.sort(enemies, function(a, b) return a.Distance < b.Distance end)
    return enemies
end

-- Group enemies by name
local function GetEnemyGroups()
    local enemies = FindEnemiesInRange(200)
    local groups = {}
    
    for _, enemy in ipairs(enemies) do
        if not groups[enemy.Name] then
            groups[enemy.Name] = {
                name = enemy.Name,
                count = 0,
                nearestDistance = math.huge
            }
        end
        
        groups[enemy.Name].count = groups[enemy.Name].count + 1
        if enemy.Distance < groups[enemy.Name].nearestDistance then
            groups[enemy.Name].nearestDistance = enemy.Distance
        end
    end
    
    return groups
end

-- Auto farm logic
local function FarmSelectedLogic()
    if #selectedEnemyNames == 0 then return end
    
    local character = LocalPlayer.Character
    if not character or not character:FindFirstChild("HumanoidRootPart") then return end
    
    local enemies = FindEnemiesInRange(200)
    local targets = {}
    
    for _, enemy in ipairs(enemies) do
        for _, selectedName in ipairs(selectedEnemyNames) do
            if enemy.Name == selectedName then
                table.insert(targets, enemy)
                break 
            end
        end
    end
    
    table.sort(targets, function(a, b) return a.Distance < b.Distance end)
    
    if #targets == 0 then return end
    
    for _, target in ipairs(targets) do
        if not activeLoops["FarmSelected"] then break end 
        
        if target.Model and target.Model:FindFirstChild("Humanoid") and target.Model.Humanoid.Health > 0 then
            local offset = Vector3.new(
                random:NextInteger(-15, 15) / 10,
                3,
                random:NextInteger(-15, 15) / 10
            )
            -- Th√™m SafeWait ƒë·ªÉ gi·∫£m t√≠nh "robot" c·ªßa Teleport
            SafeWait() 
            character.HumanoidRootPart.CFrame = CFrame.new(target.Position + offset)
            
            local remote = ReplicatedStorage:FindFirstChild("RemoteEvent") or ReplicatedStorage:FindFirstChild("Remote")
            if remote then 
                SafeFire(remote, "Attack", target.Model)
                task.wait(0.05)
                SafeFire(remote, "Attack", target.Model)
            end
        end
        task.wait(0.1) 
    end
end

-- Auto farm dungeon logic
local function FarmDungeonLogic()
    local character = LocalPlayer.Character
    if not character or not character:FindFirstChild("HumanoidRootPart") then return end
    
    if not originalPosition then
        originalPosition = character.HumanoidRootPart.Position
    end
    
    local enemies = FindDungeonEnemies(100)
    
    if #enemies > 0 then
        for _, enemy in ipairs(enemies) do
            if not activeLoops["FarmDungeon"] then break end
        
            if enemy.Model and enemy.Model:FindFirstChild("Humanoid") and enemy.Model.Humanoid.Health > 0 then
                local offset = Vector3.new(
                    random:NextInteger(-12, 12) / 10,
                    2,
                    random:NextInteger(-12, 12) / 10
                )
                -- Th√™m SafeWait ƒë·ªÉ gi·∫£m t√≠nh "robot" c·ªßa Teleport
                SafeWait() 
                character.HumanoidRootPart.CFrame = CFrame.new(enemy.Position + offset)
                
                local remote = ReplicatedStorage:FindFirstChild("RemoteEvent") or ReplicatedStorage:FindFirstChild("Remote")
                if remote then 
                    SafeFire(remote, "Attack", enemy.Model)
                    task.wait(0.05)
                    SafeFire(remote, "Attack", enemy.Model)
                end
                
                task.wait(0.1)
            end
        end
    else
        dungeonCompleted = true
        task.wait(2)
        
        if originalPosition then
            character.HumanoidRootPart.CFrame = CFrame.new(originalPosition)
            originalPosition = nil
        end
        
        StopLoop("FarmDungeon")
        autoFarmDungeonEnabled = false
        
        -- C·∫≠p nh·∫≠t tr·∫°ng th√°i toggle button
        if dungeonToggleFrame then
            UpdateToggleButton(dungeonToggleFrame, false)
        end
    end
end

-- NEW: Auto stat logic
local function AutoStatLogic()
    if autoStatEnabled then
        DistributeStat(selectedStat)
    end
end

-- NEW: Auto hatch egg logic
local function AutoHatchEggLogic()
    if autoHatchEggEnabled then
        local remote = ReplicatedStorage:FindFirstChild("Reply") and ReplicatedStorage.Reply:FindFirstChild("Reliable")
        if remote then
            local function getNil(name, class)
                for _, v in next, getnilinstances() do
                    if v.ClassName == class and v.Name == name then
                        return v
                    end
                end
            end
            
            
            local args = {
                [1] = "Gacha Multi",
                [2] = {
                    [1] = getNil("InputObject", "InputObject"),
                    [2] = 0
                }
            }
            
            SafeFire(remote, unpack(args))
        end
    end
end

-- Auto farm logic
local function AutoAttackLogic()
    local enemies = FindEnemiesInRange(50)
    if #enemies > 0 then
        local nearestEnemy = enemies[1]
        local character = LocalPlayer.Character
        
        if character and character:FindFirstChild("HumanoidRootPart") then
            local offset = Vector3.new(
                random:NextInteger(-8, 8) / 10,
                2,
                random:NextInteger(-8, 8) / 10
            )
            SafeWait() -- Th√™m SafeWait
            character.HumanoidRootPart.CFrame = CFrame.new(nearestEnemy.Position + offset)
            local remote = ReplicatedStorage:FindFirstChild("RemoteEvent") or ReplicatedStorage:FindFirstChild("Remote")
            if remote then SafeFire(remote, "Attack", nearestEnemy.Model) end
        end
    end
end

local function FarmRandomLogic()
    local enemies = FindEnemiesInRange(50)
    if #enemies > 0 then
        local randomEnemy = enemies[random:NextInteger(1, #enemies)]
        local character = LocalPlayer.Character
        if character and character:FindFirstChild("HumanoidRootPart") then
            local offset = Vector3.new(
                random:NextInteger(-8, 8) / 10,
                2,
                random:NextInteger(-8, 8) / 10
            )
            SafeWait() -- Th√™m SafeWait
            character.HumanoidRootPart.CFrame = CFrame.new(randomEnemy.Position + offset)
            local remote = ReplicatedStorage:FindFirstChild("RemoteEvent") or ReplicatedStorage:FindFirstChild("Remote")
            if remote then SafeFire(remote, "Attack", randomEnemy.Model) end
        end
    end
end

local function AutoCollectLogic()
    local character = LocalPlayer.Character
    if not character then return end
    for _, obj in pairs(workspace:GetDescendants()) do
        if obj:IsA("Part") and (obj.Name:lower():find("drop") or obj.Name:lower():find("coin") or obj.Name:lower():find("reward")) then
            local distance = (character.HumanoidRootPart.Position - obj.Position).Magnitude
            if distance < 20 then
                local remote = ReplicatedStorage:FindFirstChild("RemoteEvent") or ReplicatedStorage:FindFirstChild("Remote")
                if remote then SafeFire(remote, "Collect", obj) end
            end
        end
    end
end

-- C√°c h√†m c∆° b·∫£n
local function StartGacha(gachaType)
    local remote = ReplicatedStorage:FindFirstChild("Reply") and ReplicatedStorage.Reply:FindFirstChild("Reliable")
    if remote then
        SafeFire(remote, "Crate Roll Start", {[1]=gachaType,[2]=true})
        task.wait(1)
        SafeFire(remote, "Crate Roll Stop")
    end
end

local function TeleportToZone(zoneName)
    local remote = ReplicatedStorage:FindFirstChild("Reply") and ReplicatedStorage.Reply:FindFirstChild("Reliable")
    if remote then
        SafeFire(remote, "Zone Teleport", {[1]=zoneName})
    end
end

local function DistributeStat(statName)
    local remote = ReplicatedStorage:FindFirstChild("Reply") and ReplicatedStorage.Reply:FindFirstChild("Reliable")
    if remote then
        SafeFire(remote, "Distribute Stat Point", {[1]=statName})
    end
end

-- NEW: Join dungeon function
local function JoinDungeon(mode)
    local remote = ReplicatedStorage:FindFirstChild("Reply") and ReplicatedStorage.Reply:FindFirstChild("Reliable")
    if remote then
        local modeNumber
        if mode == "Easy" then
            modeNumber = "1"
        elseif mode == "Medium" then
            modeNumber = "2"
        elseif mode == "Hard" then
            modeNumber = "3"
        else
            modeNumber = "1"
        end
        
        local dungeonCode = "Dungeon:" .. modeNumber
        SafeFire(remote, "Join Gamemode", {[1]=dungeonCode})
        
        dungeonCompleted = false
        originalPosition = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") and LocalPlayer.Character.HumanoidRootPart.Position
        
        if autoFarmDungeonEnabled and not activeLoops["FarmDungeon"] then
            task.wait(3)
            StartLoop("FarmDungeon", FarmDungeonLogic, 0.2)
        end
    end
end

-- NEW: Join raid function
local function JoinRaid()
    local remote = ReplicatedStorage:FindFirstChild("Reply") and ReplicatedStorage.Reply:FindFirstChild("Reliable")
    if remote then
        local raidCode = "Raid:1"
        SafeFire(remote, "Join Gamemode", {[1]=raidCode})
        
        dungeonCompleted = false
        originalPosition = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") and LocalPlayer.Character.HumanoidRootPart.Position
    end
end

-- Auto Open Egg v·ªõi logic ki·ªÉm tra kho·∫£ng c√°ch
local function AutoOpenEggLogic()
    local character = LocalPlayer.Character
    if not character or not character:FindFirstChild("HumanoidRootPart") then return end
    
    for _, obj in pairs(workspace:GetDescendants()) do
        if obj:IsA("Model") and (obj.Name:lower():find("egg") or obj.Name:lower():find("crate")) then
            local distance = (character.HumanoidRootPart.Position - obj:GetPivot().Position).Magnitude
            if distance < 15 then
                local remote = ReplicatedStorage:FindFirstChild("Reply") and ReplicatedStorage.Reply:FindFirstChild("Reliable")
                if remote then
                    SafeFire(remote, "Open Star", {[1]="Egg"})
                end
                break
            end
        end
    end
end

-- NEW: Config Profiles System
local function SaveProfiles()
    local data = {
        profiles = configProfiles,
        autoLoadProfile = autoLoadProfile
    }
    local encoded = HttpService:JSONEncode(data)
    writefile(profilesFile, encoded)
end

local function LoadProfiles()
    if isfile(profilesFile) then
        local success, data = pcall(function()
            local encoded = readfile(profilesFile)
            return HttpService:JSONDecode(encoded)
        end)
        if success and data then
            configProfiles = data.profiles or {}
            autoLoadProfile = data.autoLoadProfile or ""
        end
    end
end

local function SaveConfig()
    -- L·∫•y tr·∫°ng th√°i hi·ªán t·∫°i c·ªßa c√°c loop ƒë·ªÉ l∆∞u
    local data = {
        selectedEnemyNames = selectedEnemyNames,
        selectedGachaType = selectedGachaType,
        selectedZone = selectedZone,
        selectedStat = selectedStat,
        autoOpenEggEnabled = autoOpenEggEnabled,
        autoStatEnabled = autoStatEnabled,
        autoHatchEggEnabled = autoHatchEggEnabled,
        stealthMode = stealthMode,
        
        -- Dungeon settings
        selectedDungeonMode = selectedDungeonMode,
        autoFarmDungeonEnabled = autoFarmDungeonEnabled, -- S·ª¨ D·ª§NG BI·∫æN CH·ª¶ ƒê·ªÇ L∆ØU
        autoJoinDungeonEnabled = autoJoinDungeonEnabled, -- S·ª¨ D·ª§NG BI·∫æN CH·ª¶ ƒê·ªÇ L∆ØU
        autoJoinRaidEnabled = autoJoinRaidEnabled, -- S·ª¨ D·ª§NG BI·∫æN CH·ª¶ ƒê·ªÇ L∆ØU
        
        -- Toggle states
        -- L∆ØU TR·ª∞C TI·∫æP BI·∫æN CH·ª¶ (theo phong c√°ch v4.4) ƒë·ªÉ ƒë·∫£m b·∫£o ƒë·ªìng b·ªô
        selectedFarmEnabled = selectedFarmEnabled, 
        autoAttackEnabled = autoAttackEnabled,
        farmRandomEnabled = farmRandomEnabled,
        autoCollectEnabled = autoCollectEnabled,
        stealthModeEnabled = stealthMode,
        antiAFKEnabled = antiAFKEnabled
    }
    
    configProfiles[selectedConfigProfile] = data
    SaveProfiles()
end

local function LoadConfig(profileName)
    if not profileName then profileName = selectedConfigProfile end
    
    if configProfiles[profileName] then
        local data = configProfiles[profileName]
        
        selectedEnemyNames = data.selectedEnemyNames or {}
        selectedGachaType = data.selectedGachaType or "Biju"
        selectedZone = data.selectedZone or "Zone 1"
        selectedStat = data.selectedStat or "Mastery"
        autoOpenEggEnabled = data.autoOpenEggEnabled or false
        autoStatEnabled = data.autoStatEnabled or false
        autoHatchEggEnabled = data.autoHatchEggEnabled or false
        stealthMode = data.stealthMode or true
        
        -- Dungeon settings
        selectedDungeonMode = data.selectedDungeonMode or "Easy"
        autoFarmDungeonEnabled = data.autoFarmDungeonEnabled or false
        autoJoinDungeonEnabled = data.autoJoinDungeonEnabled or false
        autoJoinRaidEnabled = data.autoJoinRaidEnabled or false
        
        -- Toggle states
        selectedFarmEnabled = data.selectedFarmEnabled or false
        autoAttackEnabled = data.autoAttackEnabled or false
        farmRandomEnabled = data.farmRandomEnabled or false
        autoCollectEnabled = data.autoCollectEnabled or false
        stealthModeEnabled = data.stealthModeEnabled or true
        antiAFKEnabled = data.antiAFKEnabled or true
        
        return true
    end
    return false
end

local function DeleteConfig(profileName)
    if not profileName then profileName = selectedConfigProfile end
    
    if configProfiles[profileName] then
        configProfiles[profileName] = nil
        
        if autoLoadProfile == profileName then
            autoLoadProfile = ""
        end
        
        SaveProfiles()
        return true
    end
    return false
end

local function CreateNewProfile(profileName)
    if not profileName or profileName == "" then return false end
    
    if not configProfiles[profileName] then
        configProfiles[profileName] = {
            selectedEnemyNames = {},
            selectedGachaType = "Biju",
            selectedZone = "Zone 1",
            selectedStat = "Mastery",
            autoOpenEggEnabled = false,
            autoStatEnabled = false,
            autoHatchEggEnabled = false,
            stealthMode = true,
            selectedDungeonMode = "Easy",
            autoFarmDungeonEnabled = false,
            autoJoinDungeonEnabled = false,
            autoJoinRaidEnabled = false,
            selectedFarmEnabled = false,
            autoAttackEnabled = false,
            farmRandomEnabled = false,
            autoCollectEnabled = false,
            stealthModeEnabled = true,
            antiAFKEnabled = true
        }
        
        SaveProfiles()
        return true
    end
    return false
end

local function SetAutoLoadProfile(profileName)
    if configProfiles[profileName] then
        autoLoadProfile = profileName
        SaveProfiles()
        return true
    end
    return false
end

-- GUI Initialization v·ªõi theme m·ªõi (Gi·ªØ nguy√™n v4.3 UI)
local HimonoHub = Instance.new("ScreenGui")
HimonoHub.Name = "HimonoHubDark"
HimonoHub.ResetOnSpawn = false
HimonoHub.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
HimonoHub.Parent = game.CoreGui
HimonoHub.Enabled = true

-- MINI UI (N√∫t Neo) - Dark Theme
local HimonoMini = Instance.new("ScreenGui")
HimonoMini.Name = "HimonoHubMini"
HimonoMini.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
HimonoMini.Enabled = false
HimonoMini.Parent = game.CoreGui

local MiniButton = Instance.new("TextButton")
MiniButton.Size = UDim2.new(0, 50, 0, 50)
MiniButton.Position = UDim2.new(1, -60, 0, 20)
MiniButton.BackgroundColor3 = ColorTheme.Accent
MiniButton.Text = "‚ö°"
MiniButton.TextColor3 = ColorTheme.Text
MiniButton.Font = Enum.Font.GothamBold
MiniButton.TextSize = 20
MiniButton.Parent = HimonoMini

local MiniCorner = Instance.new("UICorner")
MiniCorner.CornerRadius = UDim.new(0.3, 0)
MiniCorner.Parent = MiniButton

local MiniStroke = Instance.new("UIStroke")
MiniStroke.Color = Color3.fromRGB(100, 150, 255)
MiniStroke.Thickness = 2
MiniStroke.Parent = MiniButton

-- Hover effect cho mini button
SafeConnect(MiniButton.MouseEnter, function()
    TweenService:Create(MiniButton, TweenInfo.new(0.2), {BackgroundColor3 = ColorTheme.AccentHover}):Play()
end)

SafeConnect(MiniButton.MouseLeave, function()
    TweenService:Create(MiniButton, TweenInfo.new(0.2), {BackgroundColor3 = ColorTheme.Accent}):Play()
end)

-- H√ÄM ·∫®N/HI·ªÜN (Global Toggle)
local function ToggleUI(showMain)
    if showMain then
        HimonoHub.Enabled = true
        HimonoMini.Enabled = false
    else
        HimonoHub.Enabled = false
        HimonoMini.Enabled = true
    end
end

SafeConnect(MiniButton.MouseButton1Click, function()
    ToggleUI(true)
end)

-- T·∫°o Main Container v·ªõi theme dark
local MainContainer = Instance.new("Frame")
MainContainer.Size = UDim2.new(0, 650, 0, 600)
MainContainer.Position = UDim2.new(0.5, -325, 0.5, -300)
MainContainer.BackgroundColor3 = ColorTheme.Background
MainContainer.BorderSizePixel = 0
MainContainer.Parent = HimonoHub

local ContainerCorner = Instance.new("UICorner")
ContainerCorner.CornerRadius = UDim.new(0.03, 0)
ContainerCorner.Parent = MainContainer

local ContainerStroke = Instance.new("UIStroke")
ContainerStroke.Color = Color3.fromRGB(40, 40, 50)
ContainerStroke.Thickness = 2
ContainerStroke.Parent = MainContainer

-- Title Bar
local TitleBar = Instance.new("Frame")
TitleBar.Size = UDim2.new(1, 0, 0, 50)
TitleBar.BackgroundColor3 = ColorTheme.Secondary
TitleBar.BorderSizePixel = 0
TitleBar.Parent = MainContainer

local TitleCorner = Instance.new("UICorner")
TitleCorner.CornerRadius = UDim.new(0.03, 0)
TitleCorner.Parent = TitleBar

local Title = Instance.new("TextLabel")
Title.Size = UDim2.new(1, -100, 1, 0)
Title.BackgroundTransparency = 1
Title.Text = "‚ö° HIMONO HUB v4.3 - DARK EDITION (MODIFIED)"
Title.TextColor3 = ColorTheme.Text
Title.Font = Enum.Font.GothamBold
Title.TextSize = 16
Title.TextXAlignment = Enum.TextXAlignment.Left
Title.Position = UDim2.new(0, 15, 0, 0)
Title.Parent = TitleBar

-- Stealth Indicator
local StealthIndicator = Instance.new("Frame")
StealthIndicator.Size = UDim2.new(0, 12, 0, 12)
StealthIndicator.Position = UDim2.new(1, -90, 0.5, -6)
StealthIndicator.BackgroundColor3 = stealthMode and ColorTheme.Success or ColorTheme.Danger
StealthIndicator.Parent = TitleBar

local StealthCorner = Instance.new("UICorner")
StealthCorner.CornerRadius = UDim.new(1, 0)
StealthCorner.Parent = StealthIndicator

local StealthLabel = Instance.new("TextLabel")
StealthLabel.Size = UDim2.new(0, 80, 1, 0)
StealthLabel.Position = UDim2.new(1, -80, 0, 0)
StealthLabel.BackgroundTransparency = 1
StealthLabel.Text = stealthMode and "STEALTH: ON" or "STEALTH: OFF"
StealthLabel.TextColor3 = stealthMode and ColorTheme.Success or ColorTheme.Danger
StealthLabel.Font = Enum.Font.Gotham
StealthLabel.TextSize = 10
StealthLabel.Parent = TitleBar

-- Hide Button
local HideButton = Instance.new("TextButton")
HideButton.Name = "HideButton"
HideButton.Size = UDim2.new(0, 30, 0, 30)
HideButton.Position = UDim2.new(1, -35, 0.5, -15)
HideButton.BackgroundColor3 = ColorTheme.Accent
HideButton.Text = "‚îÄ"
HideButton.TextColor3 = ColorTheme.Text
HideButton.Font = Enum.Font.GothamBold
HideButton.TextSize = 16
HideButton.Parent = TitleBar

local HideCorner = Instance.new("UICorner")
HideCorner.CornerRadius = UDim.new(0.2, 0)
HideCorner.Parent = HideButton

SafeConnect(HideButton.MouseButton1Click, function()
    ToggleUI(false)
end)

-- Tab Container
local TabContainer = Instance.new("ScrollingFrame")
TabContainer.Size = UDim2.new(1, -20, 0, 40)
TabContainer.Position = UDim2.new(0, 10, 0, 60)
TabContainer.BackgroundTransparency = 1
TabContainer.ScrollBarThickness = 3
TabContainer.ScrollBarImageColor3 = ColorTheme.Accent
TabContainer.CanvasSize = UDim2.new(2, 0, 0, 0)
TabContainer.Parent = MainContainer

local TabListLayout = Instance.new("UIListLayout")
TabListLayout.FillDirection = Enum.FillDirection.Horizontal
TabListLayout.Padding = UDim.new(0, 8)
TabListLayout.Parent = TabContainer

-- Content Container
local ContentContainer = Instance.new("Frame")
ContentContainer.Size = UDim2.new(1, -20, 1, -120)
ContentContainer.Position = UDim2.new(0, 10, 0, 110)
ContentContainer.BackgroundColor3 = ColorTheme.Secondary
ContentContainer.Parent = MainContainer

local ContentCorner = Instance.new("UICorner")
ContentCorner.CornerRadius = UDim.new(0.02, 0)
ContentCorner.Parent = ContentContainer

local ContentScroll = Instance.new("ScrollingFrame")
ContentScroll.Size = UDim2.new(1, 0, 1, 0)
ContentScroll.BackgroundTransparency = 1
ContentScroll.ScrollBarThickness = 5
ContentScroll.ScrollBarImageColor3 = ColorTheme.Accent
ContentScroll.CanvasSize = UDim2.new(0, 0, 2, 0)
ContentScroll.Parent = ContentContainer

local ContentLayout = Instance.new("UIListLayout")
ContentLayout.Padding = UDim.new(0, 15)
ContentLayout.Parent = ContentScroll

-- Tabs
local tabs = {
    "üè† MAIN", "üåæ FARM", "üé∞ GACHA", "‚ö° STATS", 
    "üöÄ TELEPORT", "ü•ö OPEN EGG", "üè∞ DUNGEON", "üíæ CONFIG", "‚öôÔ∏è SETTINGS"
}
local tabFrames, tabButtons = {}, {}

for i, tabName in pairs(tabs) do
    local tabButton = Instance.new("TextButton")
    tabButton.Size = UDim2.new(0, 120, 1, 0)
    tabButton.BackgroundColor3 = i == 1 and ColorTheme.Accent or Color3.fromRGB(40, 40, 50)
    tabButton.Text = tabName
    tabButton.TextColor3 = ColorTheme.Text
    tabButton.Font = Enum.Font.GothamBold
    tabButton.TextSize = 12
    tabButton.Parent = TabContainer

    local tabButtonCorner = Instance.new("UICorner")
    tabButtonCorner.CornerRadius = UDim.new(0.1, 0)
    tabButtonCorner.Parent = tabButton

    local contentFrame = Instance.new("ScrollingFrame")
    contentFrame.Size = UDim2.new(1, 0, 1, 0)
    contentFrame.BackgroundTransparency = 1
    contentFrame.ScrollBarThickness = 5
    contentFrame.ScrollBarImageColor3 = ColorTheme.Accent
    contentFrame.CanvasSize = UDim2.new(0, 0, 2, 0)
    contentFrame.Visible = i == 1
    contentFrame.Parent = ContentScroll

    local contentFrameLayout = Instance.new("UIListLayout")
    contentFrameLayout.Padding = UDim.new(0, 10)
    contentFrameLayout.Parent = contentFrame

    tabFrames[tabName] = contentFrame
    tabButtons[tabName] = tabButton

    SafeConnect(tabButton.MouseButton1Click, function()
        for name, frame in pairs(tabFrames) do
            frame.Visible = (name == tabName)
        end
        for name, btn in pairs(tabButtons) do
            btn.BackgroundColor3 = (name == tabName) and ColorTheme.Accent or Color3.fromRGB(40, 40, 50)
        end
    end)
end

-- NEW: H√†m c·∫≠p nh·∫≠t toggle button
local function UpdateToggleButton(toggleFrame, enabled)
    local toggleBtn = toggleFrame:FindFirstChildOfClass("TextButton")
    if toggleBtn then
        toggleBtn.Text = enabled and "ON" or "OFF"
        toggleBtn.BackgroundColor3 = enabled and ColorTheme.Success or ColorTheme.Danger
    end
end

function CreateToggleSwitch(text, description, default, callback)
    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(1, 0, 0, 60)
    frame.BackgroundTransparency = 1
    frame.Name = "Toggle_" .. text:gsub("%s+", "") -- T√™n frame ƒë·ªÉ d·ªÖ t√¨m ki·∫øm

    local bg = Instance.new("Frame")
    bg.Size = UDim2.new(1, 0, 0, 50)
    bg.BackgroundColor3 = Color3.fromRGB(30, 30, 40)
    bg.Parent = frame

    local bgCorner = Instance.new("UICorner")
    bgCorner.CornerRadius = UDim.new(0.1, 0)
    bgCorner.Parent = bg

    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(0.7, 0, 0.5, 0)
    label.Position = UDim2.new(0, 15, 0, 5)
    label.BackgroundTransparency = 1
    label.Text = text
    label.TextColor3 = ColorTheme.Text
    label.Font = Enum.Font.GothamBold
    label.TextSize = 14
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.Parent = frame

    local desc = Instance.new("TextLabel")
    desc.Size = UDim2.new(0.7, 0, 0.5, 0)
    desc.Position = UDim2.new(0, 15, 0.5, 0)
    desc.BackgroundTransparency = 1
    desc.Text = description
    desc.TextColor3 = ColorTheme.TextSecondary
    desc.Font = Enum.Font.Gotham
    desc.TextSize = 11
    desc.TextXAlignment = Enum.TextXAlignment.Left
    desc.Parent = frame

    
    local toggle = Instance.new("TextButton")
    toggle.Size = UDim2.new(0, 50, 0, 26)
    toggle.Position = UDim2.new(1, -65, 0.5, -13)
    toggle.BackgroundColor3 = default and ColorTheme.Success or ColorTheme.Danger
    toggle.Text = default and "ON" or "OFF"
    toggle.TextColor3 = ColorTheme.Text
    toggle.Font = Enum.Font.GothamBold
    toggle.TextSize = 12
    toggle.Parent = frame

    local toggleCorner = Instance.new("UICorner")
    toggleCorner.CornerRadius = UDim.new(0.5, 0)
    toggleCorner.Parent = toggle

    local toggled = default
    toggle.MouseButton1Click:Connect(function()
        toggled = not toggled
        UpdateToggleButton(frame, toggled)
        if callback then callback(toggled) end
    end)

    return frame
end

function CreateActionButton(text, description, callback)
    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(1, 0, 0, 60)
    frame.BackgroundTransparency = 1

    local btn = Instance.new("TextButton")
    btn.Size = UDim2.new(0.5, 0, 0, 40)
    btn.Position = UDim2.new(0, 10, 0, 10)
    btn.BackgroundColor3 = ColorTheme.Accent
    btn.Text = text
    btn.TextColor3 = ColorTheme.Text
    btn.Font = Enum.Font.GothamBold
    btn.TextSize = 13
    btn.Parent = frame

    local btnCorner = Instance.new("UICorner")
    btnCorner.CornerRadius = UDim.new(0.1, 0)
    btnCorner.Parent = btn

    local btnStroke = Instance.new("UIStroke")
    btnStroke.Color = Color3.fromRGB(100, 150, 255)
    btnStroke.Thickness = 1
    btnStroke.Parent = btn

    local desc = Instance.new("TextLabel")
    desc.Size = UDim2.new(0.5, 0, 0, 20)
    desc.Position = UDim2.new(0.5, 20, 0, 20)
    desc.BackgroundTransparency = 1
    desc.Text = description
    desc.TextColor3 = ColorTheme.TextSecondary
    desc.Font = Enum.Font.Gotham
    desc.TextSize = 11
    desc.TextXAlignment = Enum.TextXAlignment.Left
    desc.Parent = frame

    -- Hover effect
    SafeConnect(btn.MouseEnter, function()
        TweenService:Create(btn, TweenInfo.new(0.2), {BackgroundColor3 = ColorTheme.AccentHover}):Play()
    end)

    SafeConnect(btn.MouseLeave, function()
        TweenService:Create(btn, TweenInfo.new(0.2), {BackgroundColor3 = ColorTheme.Accent}):Play()
    end)

    btn.MouseButton1Click:Connect(function()
        if callback then callback() end
    end)

    return frame
end

function CreateComboBox(text, description, items, callback)
    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(1, 0, 0, 70)
    frame.BackgroundTransparency = 1

    local bg = Instance.new("Frame")
    bg.Size = UDim2.new(1, 0, 0, 60)
    bg.BackgroundColor3 = Color3.fromRGB(30, 30, 40)
    bg.Parent = frame

    local bgCorner = Instance.new("UICorner")
    bgCorner.CornerRadius = UDim.new(0.1, 0)
    bgCorner.Parent = bg

    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(0.5, 0, 0.5, 0)
    label.Position = UDim2.new(0, 15, 0, 5)
    label.BackgroundTransparency = 1
    label.Text = text
    label.TextColor3 = ColorTheme.Text
    label.Font = Enum.Font.GothamBold
    label.TextSize = 14
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.Parent = frame

    local desc = Instance.new("TextLabel")
    desc.Size = UDim2.new(0.5, 0, 0.5, 0)
    desc.Position = UDim2.new(0, 15, 0.5, 0)
    desc.BackgroundTransparency = 1
    desc.Text = description
    desc.TextColor3 = ColorTheme.TextSecondary
    
    desc.Font = Enum.Font.Gotham
    desc.TextSize = 11
    desc.TextXAlignment = Enum.TextXAlignment.Left
    desc.Parent = frame

    local dropdown = Instance.new("TextButton")
    dropdown.Size = UDim2.new(0.4, 0, 0, 35)
    dropdown.Position = UDim2.new(0.55, 0, 0.2, 0)
    dropdown.BackgroundColor3 = ColorTheme.Accent
    dropdown.Text = items[1] or "Select"
    dropdown.TextColor3 = ColorTheme.Text
    dropdown.Font = Enum.Font.GothamBold
    dropdown.TextSize = 13
    dropdown.Parent = frame

    local btnCorner = Instance.new("UICorner")
    btnCorner.CornerRadius = UDim.new(0.1, 0)
    btnCorner.Parent = dropdown

    local selected = items[1]
    local menu = nil
    
    local function CloseMenu()
        if menu then
            menu:Destroy()
            menu = nil
        end
    end
    
    dropdown.MouseButton1Click:Connect(function()
        if menu then
            CloseMenu()
            return
        end
        
        menu = Instance.new("Frame")
        menu.Size = UDim2.new(0.4, 0, 0, #items * 35)
        menu.Position = UDim2.new(0.55, 0, 0.8, 0)
        menu.BackgroundColor3 = Color3.fromRGB(40, 40, 50)
        menu.Parent = frame
        
        local menuCorner = Instance.new("UICorner")
        menuCorner.CornerRadius = UDim.new(0.1, 0)
        menuCorner.Parent = menu
        
        local menuStroke = Instance.new("UIStroke")
        menuStroke.Color = ColorTheme.Accent
        menuStroke.Thickness = 1
        menuStroke.Parent = menu
        
        for i, item in ipairs(items) do
            local itemBtn = Instance.new("TextButton")
            itemBtn.Size = UDim2.new(1, 0, 0, 35)
            itemBtn.Position = UDim2.new(0, 0, 0, (i-1)*35)
            itemBtn.BackgroundColor3 = Color3.fromRGB(50, 50, 60)
            itemBtn.Text = item
            itemBtn.TextColor3 = ColorTheme.Text
    
            itemBtn.Font = Enum.Font.Gotham
            itemBtn.TextSize = 12
            itemBtn.Parent = menu
            
            local itemCorner = Instance.new("UICorner")
            itemCorner.CornerRadius = UDim.new(0, 0)
            itemCorner.Parent = itemBtn
            
            itemBtn.MouseButton1Click:Connect(function()
                dropdown.Text = item
                selected = item
                CloseMenu()
                if callback then callback(item) end
            end)
            
            -- Hover effect
            SafeConnect(itemBtn.MouseEnter, function()
                TweenService:Create(itemBtn, TweenInfo.new(0.2), {BackgroundColor3 = Color3.fromRGB(60, 60, 70)}):Play()
            end)
            
            SafeConnect(itemBtn.MouseLeave, function()
                TweenService:Create(itemBtn, TweenInfo.new(0.2), {BackgroundColor3 = Color3.fromRGB(50, 50, 60)}):Play()
            end)
        end
    end)
    
    -- Close menu khi click outside
    SafeConnect(UserInputService.InputBegan, function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 and menu then
            local mousePos = UserInputService:GetMouseLocation()
            local menuPos = menu.AbsolutePosition
            local menuSize = menu.AbsoluteSize
            
            if mousePos.X < menuPos.X or mousePos.X > menuPos.X + menuSize.X or
               mousePos.Y < menuPos.Y or mousePos.Y > menuPos.Y + menuSize.Y then
                CloseMenu()
            end
        end
    end)

    return frame
end

-- MAIN TAB
local mainContent = tabFrames["üè† MAIN"]
local mainStatus = Instance.new("TextLabel")
mainStatus.Size = UDim2.new(1, -20, 0, 40)
mainStatus.BackgroundTransparency = 1
mainStatus.Text = "‚ö° DARK EDITION - T·∫•t c·∫£ t√≠nh nƒÉng ƒë√£ s·∫µn s√†ng!"
mainStatus.TextColor3 = ColorTheme.Text
mainStatus.Font = Enum.Font.Gotham
mainStatus.TextSize = 14
mainStatus.Parent = mainContent

-- Bi·∫øn l∆∞u c√°c toggle
local autoAttackToggleFrame, autoFarmSelectedToggleFrame, autoFarmRandomToggleFrame, autoDropsToggleFrame
local stealthToggleFrame, antiAfkToggleFrame, autoOpenEggToggleFrame, dungeonToggleFrame
local autoJoinDungeonToggleFrame, autoJoinRaidToggleFrame, autoHatchEggToggleFrame
local autoStatToggleFrame -- ƒê∆∞·ª£c ƒë·ªãnh nghƒ©a l·∫°i sau trong tab STATS

autoAttackToggleFrame = CreateToggleSwitch("Enable Auto Attack", "T·ª± ƒë·ªông t·∫•n c√¥ng k·∫ª ƒë·ªãch g·∫ßn nh·∫•t", false, function(enabled)
    autoAttackEnabled = enabled
    if enabled then StartLoop("AutoAttack", AutoAttackLogic, 0.3) else StopLoop("AutoAttack") end
end)
autoAttackToggleFrame.Parent = mainContent

autoDropsToggleFrame = CreateToggleSwitch("Enable Auto Collect All Drops", "T·ª± ƒë·ªông nh·∫∑t v·∫≠t ph·∫©m quanh b·∫°n", false, function(enabled)
    autoCollectEnabled = enabled
    if enabled then StartLoop("AutoCollect", AutoCollectLogic, 1.0) else StopLoop("AutoCollect") end
end)
autoDropsToggleFrame.Parent = mainContent

-- FARM TAB
local farmContent = tabFrames["üåæ FARM"]

autoFarmSelectedToggleFrame = CreateToggleSwitch("Enable Auto Farm Selected Enemies", "T·ª± ƒë·ªông farm T·∫§T C·∫¢ enemy c√πng t√™n (SPEED: 0.1s)", false, function(enabled)
    selectedFarmEnabled = enabled
    if enabled then StartLoop("FarmSelected", FarmSelectedLogic, 0.1) else StopLoop("FarmSelected") end
end)
autoFarmSelectedToggleFrame.Parent = farmContent

autoFarmRandomToggleFrame = CreateToggleSwitch("Enable Farm Random Enemies", "T·ª± ƒë·ªông farm ng·∫´u nhi√™n", false, function(enabled)
    farmRandomEnabled = enabled
    if enabled then StartLoop("FarmRandom", FarmRandomLogic, 0.5) else StopLoop("FarmRandom") end
end)
autoFarmRandomToggleFrame.Parent = farmContent

local refreshGroupsBtn = CreateActionButton("Refresh Enemy Groups", "Qu√©t v√† hi·ªÉn th·ªã enemy theo nh√≥m", function()
    for _, child in pairs(farmContent:GetChildren()) do
        if child:IsA("Frame") and string.find(child.Name or "", "GroupFrame") then
            child:Destroy()
        end
    end

    local enemyGroups = GetEnemyGroups()
    
    for enemyName, group in pairs(enemyGroups) do
        local groupFrame = Instance.new("Frame")
        groupFrame.Name = "GroupFrame_" .. enemyName
        groupFrame.Size = UDim2.new(1, 0, 0, 70)
        groupFrame.BackgroundColor3 = Color3.fromRGB(40, 40, 50)
        groupFrame.Parent = farmContent

        local cornerRadius = Instance.new("UICorner")
        cornerRadius.CornerRadius = UDim.new(0.1, 0)
        cornerRadius.Parent = groupFrame

        local nameLabel = Instance.new("TextLabel")
        nameLabel.Size = UDim2.new(0.6, 0, 0.5, 0)
        nameLabel.Position = UDim2.new(0, 15, 0, 5)
        nameLabel.BackgroundTransparency = 1
        nameLabel.Text = "üëπ " .. enemyName
        nameLabel.TextColor3 = ColorTheme.Text
        nameLabel.Font = Enum.Font.GothamBold
        nameLabel.TextSize = 14
        nameLabel.TextXAlignment = Enum.TextXAlignment.Left
        nameLabel.Parent = groupFrame

        local infoLabel = Instance.new("TextLabel")
        infoLabel.Size = UDim2.new(0.6, 0, 0.5, 0)
        infoLabel.Position = UDim2.new(0, 15, 0.5, 0)
        infoLabel.BackgroundTransparency = 1
        infoLabel.Text = "üìä S·ªë l∆∞·ª£ng: " .. group.count .. " | Kho·∫£ng c√°ch: " .. math.floor(group.nearestDistance) .. "m"
        infoLabel.TextColor3 = ColorTheme.TextSecondary
        infoLabel.Font = Enum.Font.Gotham
        infoLabel.TextSize = 11
        infoLabel.TextXAlignment = Enum.TextXAlignment.Left
        infoLabel.Parent = groupFrame

        local selectBtn = Instance.new("TextButton")
        selectBtn.Size = UDim2.new(0.3, 0, 0.6, 0)
        selectBtn.Position = UDim2.new(0.65, 0, 0.2, 0)
        selectBtn.BackgroundColor3 = ColorTheme.Accent
        selectBtn.Text = "üéØ CH·ªåN NH√ìM"
        selectBtn.TextColor3 = ColorTheme.Text
        selectBtn.Font = Enum.Font.GothamBold
        selectBtn.TextSize = 11
        selectBtn.Parent = groupFrame

        local selectCorner = Instance.new("UICorner")
        selectCorner.CornerRadius = UDim.new(0.1, 0)
        selectCorner.Parent = selectBtn

        local isSelected = false
        for _, selectedName in ipairs(selectedEnemyNames) do
            if selectedName == enemyName then
                isSelected = true
                break
            end
        end

        if isSelected then
            selectBtn.BackgroundColor3 = ColorTheme.Success
            selectBtn.Text = "‚úÖ ƒê√É CH·ªåN"
        end

        selectBtn.MouseButton1Click:Connect(function()
            isSelected = not isSelected
            if isSelected then
                selectBtn.BackgroundColor3 = ColorTheme.Success
                selectBtn.Text = "‚úÖ ƒê√É CH·ªåN"
                local found = false
                for _, name in ipairs(selectedEnemyNames) do
                    if name == enemyName then found = true; break end
                end
                if not found then
                    table.insert(selectedEnemyNames, enemyName)
                end
            else
                selectBtn.BackgroundColor3 = ColorTheme.Accent
                selectBtn.Text = "üéØ CH·ªåN NH√ìM"
                for i, name in ipairs(selectedEnemyNames) do
                    if name == enemyName then
                        table.remove(selectedEnemyNames, i)
                        break
                    end
                end
            end
        end)
    end
end)
refreshGroupsBtn.Parent = farmContent

local clearFarmBtn = CreateActionButton("Clear Farm List", "X√≥a danh s√°ch enemy ƒë∆∞·ª£c ch·ªçn", function()
    selectedEnemyNames = {}
    refreshGroupsBtn.MouseButton1Click:Fire()
end)
clearFarmBtn.Parent = farmContent

local showSelectedBtn = CreateActionButton("Show Selected Groups", "Hi·ªÉn th·ªã c√°c nh√≥m ƒë√£ ch·ªçn", function()
    if #selectedEnemyNames == 0 then
        mainStatus.Text = "üì≠ Ch∆∞a ch·ªçn nh√≥m enemy n√†o!"
    else
        mainStatus.Text = "üìã ƒêang farm " .. #selectedEnemyNames .. " nh√≥m: " .. table.concat(selectedEnemyNames, ", ")
    end
end)
showSelectedBtn.Parent = farmContent

-- GACHA TAB
local gachaContent = tabFrames["üé∞ GACHA"]
local gachaTypes = {"Biju", "Sayajin", "Race", "Haki", "Fruits"}
local gachaCombo = CreateComboBox("Gacha Type", "Ch·ªçn lo·∫°i gacha ƒë·ªÉ roll", gachaTypes, function(selected)
    selectedGachaType = selected
end)
gachaCombo.Parent = gachaContent

for _, gacha in ipairs(gachaTypes) do
    local toggle = CreateToggleSwitch("Enable Auto Roll " .. gacha, "T·ª± ƒë·ªông roll " .. gacha, false, function(enabled)
        -- Logic Auto Roll ƒë∆∞·ª£c c·∫£i ti·∫øn: Ch·ªâ ch·∫°y 1 loop AutoRoll cho lo·∫°i ƒë√£ ch·ªçn
        local currentLoopName = "AutoRoll"..gacha
        if enabled then
            -- D·ª´ng t·∫•t c·∫£ c√°c loop AutoRoll kh√°c
            for _, typeName in ipairs(gachaTypes) do
                 if typeName ~= gacha then StopLoop("AutoRoll"..typeName) end
            end
            selectedGachaType = gacha -- ƒê·∫£m b·∫£o lo·∫°i gacha ƒë∆∞·ª£c ch·ªçn ƒë√∫ng
            StartLoop(currentLoopName, function() StartGacha(gacha) end, 2)
        else
            StopLoop(currentLoopName)
        end
    end)
    toggle.Parent = gachaContent
end

-- STATS TAB
local statsContent = tabFrames["‚ö° STATS"]
local statTypes = {"Mastery", "Attack", "Speed", "Luck"}
local statCombo = CreateComboBox("Stat Type", "Ch·ªçn lo·∫°i stat ƒë·ªÉ c·ªông", statTypes, function(selected)
    selectedStat = selected
end)
statCombo.Parent = statsContent

autoStatToggleFrame = CreateToggleSwitch("Enable Auto Stat", "T·ª± ƒë·ªông c·ªông ƒëi·ªÉm stat ƒë√£ ch·ªçn", false, function(enabled)
    autoStatEnabled = enabled
    if enabled then 
        StartLoop("AutoStat", AutoStatLogic, 1)
    else
        StopLoop("AutoStat")
    end
end)
autoStatToggleFrame.Parent = statsContent

local distributeBtn = CreateActionButton("Distribute Stat Point", "C·ªông ƒëi·ªÉm stat ƒë√£ ch·ªçn", function()
    DistributeStat(selectedStat)
end)
distributeBtn.Parent = statsContent

-- TELEPORT TAB
local teleportContent = tabFrames["üöÄ TELEPORT"]
local zoneList = {"Zone 1", "Zone 2", "Zone 3", "Zone 4"}
local zoneCombo = CreateComboBox("Zone", "Ch·ªçn khu v·ª±c ƒë·ªÉ teleport", zoneList, function(selected)
    selectedZone = selected
end)
zoneCombo.Parent = teleportContent

local teleportBtn = CreateActionButton("Teleport", "Di chuy·ªÉn ƒë·∫øn khu v·ª±c ƒë√£ ch·ªçn", function()
    TeleportToZone(selectedZone)
end)
teleportBtn.Parent = teleportContent

-- OPEN EGG TAB - ƒê∆†N GI·∫¢N H√ìA
local eggContent = tabFrames["ü•ö OPEN EGG"]

-- Ch·ªâ gi·ªØ l·∫°i 1 toggle duy nh·∫•t
autoHatchEggToggleFrame = CreateToggleSwitch("Enable Auto Hatch Egg", "T·ª± ƒë·ªông hatch egg li√™n t·ª•c", false, function(enabled)
    autoHatchEggEnabled = enabled
    if enabled then
        StartLoop("AutoHatchEgg", AutoHatchEggLogic, 0.5)
    else
        StopLoop("AutoHatchEgg")
    end
end)
autoHatchEggToggleFrame.Parent = eggContent

-- DUNGEON TAB
local dungeonContent = tabFrames["üè∞ DUNGEON"]

-- Dungeon Section
local dungeonSection = Instance.new("TextLabel")
dungeonSection.Size = UDim2.new(1, -20, 0, 30)
dungeonSection.BackgroundTransparency = 1
dungeonSection.Text = "üè∞ DUNGEON SETTINGS"
dungeonSection.TextColor3 = ColorTheme.Accent
dungeonSection.Font = Enum.Font.GothamBold
dungeonSection.TextSize = 16
dungeonSection.TextXAlignment = Enum.TextXAlignment.Left
dungeonSection.Parent = dungeonContent

local dungeonModeCombo = CreateComboBox("Dungeon Mode", "Ch·ªçn ch·∫ø ƒë·ªô dungeon", {"Easy", "Medium", "Hard"}, function(selected)
    selectedDungeonMode = selected
end)
dungeonModeCombo.Parent = dungeonContent

-- NEW: Auto Join Dungeon Toggle (Notification-Based t·ª´ V4.4)
autoJoinDungeonToggleFrame = CreateToggleSwitch("Auto-join Dungeon", "T·ª± ƒë·ªông join dungeon (CH·ªà KHI C√ì TH√îNG B√ÅO)", false, function(enabled)
    autoJoinDungeonEnabled = enabled
    if enabled then
        -- D√πng interval l·ªõn h∆°n ƒë·ªÉ √≠t g·ªçi CheckScreenNotifications h∆°n
        StartLoop("AutoJoinDungeon", AutoJoinDungeonLoop, 5) 
    else
        StopLoop("AutoJoinDungeon")
    end
end)
autoJoinDungeonToggleFrame.Parent = dungeonContent

local joinDungeonBtn = CreateActionButton("Join Dungeon", "Tham gia dungeon ƒë√£ ch·ªçn", function()
    JoinDungeon(selectedDungeonMode)
end)
joinDungeonBtn.Parent = dungeonContent

dungeonToggleFrame = CreateToggleSwitch("Enable Auto Farm Dungeon", "T·ª± ƒë·ªông farm dungeon + t·ª± v·ªÅ khi xong", false, function(enabled)
    autoFarmDungeonEnabled = enabled
    if enabled then
        -- N·∫øu b·∫≠t farm, t·ª± ƒë·ªông join dungeon ngay l·∫≠p t·ª©c
        JoinDungeon(selectedDungeonMode) 
    else
        StopLoop("FarmDungeon")
    end
end)
dungeonToggleFrame.Parent = dungeonContent

-- Raid Section
local raidSection = Instance.new("TextLabel")
raidSection.Size = UDim2.new(1, -20, 0, 30)
raidSection.BackgroundTransparency = 1
raidSection.Text = "‚öîÔ∏è RAID SETTINGS"
raidSection.TextColor3 = ColorTheme.Warning
raidSection.Font = Enum.Font.GothamBold
raidSection.TextSize = 16
raidSection.TextXAlignment = Enum.TextXAlignment.Left
raidSection.Parent = dungeonContent

-- NEW: Auto Join Raid Toggle (Notification-Based t·ª´ V4.4)
autoJoinRaidToggleFrame = CreateToggleSwitch("Auto-join Raid", "T·ª± ƒë·ªông join raid (CH·ªà KHI C√ì TH√îNG B√ÅO)", false, function(enabled)
    autoJoinRaidEnabled = enabled
    if enabled then
        -- D√πng interval l·ªõn h∆°n ƒë·ªÉ √≠t g·ªçi CheckScreenNotifications h∆°n
        StartLoop("AutoJoinRaid", AutoJoinRaidLoop, 5)
    else
        StopLoop("AutoJoinRaid")
    end
end)
autoJoinRaidToggleFrame.Parent = dungeonContent

local joinRaidBtn = CreateActionButton("Join Raid", "Tham gia raid", function()
    JoinRaid()
end)
joinRaidBtn.Parent = dungeonContent

local dungeonStatus = Instance.new("TextLabel")
dungeonStatus.Size = UDim2.new(1, -20, 0, 30)
dungeonStatus.BackgroundTransparency = 1
dungeonStatus.Text = "üè∞ System: Auto-join ƒë√£ s·∫µn s√†ng!"
dungeonStatus.TextColor3 = ColorTheme.Text
dungeonStatus.Font = Enum.Font.Gotham
dungeonStatus.TextSize = 12
dungeonStatus.Parent = dungeonContent

-- CONFIG TAB
local configContent = tabFrames["üíæ CONFIG"]

local profileNameInput = Instance.new("TextBox")
profileNameInput.Size = UDim2.new(0.6, 0, 0, 35)
profileNameInput.Position = UDim2.new(0, 10, 0, 10)
profileNameInput.BackgroundColor3 = Color3.fromRGB(40, 40, 50)
profileNameInput.TextColor3 = ColorTheme.Text
profileNameInput.PlaceholderText = "Nh·∫≠p t√™n profile..."
profileNameInput.PlaceholderColor3 = ColorTheme.TextSecondary
profileNameInput.Text = ""
profileNameInput.Font = Enum.Font.Gotham
profileNameInput.TextSize = 12
profileNameInput.Parent = configContent

local inputCorner = Instance.new("UICorner")
inputCorner.CornerRadius = UDim.new(0.1, 0)
inputCorner.Parent = profileNameInput

local createProfileBtn = CreateActionButton("Create New Profile", "T·∫°o profile config m·ªõi", function()
    local profileName = profileNameInput.Text
    if profileName and profileName ~= "" then
        if CreateNewProfile(profileName) then
            mainStatus.Text = "‚úÖ ƒê√£ t·∫°o profile: " .. profileName
            selectedConfigProfile = profileName
            SaveConfig()
            RefreshProfileComboBox()
            ApplyLoadedConfig()
        else
            mainStatus.Text = "‚ùå Profile ƒë√£ t·ªìn t·∫°i: " .. profileName
        end
    else
        mainStatus.Text = "‚ùå Vui l√≤ng nh·∫≠p t√™n profile!"
    end
end)
createProfileBtn.Parent = configContent

-- T·∫°o profile combo v·ªõi danh s√°ch profile hi·ªán t·∫°i
local function GetProfileNames()
    local names = {"default"}
    for name, _ in pairs(configProfiles) do
        if name ~= "default" then
            table.insert(names, name)
        end
    end
    return names
end

-- H√†m l√†m m·ªõi ComboBox profile
local function RefreshProfileComboBox()
    local profileNames = GetProfileNames()
    
    -- T√¨m v√† c·∫≠p nh·∫≠t ComboBox (H∆°i ph·ª©c t·∫°p v√¨ ph·∫£i t√¨m frame cha)
    local targetComboFrame = nil
    for _, child in pairs(configContent:GetChildren()) do
        if child:IsA("Frame") and child:FindFirstChildOfClass("TextLabel") then
            local label = child:FindFirstChildOfClass("TextLabel")
            if label and label.Text == "Select Profile" then
                targetComboFrame = child
                break
            end
        end
    end
    
    if targetComboFrame then
        local dropdown = targetComboFrame:FindFirstChildOfClass("TextButton")
        if dropdown then
            dropdown.Text = selectedConfigProfile
            -- (ƒê·ªÉ l√†m m·ªõi menu dropdown list items th√¨ c·∫ßn rebuild ComboBox, 
            -- nh∆∞ng ƒë√¢y l√† ƒë·ªß ƒë·ªÉ c·∫≠p nh·∫≠t text hi·ªÉn th·ªã)
        end
    end
end

local profileCombo = CreateComboBox("Select Profile", "Ch·ªçn profile ƒë·ªÉ qu·∫£n l√Ω", GetProfileNames(), function(selected)
    selectedConfigProfile = selected
    if LoadConfig(selectedConfigProfile) then
        ApplyLoadedConfig()
        mainStatus.Text = "üìÇ ƒê√£ t·∫£i profile: " .. selectedConfigProfile
    end
end)
profileCombo.Parent = configContent

local loadProfileBtn = CreateActionButton("Load Profile", "T·∫£i c·∫•u h√¨nh t·ª´ profile", function()
    if LoadConfig(selectedConfigProfile) then
        ApplyLoadedConfig()
        mainStatus.Text = "üìÇ ƒê√£ t·∫£i profile: " .. selectedConfigProfile
    else
        mainStatus.Text = "‚ùå Kh√¥ng th·ªÉ t·∫£i profile: " .. selectedConfigProfile
    end
end)
loadProfileBtn.Parent = configContent

local saveProfileBtn = CreateActionButton("Save to Profile", "L∆∞u c·∫•u h√¨nh v√†o profile", function()
    SaveConfig()
    mainStatus.Text = "üíæ ƒê√£ l∆∞u v√†o profile: " .. selectedConfigProfile
end)
saveProfileBtn.Parent = configContent

local deleteProfileBtn = CreateActionButton("Delete Profile", "X√≥a profile ƒë√£ ch·ªçn", function()
    if DeleteConfig(selectedConfigProfile) then
        mainStatus.Text = "üóëÔ∏è ƒê√£ x√≥a profile: " .. selectedConfigProfile
        selectedConfigProfile = "default"
        LoadConfig("default")
        ApplyLoadedConfig()
        RefreshProfileComboBox()
    else
        mainStatus.Text = "‚ùå Kh√¥ng th·ªÉ x√≥a profile: " .. selectedConfigProfile
    end
end)
deleteProfileBtn.Parent = configContent

local autoLoadBtn = CreateActionButton("Set as Auto Load", "T·ª± ƒë·ªông load profile n√†y khi kh·ªüi ƒë·ªông", function()
    if SetAutoLoadProfile(selectedConfigProfile) then
        mainStatus.Text = "üîß ƒê√£ ƒë·∫∑t auto load: " .. selectedConfigProfile
    else
        mainStatus.Text = "‚ùå Kh√¥ng th·ªÉ ƒë·∫∑t auto load: " .. selectedConfigProfile
    end
end)
autoLoadBtn.Parent = configContent

-- SETTINGS TAB
local settingsContent = tabFrames["‚öôÔ∏è SETTINGS"]
antiAfkToggleFrame = CreateToggleSwitch("Enable Anti-AFK", "Ch·ªëng kick khi AFK", true, function(enabled)
    antiAFKEnabled = enabled
    if enabled then EnableAntiAFK() else DisableAntiAFK() end
end)
antiAfkToggleFrame.Parent = settingsContent

stealthToggleFrame = CreateToggleSwitch("Enable Stealth Mode", "·∫®n ho·∫°t ƒë·ªông kh·ªèi server", true, function(enabled)
    stealthMode = enabled
    stealthModeEnabled = enabled
    StealthIndicator.BackgroundColor3 = enabled and ColorTheme.Success or ColorTheme.Danger
    StealthLabel.Text = enabled and "STEALTH: ON" or "STEALTH: OFF"
    StealthLabel.TextColor3 = enabled and ColorTheme.Success or ColorTheme.Danger
end)
stealthToggleFrame.Parent = settingsContent

-- NEW: H√†m d·ª´ng t·∫•t c·∫£ c√°c loop (ƒê·ªÇ √ÅP D·ª§NG CONFIG M·ªöI ƒê√öNG C√ÅCH)
local function StopAllLoops()
    for name, _ in pairs(activeLoops) do
        StopLoop(name)
    end
end

-- NEW: H√†m √°p d·ª•ng config ƒë√£ load
local function ApplyLoadedConfig()
    -- D·ª™NG T·∫§T C·∫¢ C√ÅC LOOP ƒêANG HO·∫†T ƒê·ªòNG TR∆Ø·ªöC
    StopAllLoops()

    -- C·∫≠p nh·∫≠t t·∫•t c·∫£ c√°c n√∫t toggle
    UpdateToggleButton(autoAttackToggleFrame, autoAttackEnabled)
    UpdateToggleButton(autoFarmSelectedToggleFrame, selectedFarmEnabled)
    UpdateToggleButton(autoFarmRandomToggleFrame, farmRandomEnabled)
    UpdateToggleButton(autoDropsToggleFrame, autoCollectEnabled)
    UpdateToggleButton(stealthToggleFrame, stealthModeEnabled)
    UpdateToggleButton(antiAfkToggleFrame, antiAFKEnabled)
    
    UpdateToggleButton(autoHatchEggToggleFrame, autoHatchEggEnabled)
    -- C·∫≠p nh·∫≠t tr·∫°ng th√°i dungeon toggle
    local dungeonFarmToggle = tabFrames["üè∞ DUNGEON"]:FindFirstChild("Toggle_EnableAutoFarmDungeon")
    if dungeonFarmToggle then UpdateToggleButton(dungeonFarmToggle, autoFarmDungeonEnabled) end
    
    local autoJoinDungeonToggle = tabFrames["üè∞ DUNGEON"]:FindFirstChild("Toggle_AutojoinDungeon")
    if autoJoinDungeonToggle then UpdateToggleButton(autoJoinDungeonToggle, autoJoinDungeonEnabled) end
    
    local autoJoinRaidToggle = tabFrames["üè∞ DUNGEON"]:FindFirstChild("Toggle_AutojoinRaid")
    if autoJoinRaidToggle then UpdateToggleButton(autoJoinRaidToggle, autoJoinRaidEnabled) end
    
    UpdateToggleButton(autoStatToggleFrame, autoStatEnabled)
    
    -- C·∫≠p nh·∫≠t stealth indicator
    StealthIndicator.BackgroundColor3 = stealthMode and ColorTheme.Success or ColorTheme.Danger
    StealthLabel.Text = stealthMode and "STEALTH: ON" or "STEALTH: OFF"
    StealthLabel.TextColor3 = stealthMode and ColorTheme.Success or ColorTheme.Danger
    
    -- K√≠ch ho·∫°t c√°c v√≤ng l·∫∑p n·∫øu c·∫ßn
    if autoAttackEnabled then StartLoop("AutoAttack", AutoAttackLogic, 0.3) end
    if selectedFarmEnabled then StartLoop("FarmSelected", FarmSelectedLogic, 0.1) end
    if farmRandomEnabled then StartLoop("FarmRandom", FarmRandomLogic, 0.5) end
    if autoCollectEnabled then StartLoop("AutoCollect", AutoCollectLogic, 1.0) end
    if autoHatchEggEnabled then StartLoop("AutoHatchEgg", AutoHatchEggLogic, 0.5) end
    if autoFarmDungeonEnabled then 
        -- N·∫øu auto farm dungeon ƒë∆∞·ª£c b·∫≠t, t·ª± ƒë·ªông join v√† kh·ªüi ƒë·ªông loop
        JoinDungeon(selectedDungeonMode) 
    end
    -- D√πng logic Notification-Based t·ª´ V4.4
    if autoJoinDungeonEnabled then StartLoop("AutoJoinDungeon", AutoJoinDungeonLoop, 5) end
    if autoJoinRaidEnabled then StartLoop("AutoJoinRaid", AutoJoinRaidLoop, 5) end
    if autoStatEnabled then StartLoop("AutoStat", AutoStatLogic, 1) end
    if antiAFKEnabled then EnableAntiAFK() else DisableAntiAFK() end
    
    -- Refresh farm display n·∫øu ƒëang ·ªü tab FARM
    if tabFrames["üåæ FARM"].Visible then
        refreshGroupsBtn.MouseButton1Click:Fire()
    end
    
    -- C·∫≠p nh·∫≠t danh s√°ch profile
    RefreshProfileComboBox()
end

-- DRAG FUNCTIONALITY
local dragging, dragInput, dragStart, startPos
SafeConnect(TitleBar.InputBegan, function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = true
        dragStart = input.Position
        startPos = MainContainer.Position
    end
end)
SafeConnect(TitleBar.InputChanged, function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement then
        dragInput = input
    end
end)
SafeConnect(TitleBar.InputEnded, function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = false
    end
end)
SafeConnect(UserInputService.InputChanged, function(input)
    if input == dragInput and dragging then
        local delta = input.Position - dragStart
        MainContainer.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
    end
end)

-- NEW: Ph√≠m t·∫Øt Insert ƒë·ªÉ ·∫©n/hi·ªán UI
SafeConnect(UserInputService.InputBegan, function(input, gameProcessedEvent)
    if input.KeyCode == Enum.KeyCode.Insert and not gameProcessedEvent then
        ToggleUI(not HimonoHub.Enabled)
    end
end)

-- Auto-adjust canvas sizes
task.spawn(function()
    while true do
        for _, frame in pairs(tabFrames) do
            if frame.UIListLayout then
                frame.CanvasSize = UDim2.new(0, 0, 0, frame.UIListLayout.AbsoluteContentSize.Y + 20)
            end
        end
        if TabListLayout then
            TabContainer.CanvasSize = UDim2.new(0, TabListLayout.AbsoluteContentSize.X + 20, 0, 0)
        end
        task.wait(0.5)
    end
end)

-- Initialize
LoadProfiles()
if autoLoadProfile ~= "" and configProfiles[autoLoadProfile] then
    selectedConfigProfile = autoLoadProfile
    LoadConfig(autoLoadProfile)
    ApplyLoadedConfig()
    print("‚ö° AUTO-LOADED PROFILE: " .. autoLoadProfile)
else
    if not configProfiles["default"] then
        CreateNewProfile("default")
        SaveConfig()
    end
    LoadConfig("default")
    ApplyLoadedConfig()
end

print("‚ö° HIMONO HUB v4.3 - DARK EDITION (MODIFIED) LOADED!")
